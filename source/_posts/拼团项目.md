---

title: æ‹¼å›¢äº¤æ˜“ç³»ç»Ÿ-ç¬”è®°

---



> å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¾µåˆ 

## [ç¬¬1-1èŠ‚ï¼šæ‹¼å›¢éœ€æ±‚åˆ†æ](https://wx.zsxq.com/group/48411118851818/topic/2858455585418211)

åœ¨äº’è”ç½‘å…¬å¸ä¸­ï¼Œä¸€ä¸ªéœ€æ±‚é¦–å…ˆæ˜¯ä»ä¸šåŠ¡ä¾§å‘èµ·çš„ç›ˆåˆ©ç›®æ ‡ï¼Œæ‹†åˆ†ä¸ºä¸åŒçš„è¿è¥ç­–ç•¥ã€‚å†æŠŠå¯¹åº”çš„ç­–ç•¥ç”±äº§å“ç»ç†è®¾è®¡ä¸ºå¯ä»¥æ”¯æ’‘å¸‚åœºè¿è¥æ“ä½œå®Œæˆç›ˆåˆ©ç›®æ ‡çš„å…·ä½“é¡¹ç›®ã€‚æ‰€ä»¥è¿™é‡Œæœ‰ä¸€èˆ¬æœ‰3ä¸ªè§’è‰²ï¼ŒåŒ…æ‹¬ï¼›ä¸šåŠ¡äººå‘˜ã€è¿è¥äººå‘˜ã€äº§å“ç»ç†ã€‚ä»–ä»¬åˆ†åˆ«åœ¨è‡ªå·±çš„å²—ä½äº§ç”Ÿä¸åŒçš„èµ„æ–™ï¼ŒåŒ…æ‹¬ï¼›MRDã€BRDã€PRDã€‚

- å¸‚åœºéœ€æ±‚æ–‡æ¡£ï¼ˆMRDï¼‰ï¼š MRDæ˜¯ä»å¸‚åœºçš„è§’åº¦å‡ºå‘ï¼Œæè¿°ç›®æ ‡å¸‚åœºçš„éœ€æ±‚å’Œæœºä¼šã€‚å®ƒé€šå¸¸åŒ…æ‹¬ç›®æ ‡å®¢æˆ·ç¾¤ã€å¸‚åœºè¶‹åŠ¿ã€ç«äº‰åˆ†æã€å¸‚åœºæœºä¼šã€äº§å“å®šä½ä»¥åŠäº§å“åº”è¯¥å®ç°çš„å¸‚åœºç›®æ ‡ç­‰ã€‚MRDé€šå¸¸ç”±äº§å“ç»ç†æˆ–å¸‚åœºåˆ†æå¸ˆç¼–å†™ï¼Œç›®çš„æ˜¯å®šä¹‰äº§å“åº”è¯¥è§£å†³çš„å¸‚åœºé—®é¢˜å’Œæ»¡è¶³çš„ç”¨æˆ·éœ€æ±‚ã€‚
- ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ï¼ˆBRDï¼‰ï¼š BRDæ›´ä¾§é‡äºä¸šåŠ¡è§’åº¦ï¼Œæè¿°ä¸šåŠ¡ç›®æ ‡ã€ä¸šåŠ¡æµç¨‹ã€ä¸šåŠ¡è§„åˆ™ã€ä¸šåŠ¡é—®é¢˜ä»¥åŠä¸šåŠ¡éœ€æ±‚ã€‚å®ƒæ˜¯ä»ç»„ç»‡çš„ä¸šåŠ¡è§†è§’æ¥å®šä¹‰éœ€æ±‚ï¼ŒåŒ…æ‹¬ä¸šåŠ¡èƒŒæ™¯ã€ä¸šåŠ¡ç›®æ ‡ã€å½±å“åˆ†æã€é£é™©è¯„ä¼°ç­‰ã€‚BRDé€šå¸¸ç”±ä¸šåŠ¡åˆ†æå¸ˆç¼–å†™ï¼Œç›®çš„æ˜¯ç¡®ä¿é¡¹ç›®è§£å†³äº†æ­£ç¡®çš„ä¸šåŠ¡é—®é¢˜ï¼Œå¹¶ä¸å…¬å¸çš„ä¸šåŠ¡æˆ˜ç•¥ä¿æŒä¸€è‡´ã€‚
- äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰ï¼š PRDæ˜¯æ›´è¯¦ç»†çš„æ–‡æ¡£ï¼Œå®ƒæ ¹æ®MRDå’ŒBRDä¸­ç¡®å®šçš„éœ€æ±‚ï¼Œå…·ä½“æè¿°äº§å“çš„åŠŸèƒ½æ€§å’ŒéåŠŸèƒ½æ€§éœ€æ±‚ã€‚PRDåŒ…æ‹¬ç”¨æˆ·æ•…äº‹ã€ç”¨ä¾‹ã€åŠŸèƒ½åˆ—è¡¨ã€æ€§èƒ½è¦æ±‚ã€ç•Œé¢è®¾è®¡ã€ç”¨æˆ·ä½“éªŒç­‰ã€‚PRDé€šå¸¸ç”±äº§å“ç»ç†ç¼–å†™ï¼Œç›®çš„æ˜¯ä¸ºè®¾è®¡å›¢é˜Ÿå’Œå¼€å‘å›¢é˜Ÿæä¾›ä¸€ä¸ªæ˜ç¡®çš„ã€è¯¦ç»†çš„äº§å“å®ç°æŒ‡å—ã€‚

### ä¸€ã€é¡¹ç›®èƒŒæ™¯

é’ˆå¯¹ç›®å‰çš„`å°å‹æ”¯ä»˜å•†åŸç³»ç»Ÿ`ã€`OpenAIåº”ç”¨ç³»ç»Ÿ`ï¼Œå•†å“è´­ä¹°äº¤æ˜“åŒæ¯”å¢é€Ÿæ”¾ç¼“ï¼Œéœ€è¦å¼•å…¥æ–°çš„è¥é”€ç­–ç•¥ä¿ƒè¿›å•†å“äº¤æ˜“é‡ã€‚åœ¨äº¤æ˜“æ•°æ®ç»Ÿè®¡åˆ†æä¸­å¾—åˆ°ï¼Œå¸‚åœºå­˜åœ¨åŒç±»ç«å“ï¼Œå•†å“ä»·æ ¼è®¾å®šä½äºç›®å‰æˆ‘ä»¬çš„å•†å“å®šä»·ï¼Œæ‰€ä»¥ç”¨æˆ·è´­ä¹°æ„æ„¿åä½ã€‚

æ‰€ä»¥ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚ã€KOL ç­‰åŒäºæŠ–éŸ³å¤§ä¸»æ’­ç›´æ’­å–è´§ã€‘

![group-buy-market-1-1-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FmO8ALPv1tU_JPoQ0mK-BqdtRO5U.png)

å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡æœ¬é¡¹ç›®çš„å¢åŠ ï¼Œé€æ­¥å®Œå–„åŠŸèƒ½äº§å“å’Œè¿è¥æœåŠ¡ä½“ç³»ï¼Œä¼˜åŒ–æ•´ä½“çš„äº§å“æ¶æ„ï¼Œå¢å¼ºå¸‚åœºç«äº‰åŠ›ã€‚

### äºŒã€äº§å“æ–¹æ¡ˆ

å› ä¸ºæˆ‘ä»¬æ‰€å®ç°çš„æ˜¯ä¸€ä¸ªå¹³å°ç±»ç³»ç»Ÿï¼Œå¯ä»¥æ»¡è¶³å„ç±»äº¤æ˜“åœºæ™¯çš„æ‹¼å›¢éœ€æ±‚æ¥å…¥ã€‚æ‰€ä»¥åœ¨å®ç°è¿™å¥—ç³»ç»Ÿæ—¶å€™ï¼Œä¸è¦ä¸å…¶ä»–ç³»ç»Ÿè€¦åˆã€‚å¹¶æä¾›ç›¸å…³çš„ç ”å‘ä¾§å¯¹æ¥æ ‡å‡†ã€‚

æ­¤å¤–æˆ‘ä»¬è¦æä¾›å‰ç«¯æ¡ˆä¾‹å¯¹æ¥å±•ç¤ºï¼Œæ»¡è¶³åç»­å…¶ä»–ç³»ç»Ÿï¼Œå¦‚ï¼›ã€Šå°å‹æ”¯ä»˜å•†åŸã€‹ã€ã€ŠOpenAIåº”ç”¨ã€‹å¯¹æ¥æ—¶å€™æœ‰å¯å‚è€ƒæ ·ä¾‹ã€‚

#### 1. å‰ç«¯é¡µé¢

![group-buy-market-1-1-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FoJYfRBLeGazzTuNTsylkpDRZWLf.png)

- è¿›å…¥å•†å“é¡µåï¼ŒæŸ¥è¯¢æ˜¯å¦é…ç½®äº†æ‹¼å›¢æ´»åŠ¨ã€‚å¹¶è¿›è¡Œä¼˜æƒ è¯•ç®—ï¼Œæ‹¼å›¢æˆå›¢ä»·ï¼Œæœ€ä½ä¼˜æƒ å±•ç¤ºã€‚
- å‚ä¸é¦–æ¬¡æ‹¼å›¢ã€å‚ä¸æ‹¼å›¢ä¸­æ‹¼å›¢ã€‚æ‹¼å›¢å®Œæˆåˆ™ä¸åœ¨å±•ç¤ºæ­¤æ¡æ‹¼å›¢ã€‚
- æ‰€æœ‰å‚ä¸ä¸­çš„æ‹¼å›¢ç»Ÿè®¡æ‹¼å›¢äººå‘˜ã€‚

#### 2. è¿è¥ç®¡ç†

![group-buy-market-1-1-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FkYvexQf-s9VMZWssepMlzZO0ByY.png)

- æä¾›é…ç½®éœ€è¦æä¾›å¦‚å›¾æ‰€ç¤ºä¿¡æ¯ã€‚
- äººç¾¤æ ‡ç­¾ä¸ºæå‰è®¾å®šæ ‡ç­¾ç±»å‹ï¼Œäº§ç”Ÿå¯¹åº”çš„äººç¾¤æ•°æ®ã€‚

#### 3. åŠŸèƒ½æµç¨‹

![group-buy-market-1-1-04.png](./æ‹¼å›¢é¡¹ç›®.assets/FjW9-_oANsD7xG_Ek_cTjbI6e1FV.png)

- é¦–å…ˆï¼Œç”±è¿è¥é…ç½®å•†å“æ‹¼å›¢æ´»åŠ¨ï¼Œå¢åŠ æŠ˜æ‰£æ–¹å¼ã€‚å› ä¸ºæœ‰äººç¾¤æ ‡ç­¾çš„è¿‡æ»¤ï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶å“ªäº›äººå¯å‚ä¸æ‹¼å›¢ã€‚
- ä¹‹åï¼Œç”¨æˆ·å¯è§æ‹¼å›¢å•†å“å¹¶å‚ä¸æ‹¼å›¢ã€‚ç”¨æˆ·å¯è‡ªä¸»åˆ†äº«æ‹¼å›¢æˆ–è€…ç­‰å¾…æ‹¼å›¢ã€‚å› ä¸ºæ‹¼å›¢æœ‰éå¸¸å¤§çš„æŠ˜æ‰£åˆºæ¿€ç”¨æˆ·è‡ªä¸»åˆ†äº«ï¼Œä»¥æ­¤å¯ä»¥èŠ‚çœè¥é”€æ¨å¹¿è´¹ç”¨ã€‚
- æœ€åï¼Œæ‹¼å›¢å®Œæˆï¼Œè§¦è¾¾å•†å“å‘è´§ã€‚è¿™é‡Œæœ‰ä¸¤ç§ï¼Œä¸€ç§è¿è¥æ‰‹æ®µæ˜¯æ‹¼å›¢æˆå›¢ç¨€æœ‰æ€§ï¼Œå¿…é¡»æ‰“æˆæ‹¼å›¢æ‰å¯ä»¥ã€‚å¦å¤–ä¸€ç§æ˜¯è™šæ‹Ÿæ‹¼å›¢ï¼Œæ— è®ºæ˜¯å¦æ‰“æˆï¼Œåˆ°æ—¶éƒ½å®Œæˆæ‹¼å›¢ã€‚

> ä¸€èˆ¬æ—©æœŸè¿è¥ï¼Œå…ˆæŠŠå•†å“ä»·æ ¼ä¿ƒé”€å¤§å®¶ï¼Œæé«˜æ‹¼å›¢çš„ç¨€ç¼ºæ€§ã€‚è®©å¤§é‡ç”¨æˆ·çŸ¥é“æ‹¼å›¢å•†å“ï¼Œä¹‹åè°ƒæ•´ä¸ºåˆ°æœŸå³å¯æˆå›¢ï¼Œåªè¦å‚ä¸å°±èƒ½æ‹¿åˆ°å•†å“ã€‚

## [ç¬¬1-2èŠ‚ï¼šæ‹¼å›¢åº“è¡¨è®¾è®¡](https://wx.zsxq.com/group/48411118851818/topic/2858452558558551)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬1-2èŠ‚ï¼šæ‹¼å›¢åº“è¡¨è®¾è®¡-çŸ¥è¯†æ˜Ÿçƒ](https://wx.zsxq.com/group/48411118851818/topic/1525124225225222)

ç¼–ç¨‹çš„ä»£ç æ˜¯å¯¹æ•°æ®é€»è¾‘çš„å‘ˆç°ï¼Œæ•°æ®æµè½¬è°ƒåº¦çš„å¥½åæ¥è‡ªäºæ•°æ®ç»“æ„è®¾è®¡çš„æ˜¯å¦åˆç†ã€‚è€Œåº“è¡¨çš„è®¾è®¡å°±æ˜¯å¯¹ä½ è¿‡å¾€å­¦ä¹ æ•°æ®ç»“æ„çŸ¥è¯†çš„æ£€æµ‹ã€‚

åœ¨åº“è¡¨è®¾è®¡æ—¶ä½ éœ€è¦äº†è§£æ•´ä¸ªä¸šåŠ¡æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨è¿™äº›è¿‡ç¨‹ä¸­éœ€è¦å“ªäº›æ•°æ®ä½œä¸ºæ”¯æ’‘ã€‚åˆç†çš„æ•°æ®ç»“æ„çš„åº“è¡¨è®¾è®¡ï¼Œä¼šè®©ä½ çš„ç³»ç»Ÿé€»è¾‘å®ç°å®¹æ˜“è¢«äººç†è§£ã€‚åä¹‹ï¼Œä½ å¯èƒ½è¦åšå¤§é‡çš„ä»£ç å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ç®—æ³•è¿‡ç¨‹å¤æ‚åº¦ä¼šå˜å¾—å¾ˆé«˜ã€‚

è¿™å—çŸ¥è¯†çš„ç§¯ç´¯ï¼Œæœ€ä½³çš„æ‰‹æ®µå°±æ˜¯å¤šåšå®é™…çš„é¡¹ç›®ã€‚ä»åº“è¡¨è®¾è®¡åˆ°ç¼–ç å®ç°ï¼Œä»ç¼–ç å®ç°åæ¨åº“è¡¨åˆç†æ€§ã€‚åšçš„å¤šäº†ï¼Œè‡ªç„¶ä¹Ÿå°±æ‡‚äº†ã€‚

### ä¸€ã€æœ¬ç« è¯‰æ±‚

é€šè¿‡æ‹¼å›¢ä¸šåŠ¡ï¼Œè®²è§£æ‹¼å›¢æµç¨‹å®ç°ä¸­ï¼Œæ‰€éœ€çš„åº“è¡¨ç»“æ„ã€‚åŒ…æ‹¬ï¼›è¿è¥è§†è§’çš„é…ç½®è¯‰æ±‚ã€ç”¨æˆ·è§†è§’çš„ä½¿ç”¨è¯‰æ±‚ã€‚

åªè¦ä½ å¯ä»¥çœ‹æ‡‚åº“è¡¨è®¾è®¡ï¼ŒåŸºæœ¬ä½ ä¹Ÿå¯ä»¥äº†è§£æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°çš„äº†ã€‚æœ‰äº†è¿™æ ·çš„ç§¯ç´¯ï¼Œè¿›å…¥å…¬å¸æ¥è§¦æ–°çš„é¡¹ç›®æ—¶ï¼Œå¯ä»¥å…ˆä»åº“è¡¨è¿›è¡Œäº†è§£ã€‚çŸ¥é“å®ƒä»¬çš„æµè½¬å…³ç³»ï¼Œä¹‹ååœ¨çœ‹ç³»ç»Ÿè®¾è®¡å’Œä»£ç å®ç°ä¼šæ›´åŠ æ¸…æ™°ã€‚

### äºŒã€åº“è¡¨å…³ç³»

åœ¨è®¾è®¡ä¸€å¥—åº“è¡¨æ—¶ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡æµç¨‹åˆ’åˆ†å‡ºå¤§å—çš„åŠŸèƒ½åŒºï¼ŒçŸ¥é“è¿™äº›åŠŸèƒ½åŒºçš„æµè½¬å…³ç³»ã€‚

![group-buy-market-1-2-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fjt6MzAqNvP5Wol_CpdfgYC1l9Fi.png)

- é¦–å…ˆï¼Œç«™åœ¨è¿è¥çš„è§’åº¦ï¼Œè¦ä¸ºè¿™æ¬¡æ‹¼å›¢é…ç½®å¯¹åº”çš„æ‹¼å›¢æ´»åŠ¨ã€‚é‚£ä¹ˆå°±ä¼šæ¶‰åŠåˆ°ï¼›ç»™å“ªä¸ªæ¸ é“çš„ä»€ä¹ˆå•†å“IDé…ç½®æ‹¼å›¢ï¼Œè¿™æ ·ç”¨æˆ·åœ¨è¿›å…¥å•†å“é¡µå°±å¯ä»¥çœ‹åˆ°å¸¦æœ‰æ‹¼å›¢å•†å“çš„ä¿¡æ¯äº†ã€‚ä¹‹åè¦è€ƒè™‘ï¼Œè¿™ä¸ªæ‹¼å›¢çš„å•†å“æ‰€æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼›æŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚è¿˜è¦æ‹¿åˆ°æŠ˜æ‰£çš„ä¸€ä¸ªè¯•ç®—é‡‘é¢ã€‚è¿™ä¸ªè¯•ç®—å‡ºæ¥çš„é‡‘é¢ï¼Œå°±æ˜¯å‘Šè¯‰ç”¨æˆ·ï¼Œé€šè¿‡æ‹¼å›¢å¯ä»¥æ‹¿åˆ°çš„æœ€ä½ä»·æ ¼ã€‚
- ä¹‹åï¼Œç«™åœ¨ç”¨æˆ·çš„è§’åº¦ï¼Œæ˜¯å‚ä¸æ‹¼å›¢ã€‚é¦–æ¬¡å‘èµ·ä¸€ä¸ªæ‹¼å›¢ä¸å‚ä¸å·²å­˜åœ¨çš„æ‹¼å›¢è¿›è¡Œæ•°æ®çš„è®°å½•ï¼Œè¾¾æˆæ‹¼å›¢çº¦å®šæ‹¼å›¢äººæ•°åï¼Œå¼€å§‹è¿›è¡Œé€šçŸ¥ã€‚è¿™ä¸ªé€šçŸ¥çš„è®¾è®¡ç«™åœ¨å¹³å°è§’åº¦å¯ä»¥æä¾›å›è°ƒï¼Œé‚£ä¹ˆä»»ä½•çš„ç³»ç»Ÿä¹Ÿå°±éƒ½å¯ä»¥æ¥å…¥äº†ã€‚
- å¦å¤–ï¼Œä¸ºäº†æ”¯æ’‘è¿™å¥—åº“è¡¨ï¼Œä¹Ÿä¼šæœ‰äººç¾¤çš„è®¾è®¡ã€‚äººç¾¤æ˜¯äº’è”ç½‘å…¬å¸ä¸­éå¸¸å¸¸ç”¨çš„æ‰‹æ®µï¼Œæ¯”å¦‚è¦æŠŠæ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥åˆ°ä¸€ä¸ªç‰¹å®šçš„ Redis è®°å½•ä¸­ï¼Œä¹‹åå°±å¯ä»¥ä¸“é—¨ä¸ºè¿™äº›äººåšç‰¹å®šçš„æ‹¼å›¢æ´»åŠ¨äº†ã€‚
- é‚£ä¹ˆï¼Œæ‹¼å›¢æ´»åŠ¨è¡¨ï¼Œä¸ºä»€ä¹ˆä¼šæŠŠæŠ˜æ‰£æ‹†åˆ†å‡ºæ¥å‘¢ã€‚å› ä¸ºè¿™é‡Œçš„æŠ˜æ‰£å¯èƒ½æœ‰å¤šç§è¿­ä»£åˆ°ä¸€ä¸ªæ‹¼å›¢ä¸Šã€‚æ¯”å¦‚ï¼Œç»™ä¸€ä¸ªå•†å“æ·»åŠ äº†ç›´å‡10å…ƒçš„ä¼˜æƒ ï¼Œåˆå¯¹ç¬¦åˆçš„äººç¾¤idçš„ç”¨æˆ·ï¼Œé¢å¤–æ‰“9æŠ˜ï¼Œè¿™æ ·å°±æœ‰äº†2ä¸ªæŠ˜æ‰£è¿­ä»£ã€‚æ‰€ä»¥æ‹†åˆ†å‡ºæ¥ä¼šæ›´å¥½ç»´æŠ¤ã€‚è¿™æ˜¯å¯¹å¸¸å˜çš„å…ƒç´ å’Œç¨³å®šçš„å…ƒç´ è¿›è¡Œè®¾è®¡çš„æ€è€ƒã€‚

> ä½ å¯ä»¥å…ˆå°è¯•æŒ‰ç…§è¿™æ ·çš„åˆ†æè¿›è¡Œåº“è¡¨è®¾è®¡ï¼Œä¹‹ååœ¨çœ‹ä¸‹æ–‡çš„å†…å®¹ã€‚



## [ç¬¬1-3èŠ‚ï¼šç ”å‘ç³»ç»Ÿè®¾è®¡](https://wx.zsxq.com/group/48411118851818/topic/5121424458454884)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬1-3èŠ‚ï¼šç ”å‘ç³»ç»Ÿè®¾è®¡](https://articles.zsxq.com/id_olbr3cmmfslw.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

é€šè¿‡å¯¹æ‹¼å›¢éœ€æ±‚çš„ç†è§£ï¼Œè¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼›ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚å¦å¤–åƒæ˜¯åº“è¡¨è®¾è®¡å·²ç»åœ¨å‰é¢å®Œæˆäº†ï¼Œå®ƒä¹Ÿå±äºç ”å‘ç³»ç»Ÿè®¾è®¡çš„ä¸€éƒ¨åˆ†ï¼Œæå‰åšäº†è¿™éƒ¨åˆ†æ˜¯ä¸ºäº†è®©å¤§å®¶æ›´å¥½çš„ç†è§£ç³»ç»Ÿéœ€æ±‚ã€‚

### äºŒã€è®¾è®¡ç›®çš„

ä¸ºä»€ä¹ˆï¼Œä¸ä¸Šæ¥å°±å†™ä»£ç ï¼Ÿ

åœ¨15å¹´åˆšåŠ å…¥äº’è”ç½‘å¤§å‚çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸Šæ¥å°±å†™ä»£ç ã€‚äº§å“èŠå®Œéœ€æ±‚ï¼Œç ”å‘ç®€å•è®°å½•ï¼Œä¹‹åå°±æ˜¯æ‰“å¼€å·¥ç¨‹ç›´æ¥ç¼–ç äº†ã€‚éœ€æ±‚æ˜¯ä¸Šåˆå†™çš„ï¼Œä»£ç æ˜¯ä¸‹åˆå¹²çš„ã€‚è¿™æ ·å¯¹äºåˆšèµ·æ­¥é˜¶æ®µæ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œå¯ä»¥å¿«é€Ÿè¿­ä»£ã€‚

ä½†éšç€å…¬å¸çš„ä½“ç³»åŒ–è¶Šæ¥è¶Šå®Œæ•´ï¼Œä¸€ä¸ªå°é¡¹ç›®ä¹Ÿå˜æˆä¸€ä¸ªä¸ªç‹¬ç«‹ä¸šåŠ¡çº¿çš„å¤§é¡¹ç›®ï¼Œä¸€ä¸ªäººå¼€å‘ä¹Ÿå˜æˆäº†ä¸€ä¸ªå›¢é˜Ÿå¼€å‘ã€‚æ‰€æœ‰çš„ç³»ç»ŸåŠŸèƒ½çš„å®ç°ï¼Œä¸€ç‚¹ç‚¹å°é—®é¢˜ï¼Œéƒ½å¯èƒ½æ˜¯ä¸€ä¸ªä¸ªå¤§é—®é¢˜ã€‚ç”šè‡³ä¸€ä¸ªbugï¼Œä¸€ä¼šæ—¶é—´å°±ä¼šè¢«ä¼ åˆ°å¾®åšï¼Œä¹‹åå°±æ˜¯ä¸€ç‰‡çš„èˆ†æƒ…å’Œå®¢è¯‰ã€‚

æ‰€ä»¥ï¼Œåˆ°äº†ç›®å‰è¿™ä¸ªé˜¶æ®µï¼Œç ”å‘ä¸èƒ½åªæ˜¯ä¸ºäº†åŠŸèƒ½è€Œç›´æ¥å¼€å‘ã€‚è¿˜è¦éµå®ˆä¸€äº›åˆ—çš„æµç¨‹ï¼Œç¡®ä¿å¼€å‘è¿­ä»£çš„éœ€æ±‚ï¼Œéƒ½èƒ½å¹³ç¨³çš„äº¤ä»˜ã€‚æ‰€ä»¥è¦æœ‰ç ”å‘è®¾è®¡ã€è¦æœ‰è¯„å®¡ã€è¦æœ‰æµ‹è¯•ã€è¦æœ‰é¢„å‘ã€è¦æœ‰é»‘ç™½åå•éªŒè¯å’ŒåŠŸèƒ½åˆ‡é‡ã€‚

### ä¸‰ã€ä¸šåŠ¡æ¨¡å‹

æ¥ä¸‹æ¥æˆ‘ä»¬ç«™åœ¨å‰é¢å·²ç»åšçš„äº§å“éœ€æ±‚åŠŸèƒ½çš„è¯„å®¡ã€åº“è¡¨çš„è®¾è®¡ä¸‹ï¼Œåšç›¸å…³çš„ç ”å‘ç³»ç»Ÿè®¾è®¡ï¼›

![group-buy-market-1-1-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FoJYfRBLeGazzTuNTsylkpDRZWLf.png)

- å¯¹ç…§è¿™æ ·ä¸€ä¸ªé¡µé¢å›¾ï¼Œæˆ‘ä»¬æ¥åˆ†æéœ€æ±‚åšç³»ç»Ÿè®¾è®¡æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚

### å››ã€ç”¨æˆ·ç”¨ä¾‹å›¾

ç”¨ä¾‹å›¾ï¼ˆè‹±è¯­ï¼šuse case diagramï¼‰æ˜¯ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’çš„æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼Œå±•ç°äº†ç”¨æˆ·å’Œä¸ä»–ç›¸å…³çš„ç”¨ä¾‹ä¹‹é—´çš„å…³ç³»ã€‚é€šè¿‡ç”¨ä¾‹å›¾ï¼Œäººä»¬å¯ä»¥è·çŸ¥ç³»ç»Ÿä¸åŒç§ç±»çš„ç”¨æˆ·å’Œç”¨ä¾‹ã€‚ç”¨ä¾‹å›¾ä¹Ÿç»å¸¸å’Œå…¶ä»–å›¾è¡¨é…åˆä½¿ç”¨ã€‚

- ç”¨ä¾‹å›¾ï¼Œä¹Ÿå¯ä»¥ç­‰åŒäºæ˜¯ç”¨æˆ·æ•…äº‹ï¼ˆè‹±è¯­ï¼šUser storyï¼‰ï¼ˆè½¯ä»¶å¼€å‘å’Œé¡¹ç›®ç®¡ç†ä¸­çš„å¸¸ç”¨æœ¯è¯­ï¼‰ï¼Œä¸»æ—¨æ˜¯ä»¥æ—¥å¸¸è¯­è¨€æˆ–å•†åŠ¡ç”¨è¯­æ’°å†™å¥å­ï¼Œæ˜¯ä¸€æ®µç®€å•çš„åŠŸèƒ½è¡¨è¿°ã€‚ä»¥å®¢æˆ·æˆ–ä½¿ç”¨è€…çš„è§‚ç‚¹æ’°å†™ä¸‹æœ‰ä»·å€¼çš„åŠŸèƒ½ã€å¼•å¯¼ã€æ¡†æ¶æ¥ä¸ä½¿ç”¨è€…è¿›è¡Œäº’åŠ¨ï¼Œè¿›è€Œæ¨åŠ¨å·¥ä½œè¿›ç¨‹ã€‚å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç§è§„æ ¼æ–‡ä»¶ï¼Œä½†æ›´ç²¾ç¡®è€Œè¨€ï¼Œå®ƒä»£è¡¨å®¢æˆ·çš„éœ€æ±‚ä¸æ–¹å‘ã€‚ä»¥è¯¥ç”¨æˆ·æ•…äº‹æ¥ååº”å¯¹è±¡åœ¨ç»„ç»‡å†…çš„å…¶å·¥ä½œèŒè´£ã€èŒƒå›´ã€éœ€è¦è¿›è¡Œçš„ä»»åŠ¡ç­‰ã€‚ç”¨æˆ·æ•…äº‹åœ¨æ•æ·å¼€å‘æ–¹æ³•ä¸­ç”¨æ¥å®šä¹‰ç³»ç»Ÿéœ€è¦æä¾›çš„åŠŸèƒ½å’Œå®ç°éœ€æ±‚ç®¡ç†ã€‚
- å°½ç®¡ç”¨ä¾‹æœ¬èº«ä¼šæ¶‰åŠå¤§é‡ç»†èŠ‚å’Œå„ç§å¯èƒ½æ€§ï¼Œç”¨ä¾‹å›¾å´èƒ½æçº²æŒˆé¢†åœ°è®©äººäº†è§£ç³»ç»Ÿæ¦‚å†µã€‚å®ƒä¸ºâ€œç³»ç»Ÿåšä»€ä¹ˆâ€æä¾›äº†ç®€åŒ–äº†çš„å›¾å½¢è¡¨ç¤ºï¼Œå› æ­¤è¢«èª‰ä¸ºâ€œæ­å»ºç³»ç»Ÿçš„è“å›¾â€ã€‚

![group-buy-market-1-3-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FiqRn6kuxEsIZjyulED57ALjZK_7.png)

- ç«™åœ¨ç”¨æˆ·è§†è§’ï¼Œä¼šæœ‰ï¼›æŸ¥çœ‹æ‹¼å›¢å•†å“ã€å‘èµ·æ‹¼å›¢ã€å‚ä¸æ‹¼å›¢ã€æŸ¥çœ‹æ‹¼å›¢ç»“æœã€æŸ¥çœ‹å•†å“è®°å½•ã€‚
- ç«™åœ¨è¿è¥è§†è§’ï¼Œä¼šæœ‰ï¼›é…ç½®æ‹¼å›¢æ´»åŠ¨ã€é…ç½®äººç¾¤æ ‡ç­¾ã€å®¡æ ¸æ‹¼å›¢é…ç½®ã€æŸ¥çœ‹æ‹¼å›¢æµæ°´ã€‚

> è¿™æ ·çš„ç”¨ä¾‹å›¾ï¼Œå®ƒæœ‰ç‚¹é¡¹ç›®ç›®æ ‡ç»“æœé©±åŠ¨ï¼Œè®©ä½ çŸ¥é“æœ€ç»ˆçš„äº§å“å½¢æ€è¦æä¾›ä»€ä¹ˆåŠŸèƒ½ã€‚æ‰€ä»¥æœ‰è¿™æ ·çš„ä¸€ä¸ªæŒ‡å¯¼æ˜¯å¯ä»¥å¾ˆå¥½çš„å®Œæˆåç»­çš„å»ºæ¨¡è®¾è®¡çš„ã€‚

### äº”ã€å››è‰²å»ºæ¨¡å›¾

åœ¨MVCçš„ç³»ç»Ÿå¼€å‘ä¸­ï¼Œæ˜¯å¾ˆå°‘åšå»ºæ¨¡çš„äº‹æƒ…çš„ã€‚å› ä¸ºå®ƒéƒ½æ˜¯é¢å‘è¿‡ç¨‹å¼€å‘ï¼Œè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªæµç¨‹éœ€è¦ä»€ä¹ˆå°±ç¼–å†™ä»€ä¹ˆï¼Œä½†éšç€ç³»ç»Ÿçš„å¤æ‚ï¼Œä¼šé€æ­¥å‘ç°ï¼ŒAæµç¨‹ã€Bæµç¨‹ã€Cæµç¨‹ï¼Œè¶Šæ¥è¶Šå¤šçš„æµç¨‹åŠ å…¥ï¼Œä½†è¿™äº›æµç¨‹ä¸­åˆå­˜åœ¨äº†äº¤å‰ã€å¤ç”¨ã€‚ä¹Ÿå°±æ˜¯å¤§å®¶çœ‹åˆ°çš„ MVC é‡Œçš„ä»£ç ï¼Œæ€»æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œè¢«å¤åˆ¶äº†å¥½å¤šæ¬¡ï¼Œå¥½å¤šåœ°æ–¹ç¼–å†™ã€‚æ‰€ä»¥ä½¿ç”¨ DDD æ€æƒ³çš„æƒ…å†µï¼Œä¼šå¯¹è¿™äº›å†…å®¹æå‰æ€è€ƒï¼Œè¿›è¡Œå»ºæ¨¡è®¾è®¡ï¼Œåˆ’åˆ†å‡ºé¢†åŸŸã€‚è®©ä¸€ä¸ªä¸ªå•å…ƒå˜å¾—å®¹æ˜“ç®¡ç†ã€‚

MVC æœ‰ç‚¹åƒç¡å¤§è½¦åº—å­ï¼ˆå¤§é€šé“ºçš„ä¸€ä¸ªå¤§ç‚•ï¼‰ï¼ŒDDD åˆ’åˆ†äº†æ¯å®¶æ¯æˆ·ï¼Œæ¯ä¸ªåºŠğŸ›ç¡ç€è¯¥ç¡çš„äººã€‚

#### 1. å»ºæ¨¡æ–¹æ³•

DDD çš„å»ºæ¨¡è¿‡ç¨‹ï¼Œæ˜¯ä»¥ä¸€ä¸ªç”¨æˆ·ä¸ºèµ·ç‚¹ï¼Œé€šè¿‡è¡Œä¸ºå‘½ä»¤ï¼Œå‘èµ·è¡Œä¸ºåŠ¨ä½œï¼Œä¸²è”æ•´ä¸ªä¸šåŠ¡ã€‚è€Œè¿™ä¸ªç”¨æˆ·çš„èµ·ç‚¹æœ€åˆæ¥è‡ªäºç”¨ä¾‹å›¾çš„åˆ†æã€‚ç”¨ä¾‹å›¾æ˜¯ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’çš„æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼Œå±•ç°äº†ç”¨æˆ·å’Œä¸ä»–ç›¸å…³çš„ç”¨ä¾‹ä¹‹é—´çš„å…³ç³»ã€‚é€šè¿‡ç”¨ä¾‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æå‡ºæ‰€æœ‰çš„è¡Œä¸ºåŠ¨ä½œã€‚

åœ¨ DDD ä¸­ç”¨äºå®Œæˆç”¨æˆ·çš„è¡Œä¸ºå‘½ä»¤å’ŒåŠ¨ä½œåˆ†æçš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªå››è‰²å»ºæ¨¡çš„è¿‡ç¨‹ï¼Œä¹Ÿç§°ä½œé£æš´æ¨¡å‹ã€‚åœ¨ä½¿ç”¨ DDD çš„æ ‡å‡†å¯¹ç³»ç»Ÿå»ºæ¨¡å‰ï¼Œä¸€å †äººè¦å…ˆäº†è§£ DDD çš„æ“ä½œæ‰‹æ®µï¼Œè¿™æ ·æ‰èƒ½è®©äº§å“ã€ç ”å‘ã€æµ‹è¯•ã€è¿è¥ç­‰äº†è§£ä¸šåŠ¡çš„ä¼™ä¼´ï¼Œéƒ½èƒ½åœ¨åŒä¸€ä¸ªè¯­è¨€ä¸‹å®Œæˆç³»ç»Ÿå»ºæ¨¡ã€‚

![roadmap-ddd-stc-08.png](./æ‹¼å›¢é¡¹ç›®.assets/FtdpE_1wMDRmqD8ulSymec_exIun.png)

æ­¤å›¾æ˜¯æ•´ä¸ªå››è‰²å»ºæ¨¡çš„æŒ‡å¯¼å›¾ï¼Œé€šè¿‡å¯»æ‰¾é¢†åŸŸäº‹ä»¶ï¼Œå‘èµ·äº‹ä»¶å‘½ä»¤ï¼Œå®Œæˆé¢†åŸŸäº‹ä»¶çš„è¿‡ç¨‹ï¼Œå®Œæˆ DDD å·¥ç¨‹å»ºæ¨¡ã€‚

- è“è‰² - å†³ç­–å‘½ä»¤ï¼Œæ˜¯ç”¨æˆ·å‘èµ·çš„è¡Œä¸ºåŠ¨ä½œï¼Œå¦‚ï¼›å¼€å§‹ç­¾åˆ°ã€å¼€å§‹æŠ½å¥–ã€æŸ¥çœ‹é¢åº¦ç­‰ã€‚
- é»„è‰² - é¢†åŸŸäº‹ä»¶ï¼Œè¿‡å»æ—¶æ€æè¿°ã€‚å¦‚ï¼›ç­¾åˆ°å®Œæˆã€æŠ½å¥–å®Œæˆã€å¥–å“å‘æ”¾å®Œæˆã€‚å®ƒæ‰€é˜è¿°çš„éƒ½æ˜¯è¿™ä¸ªé¢†åŸŸè¦å®Œæˆçš„ç»ˆæ€ã€‚
- ç²‰è‰² - å¤–éƒ¨ç³»ç»Ÿï¼Œå¦‚ä½ çš„ç³»ç»Ÿéœ€è¦è°ƒç”¨å¤–éƒ¨çš„æ¥å£å®Œæˆæµç¨‹ã€‚
- çº¢è‰² - ä¸šåŠ¡æµç¨‹ï¼Œç”¨äºä¸²è”å†³ç­–å‘½ä»¤åˆ°é¢†åŸŸäº‹ä»¶ï¼Œæ‰€å®ç°çš„ä¸šåŠ¡æµç¨‹ã€‚ä¸€äº›ç®€å•çš„åœºæ™¯åˆ™ç›´æ¥æœ‰å†³ç­–å‘½ä»¤åˆ°é¢†åŸŸäº‹ä»¶å°±å¯ä»¥äº†ã€‚
- ç»¿è‰² - åªè¯»æ¨¡å‹ï¼Œåšä¸€äº›è¯»å–æ•°æ®çš„åŠ¨ä½œï¼Œæ²¡æœ‰å†™åº“çš„æ“ä½œã€‚
- æ£•è‰² - é¢†åŸŸå¯¹è±¡ï¼Œæ¯ä¸ªå†³ç­–å‘½ä»¤çš„å‘èµ·ï¼Œéƒ½æ˜¯å«æœ‰ä¸€ä¸ªå¯¹åº”çš„é¢†åŸŸå¯¹è±¡ã€‚

**ğŸ‘©ğŸ»â€ğŸ«æ•²é»‘æ¿** ç»¼ä¸Šï¼Œå·¦ä¸‹è§’çš„ç¤ºæ„å›¾ã€‚æ˜¯ä¸€ä¸ªç”¨æˆ·ï¼Œé€šè¿‡ä¸€ä¸ªç­–ç•¥å‘½ä»¤ï¼Œä½¿ç”¨é¢†åŸŸå¯¹è±¡ï¼Œé€šè¿‡ä¸šåŠ¡æµç¨‹ï¼Œå®Œæˆ2ä¸ªé¢†åŸŸäº‹ä»¶ï¼Œè°ƒç”¨1æ¬¡å¤–éƒ¨æ¥å£ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬åœ¨æ•´ä¸ª DDD å»ºæ¨¡è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯åœ¨å¯»æ‰¾è¿™äº›èŠ‚ç‚¹ã€‚

æ›´å¤šå…³äºå»ºæ¨¡çš„å­¦ä¹ ï¼šhttps://bugstack.cn/md/road-map/ddd-guide-02.html

#### 2. å¯»æ‰¾äº‹ä»¶

å¯»æ‰¾é¢†åŸŸäº‹ä»¶çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å¯»æ‰¾ç³»ç»Ÿä¸­æµç¨‹èŠ‚ç‚¹çš„ç»“æœæ€ã€‚ä»€ä¹ˆç»“æŸäº†ã€ä»€ä¹ˆå®Œæˆäº†ã€ä»€ä¹ˆç»ˆæ­¢ã€‚

å…¶å®è¿™æ ·çš„æ‰‹æ®µï¼Œä¹Ÿæ˜¯ä¸€ç§ç›®æ ‡ç»“æœé©±åŠ¨çš„æ‰‹æ®µï¼Œå½“æœ‰äººä¸ºä½ æŒ‡æ˜äº†ï¼Œä½ è¦å»å“ªé‡Œï¼Œä¹‹åä½ ä¼šæœ‰æ›´ç›®æ ‡æ„Ÿçš„å‰è¿›ã€‚

![group-buy-market-1-3-02.png](./æ‹¼å›¢é¡¹ç›®.assets/Fvo_ncArTG2keYDXnuPqgZQxCk7n.png)

- ç›®å‰æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€æ±‚æ‰¾åˆ°ï¼Œå¦‚å›¾ä¸­é»„è‰²éƒ¨åˆ†çš„é¢†åŸŸäº‹ä»¶ã€‚åŒ…æ‹¬ï¼›å‘èµ·æ‹¼å›¢å®Œæˆã€å‚ä¸æ‹¼å›¢å®Œæˆã€æ‹¼å›¢ç›®æ ‡è¾¾æˆã€å›è°ƒé€šçŸ¥å®Œæˆã€æ‹¼å›¢å‘è´§å®Œæˆã€äººç¾¤æ ‡ç­¾ç”Ÿæˆå®Œæˆã€æ‹¼å›¢æ´»åŠ¨åˆ›å»ºå®Œæˆã€‚

- å¦‚æœåç»­æˆ‘ä»¬åœ¨è¿­ä»£æ–°çš„åŠŸèƒ½çš„è¯ï¼Œè¿˜ä¼šå¼•å…¥å…¶ä»–é¢†åŸŸäº‹ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥æ€è€ƒï¼Œè¿˜å¯èƒ½å­˜åœ¨ä»€ä¹ˆé¢†åŸŸäº‹ä»¶ã€‚

#### 3. åˆ’åˆ†é¢†åŸŸ

é¢†åŸŸçš„åˆ’åˆ†æ˜¯åŸºäºå¯»æ‰¾é¢†åŸŸäº‹ä»¶ä¹‹åï¼Œæ‰€æœ‰çš„é¢†åŸŸäº‹ä»¶éƒ½åº”è¯¥æœ‰ä¸€ä¸ªå¯¹åº”çš„å‘èµ·æ–¹ï¼Œæˆ‘ä»¬ç®¡è¿™ä¸ªå«å†³ç­–å‘½ä»¤ã€‚æ¯”å¦‚ä½ å»è¶…æ—¶è´­ç‰©å®Œæˆï¼Œæ˜¯ä½ åª³å¦‡å‘èµ·çš„å†³ç­–å‘½ä»¤è®©ä½ å»ä¹°èƒ–ä¸œæ¥çš„0æ·»åŠ é…±æ²¹ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬è¿™é‡Œå°±è¦æ‰¾åˆ°å®Œæˆè¿™äº›é¢†åŸŸäº‹ä»¶çš„å†³ç­–å‘½ä»¤ï¼›

![group-buy-market-1-3-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FsJ-oKxJFw6zVNHmNOrK9QTuSF3k.png)

- è“è‰²ä¸ºä»¥ç”¨æˆ·ç»´åº¦çš„å†³ç­–å‘½ä»¤ï¼Œä½ å‘å‡ºçš„æ‰€æœ‰å‘½ä»¤ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ç»“æœæ€æ‰¿æ¥ã€‚

- å¦‚æœæ˜¯å¤æ‚çš„ä¸šåŠ¡ï¼Œè¦åšä¸€äº›åˆ—çš„æµç¨‹ï¼Œåˆ™ä¼šå‡ºç°ä¸€ä¸ª Business Policy ä¸šåŠ¡æµç¨‹ã€‚è¿™ä¸ªä¸šåŠ¡æµç¨‹é‡Œå¯ä»¥é€šè¿‡è®¾è®¡æ¨¡å¼æ¥å®ŒæˆåŠŸèƒ½çš„è®¾è®¡ã€‚ç»è¿‡è¿™æ ·çš„å¤„ç†ï¼Œä½ çš„ä»£ç ä¹Ÿä¼šå˜å¾—éå¸¸æ¸…æ™°ã€‚

### å…­ã€ä¸šåŠ¡æµç¨‹

ç ”å‘åŠŸèƒ½æµç¨‹è®¾è®¡æœ‰ä¸€ç²—ä¸€ç»†ï¼Œç²—çš„æ˜¯æµç¨‹å›¾ä¸ºäº†è®©å¤§å®¶å¿«é€Ÿçš„äº†è§£è¿™äº›åŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼Œæ–¹ä¾¿è®²è§£çš„æ—¶å€™ï¼Œå¯ä»¥è®©å¤šæ–¹äº†è§£ã€‚ç»†çš„æ˜¯UMLæ—¶åºå›¾ï¼Œè¿™ä¸ªä¼šæŠŠæµç¨‹ä¸­çš„ä¸ªç»†èŠ‚ä½“ç°å‡ºæ¥ï¼ŒæŒ‡å¯¼ç ”å‘åšåŠŸèƒ½å®ç°ã€‚

#### 1. æµç¨‹å›¾

![group-buy-market-241109-02.png](./æ‹¼å›¢é¡¹ç›®.assets/Fpknw6m0Z9v3ptpt4HtVL8lb1Sjp.png)

åˆ†åˆ«ä»¥ç”¨æˆ·å’Œè¿è¥è§†è§’ï¼Œäº†è§£ä¸€å¥—æ‹¼å›¢çš„é…ç½®åˆ°ç”¨æˆ·çš„å‚ä¸ã€‚

#### 2. æ—¶åºå›¾

![group-buy-market-241109-04.png](./æ‹¼å›¢é¡¹ç›®.assets/FhOSETNffCQLmCylPUYziBYwO-sZ.png)

- æ—¶åºå›¾ï¼Œå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³»ã€‚è¿™éƒ¨åˆ†ç›´æ¥çœ‹å›¾å³å¯ã€‚

### ä¸ƒã€ç³»ç»Ÿæ¶æ„

DDD æ˜¯è½¯ä»¶å¼€å‘è®¾è®¡çš„ä¸€å¥—æŒ‡å¯¼æ€æƒ³ï¼Œä½†ä¸æ˜¯ç›´æ¥å†³å®šäº†ä½ å¦‚ä½•ç¼–ç ï¼Œè€Œæ˜¯æä¾›äº†å¯¹éœ€æ±‚è®¾è®¡ä¸ºç ”å‘æä¾›ç¼–ç æŒ‡å¼•çš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼ŒDDD å»ºæ¨¡åï¼Œä½ å¯ä»¥ä½¿ç”¨3å±‚æ¶æ„ MVC å¼€å‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…­è¾¹å½¢æ¶æ„ã€æ•´æ´æ¶æ„ã€è±å½¢æ¶æ„å¼€å‘ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæœ‰äº›äººçš„ç®€å†ä¸Šï¼Œä¸“ä¸šæŠ€èƒ½æ é‡Œä¼šæœ‰ç›¸å…³æ¶æ„å†…å®¹çš„ä½“ç°ã€‚

åœ¨è¿™æ–¹é¢ï¼Œé˜¿é‡Œæœ€æ—©æ¨å‡ºçš„ cola è€ƒæ‹‰ğŸ¨æ¶æ„ï¼Œå°±æ˜¯æ•´æ´æ¶æ„çš„ä»£è¡¨ã€‚å¼ æ¯…è€å¸ˆæ¨å‡ºçš„è±å½¢æ¶æ„ï¼Œå—å‘ç½‘å…³ã€åŒ—å‘ç½‘å…³ï¼Œå±äºå…­è¾¹å½¢è¿™ä¸€ç±»çš„æ¶æ„ã€‚è¿™äº›éƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„è½åœ° DDD è¿™å¥—æŒ‡å¯¼æ€æƒ³è€Œå‡ºç°çš„æ¶æ„åˆ†å±‚è®¾è®¡ã€‚

æ‰€ä»¥ï¼ŒDDD æ˜¯æŒ‡å¯¼æ€æƒ³ï¼Œå¸®åŠ©ä½ å»ºæ¨¡è®¾è®¡ï¼Œåˆ’åˆ†é¢†åŸŸã€‚å…­è¾¹å½¢æ¶æ„ã€æ•´æ´æ¶æ„ã€è±å½¢æ¶æ„ï¼Œæ˜¯ä¸ºäº†å¸®ä½ è½åœ°çŸ¥é“æ€æƒ³åˆ°å…·ä½“ç¼–ç å®ç°ä¸Šã€‚

é‚£ä¹ˆï¼ŒMVC åˆ†å±‚æ¶æ„ä¸ä¹Ÿå¯ä»¥å¼€å‘ DDD çŸ¥é“æ€æƒ³çš„ç¼–ç å—ï¼Ÿå¯ä»¥ï¼Œä½†ç›¸å¯¹æ¥è¯´ä¸ä¼šé‚£ä¹ˆä¼˜é›…ã€‚MVC çš„å‡ºç°ï¼Œå¹¶ä¸æ˜¯åœ¨æœ‰äº†åˆ†å¸ƒå¼å¾®æœåŠ¡ä¹‹åï¼Œæ‰€ä»¥ä¸€äº›åˆ†å¸ƒå¼èµ„æºæ¨¡å—çš„æ‰¿è½½å’Œé¢†åŸŸæ€æƒ³çš„å¤„ç†ï¼Œåœ¨ MVC ä¸­éƒ½æ˜¯æ¯”è¾ƒåˆ«æ‰­çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é€‰æ‹©æ–°çš„æ¶æ„å½¢æ€å¯ä»¥æ›´å¥½çš„æ‰¿è½½ DDD æŒ‡å¯¼æ€æƒ³ã€‚

![group-buy-market-1-3-04.png](./æ‹¼å›¢é¡¹ç›®.assets/FvJSxcL6XiME54xkSBRnR_4MROAd.png)

å¦‚å›¾ï¼Œå±•ç¤ºäº†åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„é¡¹ç›®ï¼Œå„é¡¹å¼€å‘è¿‡ç¨‹ä¸­æ‰€éœ€çš„èµ„æºåœ¨ä¸¤å¥—åˆ†å±‚æ¶æ„ä¸­çš„ä½“ç°ã€‚

1. 1.

   MVC åŸºæœ¬æ˜¯æŠŠæ‰€æœ‰çš„å†…å®¹éƒ½ç”¨æœåŠ¡æ¥æ‰¿è½½ï¼Œæ— è®ºæ˜¯è‡ªèº«çš„æœåŠ¡ï¼Œè¿˜æ˜¯å¤–éƒ¨çš„æœåŠ¡ã€‚è¿™æ ·ä¼šå¯¼è‡´ç»´æŠ¤çš„æ··ä¹±ï¼Œé•¿æœŸè¿­ä»£æˆæœ¬çš„å¢åŠ ã€‚

2. 2.

   å…­è¾¹å½¢æ¶æ„ï¼Œå¯¹äºMVCçš„åŠ£åŠ¿åšäº†é’ˆå¯¹æ€§çš„æ¶æ„å¤„ç†ï¼Œåˆç†çš„åˆ’åˆ†äº†å„é¡¹èµ„æºåœ¨ä¸åŒå±‚çš„æ‰¿è½½ã€‚domain ä¹Ÿæ›´ä¸“æ³¨äºé¢†åŸŸåŠŸèƒ½çš„å®ç°ã€‚ä¹Ÿå°±æ˜¯æŠŠä»¥å‰çš„ service å†…å®¹ï¼Œåˆ’åˆ†åˆ° domain ä¸­å¤„ç†ã€‚

å…³äºæ›´å¤šçš„ DDD å·¥ç¨‹æ¨¡å‹ï¼Œå¯ä»¥ä»ç¼–ç¨‹è·¯ä¹¦ä¸­å­¦ä¹ ï¼›https://bugstack.cn/md/road-map/ddd-guide-03.html





## [ç¬¬2-1èŠ‚ï¼šåˆå§‹å·¥ç¨‹æ­å»º](https://articles.zsxq.com/id_9hqq2pxbbajr.html)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-1èŠ‚ï¼šåˆå§‹å·¥ç¨‹æ­å»º](https://articles.zsxq.com/id_9hqq2pxbbajr.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

æ•™ä¼šå°ä¼™ä¼´ä½¿ç”¨ç»Ÿä¸€æ ‡å‡†è„šæ‰‹æ¶æ–¹å¼åˆ›å»ºé¡¹ç›®å·¥ç¨‹ï¼Œå¹¶äº†è§£å·¥ç¨‹æ¨¡å—çš„åˆ†å±‚ç”¨é€”ã€‚ä»¥åŠå®Œæˆ2å¼ å…³äºæ‹¼å›¢äº’åŠ¨åº“è¡¨çš„åˆ›å»ºå’Œä½¿ç”¨ã€‚

è¯¾ç¨‹ä¼šå¾ªåºæ¸è¿›çš„ä»0åˆ°1ï¼Œé€æ­¥å¸¦ç€å¤§å®¶å®Œæˆé¡¹ç›®çš„å¼€å‘ã€‚å¼€å±€åªæœ‰ä¸€æŠŠ IntelliJ IDEAï¼Œå®Œæˆé¡¹ç›®åä½ å¯ä»¥å­¦ä¹ åˆ°ï¼›ä¸šåŠ¡ã€æ¶æ„ã€è®¾è®¡ã€æ–¹æ¡ˆã€é…ç½®ã€éƒ¨ç½²ï¼ˆLinuxã€Dockerï¼‰ç­‰å„é¡¹çŸ¥è¯†ã€‚

### äºŒã€å¦‚ä½•å¼€å§‹

ç«™åœ¨è¯»è€…è§†è§’ï¼Œè¯¥æ€ä¹ˆå­¦ä¹ å‘¢ï¼Ÿè¿™é‡Œåšä¸ªå¿…è¦è¯´æ˜å’Œå‰ç½®çš„çŸ¥è¯†æä¾›ã€‚

#### 1. å‰ç½®å­¦ä¹ 

å°ä¼™ä¼´åœ¨å­¦ä¹ çš„æ—¶å€™ï¼Œå¯ä»¥ä¾ç…§è¯¾ç¨‹çš„æ–¹å¼è¿›è¡Œåˆ›å»ºé¡¹ç›®ã€å˜æ›´é…ç½®ã€å¯åŠ¨æµ‹è¯•ã€‚è¿™é‡Œæœ‰ä¸€äº›å‰ç½®å­¦ä¹ ï¼ŒåŒ…æ‹¬ï¼šGitã€Mavenã€Dockerã€è„šæ‰‹æ¶ï¼Œè¯¾ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥åˆ·ä¸‹ï¼›

- Gitï¼šhttps://bugstack.cn/md/road-map/git.html
- Mavenï¼šhttps://bugstack.cn/md/road-map/maven.html
- Docker https://bugstack.cn/md/road-map/docker-what.html
- è„šæ‰‹æ¶ï¼šhttps://bugstack.cn/md/road-map/ddd-archetype-maven.html

å¦å¤–è¯¾ç¨‹ä¼šä½¿ç”¨ Java JDK 1.8ã€Maven 3.8.xï¼Œè½¯ä»¶å·²ç»æä¾›å¥½ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ï¼›https://t.zsxq.com/19Rnk98M0 - `é™„ä»¶å†…å«æœ‰é…ç½®å¥½é˜¿é‡Œäº‘é•œåƒçš„ Maven`

#### 2. å¼€å§‹å­¦ä¹ 

1. 1.

   ä½ éœ€è¦é€šè¿‡ git clone å‘½ä»¤ï¼Œæˆ–è€… IntelliJ IDEA è‡ªåŠ¨çš„æ£€å‡ºå·¥ç¨‹æ–¹å¼ï¼ŒæŠŠé¡¹ç›®å·¥ç¨‹æ£€å‡ºåˆ°æœ¬åœ°ã€‚å…³äºå¦‚ä½•ä½¿ç”¨Gitæ£€å‡ºé¡¹ç›®ï¼Œåœ¨å‰ç½®å­¦ä¹ é‡Œæä¾›äº†æ•™ç¨‹ã€‚

2. 2.

   æ£€å‡ºä»£ç åï¼Œä½ å¯ä»¥é€šè¿‡ IntelliJ IDEA æ‰“å¼€é¡¹ç›®ï¼Œå¹¶æŒ‰ç…§æ¯ä¸€èŠ‚æœ€å¼€å§‹è¯´æ˜çš„æœ¬èŠ‚å¯¹åº”çš„ä»£ç åˆ†æ”¯ï¼ŒæŠŠå·¥ç¨‹ä»£ç åˆ‡æ¢åˆ°å¯¹åº”çš„è¿™ä¸€èŠ‚ã€‚

3. 3.

   æ¥ä¸‹æ¥ä½ å¯ä»¥é€šè¿‡è¯¾ç¨‹çš„è§†é¢‘å’Œå°å†Œä»¥åŠæä¾›çš„ä»£ç è¿›è¡Œå­¦ä¹ ï¼Œå¹¶è·Ÿéšè¯¾ç¨‹æ¯èŠ‚è¦å®Œæˆçš„å†…å®¹ï¼Œä¸€æ­¥æ­¥æ“ä½œã€‚è¿‡ç¨‹ä¸­å¯ä»¥å‚è€ƒè¯¾ç¨‹çš„ä»£ç è¿›è¡Œå­¦ä¹ ã€‚å¦‚æœè‡ªå·±çš„ä»£ç è¿è¡Œå‡ºé—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥è¿è¡Œè¯¾ç¨‹çš„ä»£ç éªŒè¯æ˜¯ç¯å¢ƒé—®é¢˜è¿˜æ˜¯ä¸ªäººä»£ç é—®é¢˜ã€‚**å¦å¤–æ³¨æ„è¿è¡Œè¯¾ç¨‹ä»£ç ï¼Œè¦ä¿®æ”¹å¯¹åº”çš„ç¯å¢ƒä¸ºä½ çš„æœ¬åœ°ç¯å¢ƒï¼Œmysqlã€redisç­‰**

4. 4.

   å¯¹äºè¯¾ç¨‹ä¸­æ¯èŠ‚æ¶‰åŠçš„åº“è¡¨ï¼Œä¼šæ”¾åˆ°å·¥ç¨‹ docs/dev-ops mysql ä¸‹ã€‚ä½ å¯ä»¥æ¯èŠ‚å­¦ä¹ åˆ›å»ºä¸€ä¸ªæ–°çš„åº“åç§°ï¼Œä¹‹åå¯¼å…¥ã€‚ä½†è¦è®°å¾—åœ¨å·¥ç¨‹ app/application-dev.yml æ–‡ä»¶ä¸­ä¿®æ”¹å¯¹åº”çš„åº“åç§°ã€‚

#### 3. ç¯å¢ƒå®‰è£…

è¯¾ç¨‹æä¾›äº†ä½¿ç”¨ Docker éƒ¨ç½² MySQLã€Redis ç¯å¢ƒçš„è„šæœ¬ã€‚å› ä¸ºä½¿ç”¨ Docker å¯ä»¥éšæ—¶æ–¹ä¾¿å¸è½½ï¼Œä¸ä¼šæ±¡æŸ“æœ¬åœ°ç”µè„‘çš„æœ¬æœºç¯å¢ƒã€‚è€Œä¸”åç»­éƒ¨ç½² Linux äº‘æœåŠ¡å™¨ä¹Ÿä¼šéå¸¸é¡ºæ‰‹ã€‚

å…³äºç¯å¢ƒçš„å®‰è£…ï¼›

![group-buy-market-2-1-04.png](https://article-images.zsxq.com/Fgqqz36l_cBybtn81W4kQdVFedzZ)

1. 1.Windows + wsl2ï¼Œæœ¬åœ°ä½¿ç”¨ powershell åˆ‡æ¢åˆ°å·¥ç¨‹æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ `docker-compose -f docker-compose-environment-aliyun.yml up -d`
2. 2.Mac ç”µè„‘çš„é€‚é…æ€§ä¼šæ›´å¥½ï¼Œç›´æ¥ç‚¹å‡»è¿™é‡Œçš„ç»¿è‰²ç®­å¤´å³å¯å®‰è£…ã€‚
3. 3.å¦‚æœæœ¬æœºé…ç½®æœ‰é—®é¢˜ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨äº‘æœåŠ¡å™¨ã€‚è¯¾ç¨‹ä¸­æœ‰äº‘æœåŠ¡å™¨çš„æ“ä½œæ•™ç¨‹ï¼Œéƒ¨ç½²èµ·æ¥æ›´æ–¹ä¾¿ã€‚äº‘æœåŠ¡å™¨æ•™ç¨‹ï¼šhttps://bugstack.cn/md/road-map/linux.html

> ç¯å¢ƒå®‰è£…åå°±å¯ä»¥ä½¿ç”¨ MySqlã€Redis é“¾æ¥å·¥å…·ä½¿ç”¨äº†ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ›´æ–°åº“è¡¨ã€‚

### ä¸‰ã€åˆ›å»ºå·¥ç¨‹

æœ¬èŠ‚ä¼šç”¨åˆ°å°å‚…å“¥å¼€å‘å¥½çš„åœ¨çº¿ Maven è„šæ‰‹æ¶ï¼Œç”¨äºåˆ›å»ºé¡¹ç›®å·¥ç¨‹ã€‚å¦‚ä¸‹æ“ä½œå‰ï¼Œç¡®ä¿ä½ çš„ IntelliJ IDEA å·²ç»é…ç½®å¥½äº†æˆ‘æä¾›çš„å¸¦æœ‰é˜¿é‡Œäº‘é•œåƒ Mavenï¼Œå¦åˆ™æ‹‰å–è„šæ‰‹æ¶ä¼šè¶…æ—¶å¤±è´¥ã€‚å¦‚å›¾æ“ä½œã€‚

![group-buy-market-2-1-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FiEnWOPTqYgO6CcqqvkKY5MdBesZ.png)

#### 1. é…ç½®è„šæ‰‹æ¶

![road-map-maven-archetype-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fqfr0CSt_TqRfN2jYjfQkjHBxwVM.png)

- é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ª IntelliJ IDEA 2021+ ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨ç¤¾åŒºç‰ˆå³å¯ã€‚å³å…è´¹ï¼Œä¹Ÿå¤Ÿç”¨ã€‚
- ä¹‹åï¼Œå¦‚å›¾æŠŠåœ¨çº¿ç‰ˆçš„è„šæ‰‹æ¶é…ç½®åˆ° IntelliJ IDEA ä¸­ã€‚è¿™æ ·å¤§å®¶ä½¿ç”¨çš„å°±æ˜¯ç»Ÿä¸€ä¸€å¥—è„šæ‰‹æ¶äº†ã€‚é…ç½®åœ°å€ [https://gaga.plus](https://gaga.plus/)

#### 2. ä½¿ç”¨è„šæ‰‹æ¶

å¦‚å›¾ï¼Œé…ç½®åä½¿ç”¨å³å¯ã€‚

![group-buy-market-2-1-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FsYW46NhoJqppNTkAuhAJR4-yLIp.png)

![group-buy-market-2-1-03.png](./æ‹¼å›¢é¡¹ç›®.assets/Fln1Du1RpLxkLksje5EhQ0-0u68h.png)

è¿™æ ·ä½ å°±è·å¾—åˆ°äº†ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºå‡ºæ¥çš„å·¥ç¨‹ç»“æ„ã€‚å…³äºå·¥ç¨‹ç»“æ„åˆ†å±‚åœ¨å‰é¢å·²ç»ä»‹ç»ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡é“¾æ¥å­¦ä¹ è¡¥å……ã€‚https://bugstack.cn/md/road-map/ddd-guide-03.html å…³äºåˆ†å±‚å®šä¹‰å¦‚ä¸‹ï¼›

- **æ¥å£å®šä¹‰-api** ï¼šå› ä¸ºå¾®æœåŠ¡ä¸­å¼•ç”¨çš„ RPC éœ€è¦å¯¹å¤–æä¾›æ¥å£çš„æè¿°ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ–¹åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦å¼•å…¥ Jar åŒ…ï¼Œè®©è°ƒç”¨æ–¹å¥½èƒ½ä¾èµ–æ¥å£çš„å®šä¹‰åšä»£ç†ã€‚
- **åº”ç”¨å°è£…-app** ï¼šè¿™æ˜¯åº”ç”¨å¯åŠ¨å’Œé…ç½®çš„ä¸€å±‚ï¼Œå¦‚ä¸€äº› aop åˆ‡é¢æˆ–è€… config é…ç½®ï¼Œä»¥åŠæ‰“åŒ…é•œåƒéƒ½æ˜¯åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸“é—¨ä¸ºäº†å¯åŠ¨æœåŠ¡è€Œå­˜åœ¨çš„ã€‚
- **é¢†åŸŸå°è£…-domain** ï¼šé¢†åŸŸæ¨¡å‹æœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡å—ã€‚æ— è®ºæ€ä¹ˆåšDDDçš„åˆ†å±‚æ¶æ„ï¼Œdomain éƒ½æ˜¯è‚¯å®šå­˜åœ¨çš„ã€‚åœ¨ä¸€å±‚ä¸­ä¼šæœ‰ä¸€ä¸ªä¸ªç»†åˆ†çš„é¢†åŸŸæœåŠ¡ï¼Œåœ¨æ¯ä¸ªæœåŠ¡åŒ…ä¸­ä¼šæœ‰ã€æ¨¡å‹ã€ä»“åº“ã€æœåŠ¡ã€‘è¿™æ ·3éƒ¨åˆ†ã€‚
- **ä»“å‚¨æœåŠ¡-infrastructure** ï¼šåŸºç¡€å±‚ä¾èµ–äº domain é¢†åŸŸå±‚ï¼Œå› ä¸ºåœ¨ domain å±‚å®šä¹‰äº†ä»“å‚¨æ¥å£éœ€è¦åœ¨åŸºç¡€å±‚å®ç°ã€‚è¿™æ˜¯ä¾èµ–å€’ç½®çš„ä¸€ç§è®¾è®¡æ–¹å¼ã€‚
- **é¢†åŸŸå°è£…-trigger** ï¼šè§¦å‘å™¨å±‚ï¼Œç”¨äºæä¾›æ¥å£å®ç°ã€æ¶ˆæ¯æ¥æ”¶ã€ä»»åŠ¡æ‰§è¡Œç­‰ã€‚æ‰€ä»¥å¯¹äºè¿™æ ·çš„æ“ä½œï¼Œå°å‚…å“¥æŠŠå®ƒå«åšè§¦å‘å™¨å±‚ã€‚
- **ç±»å‹å®šä¹‰-types** ï¼šé€šç”¨ç±»å‹å®šä¹‰å±‚ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå¼€å‘ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šç±»å‹çš„å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼›åŸºæœ¬çš„ Responseã€Constants å’Œæšä¸¾ã€‚å®ƒä¼šè¢«å…¶ä»–çš„å±‚è¿›è¡Œå¼•ç”¨ä½¿ç”¨ã€‚

### å››ã€å¯¼å…¥åº“è¡¨

è¿™ä¸€èŠ‚æˆ‘ä»¬å…ˆåˆ›å»º `group_buy_activity - æ‹¼å›¢æ´»åŠ¨`ã€`group_buy_discount - æŠ˜æ‰£é…ç½®`ä¸¤ä¸ªåº“è¡¨åˆ°å·¥ç¨‹ä¸­ï¼Œå¹¶å®Œæˆé…ç½®å’Œä½¿ç”¨ã€‚

#### 1. å»ºè¡¨è¯­å¥

```java
CREATE database if NOT EXISTS `group_buy_market` default character set utf8mb4 collate utf8mb4_0900_ai_ci;
use `group_buy_market`;

# è½¬å‚¨è¡¨ group_buy_activity
# ------------------------------------------------------------

DROP TABLE IF EXISTS `group_buy_activity`;

CREATE TABLE `group_buy_activity` (
  `id` bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢',
  `activity_id` bigint(8) NOT NULL COMMENT 'æ´»åŠ¨ID',
  `source` varchar(8) NOT NULL COMMENT 'æ¥æº',
  `channel` varchar(8) NOT NULL COMMENT 'æ¸ é“',
  `goods_id` varchar(12) NOT NULL COMMENT 'å•†å“ID',
  `discount_id` varchar(8) NOT NULL COMMENT 'æŠ˜æ‰£ID',
  `group_type` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æ‹¼å›¢æ–¹å¼ï¼ˆ0è‡ªåŠ¨æˆå›¢ã€1è¾¾æˆç›®æ ‡æ‹¼å›¢ï¼‰',
  `take_limit_count` int(4) NOT NULL DEFAULT '1' COMMENT 'æ‹¼å›¢æ¬¡æ•°é™åˆ¶',
  `target` int(5) NOT NULL DEFAULT '1' COMMENT 'æ‹¼å›¢ç›®æ ‡',
  `valid_time` int(4) NOT NULL DEFAULT '15' COMMENT 'æ‹¼å›¢æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æ´»åŠ¨çŠ¶æ€ï¼ˆ0åˆ›å»ºã€1ç”Ÿæ•ˆã€2è¿‡æœŸã€3åºŸå¼ƒï¼‰',
  `start_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ´»åŠ¨å¼€å§‹æ—¶é—´',
  `end_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ´»åŠ¨ç»“æŸæ—¶é—´',
  `tag_id` varchar(8) DEFAULT NULL COMMENT 'äººç¾¤æ ‡ç­¾è§„åˆ™æ ‡è¯†',
  `tag_scope` varchar(4) DEFAULT NULL COMMENT 'äººç¾¤æ ‡ç­¾è§„åˆ™èŒƒå›´ï¼ˆå¤šé€‰ï¼›1å¯è§é™åˆ¶ã€2å‚ä¸é™åˆ¶ï¼‰',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_activity_id` (`activity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ‹¼å›¢æ´»åŠ¨';

LOCK TABLES `group_buy_activity` WRITE;
/*!40000 ALTER TABLE `group_buy_activity` DISABLE KEYS */;

INSERT INTO `group_buy_activity` (`id`, `activity_id`, `source`, `channel`, `goods_id`, `discount_id`, `group_type`, `take_limit_count`, `target`, `valid_time`, `status`, `start_time`, `end_time`, `tag_id`, `tag_scope`, `create_time`, `update_time`)
VALUES
 (1,100123,'s01','c01','9890001','25120207',0,1,1,15,0,'2024-12-07 10:19:40','2024-12-07 10:19:40','1','1','2024-12-07 10:19:40','2024-12-07 10:19:40');

/*!40000 ALTER TABLE `group_buy_activity` ENABLE KEYS */;
UNLOCK TABLES;


# è½¬å‚¨è¡¨ group_buy_discount
# ------------------------------------------------------------

DROP TABLE IF EXISTS `group_buy_discount`;

CREATE TABLE `group_buy_discount` (
  `id` bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `discount_id` int(8) NOT NULL COMMENT 'æŠ˜æ‰£ID',
  `discount_name` varchar(64) NOT NULL COMMENT 'æŠ˜æ‰£æ ‡é¢˜',
  `discount_desc` varchar(256) NOT NULL COMMENT 'æŠ˜æ‰£æè¿°',
  `discount_type` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æŠ˜æ‰£ç±»å‹ï¼ˆ0:baseã€1:tagï¼‰',
  `market_plan` varchar(4) NOT NULL DEFAULT 'ZJ' COMMENT 'è¥é”€ä¼˜æƒ è®¡åˆ’ï¼ˆZJ:ç›´å‡ã€MJ:æ»¡å‡ã€Nå…ƒè´­ï¼‰',
  `market_expr` varchar(32) NOT NULL COMMENT 'è¥é”€ä¼˜æƒ è¡¨è¾¾å¼',
  `tag_id` varchar(8) DEFAULT NULL COMMENT 'äººç¾¤æ ‡ç­¾ï¼Œç‰¹å®šä¼˜æƒ é™å®š',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uq_discount_id` (`discount_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

LOCK TABLES `group_buy_discount` WRITE;
/*!40000 ALTER TABLE `group_buy_discount` DISABLE KEYS */;

INSERT INTO `group_buy_discount` (`id`, `discount_id`, `discount_name`, `discount_desc`, `discount_type`, `market_plan`, `market_expr`, `tag_id`, `create_time`, `update_time`)
VALUES
 (1,9890001,'æµ‹è¯•ä¼˜æƒ ','æµ‹è¯•ä¼˜æƒ ',0,'ZJ','20',NULL,'2024-12-07 10:20:15','2024-12-07 10:20:15');

/*!40000 ALTER TABLE `group_buy_discount` ENABLE KEYS */;
UNLOCK TABLES;
```

- è¯¾ç¨‹çš„ Docker compose è„šæœ¬ï¼Œä¼šå¸®åŠ©ä½ è‡ªåŠ¨å®Œæˆåº“è¡¨åˆ›å»ºã€‚å¦‚æœé‡åˆ°ä¸€äº›æƒé™æˆ–è€…å…¼å®¹é—®é¢˜ï¼Œå¯¼è‡´åº“è¡¨æ²¡æœ‰è‡ªåŠ¨åˆå§‹åŒ–åˆ° MySQL ä¸­ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥æ‰‹åŠ¨å¤„ç†ï¼Œæ‰§è¡Œè„šæœ¬å¯¼å…¥åˆ° MySQL ä¸­ã€‚

#### 2. å·¥ç¨‹é…ç½®

![group-buy-market-2-1-05.png](./æ‹¼å›¢é¡¹ç›®.assets/FiRajvz_4gz83I7UGFPMFGrXjFHp.png)

**application-dev.yml**

```
# æ•°æ®åº“é…ç½®ï¼›å¯åŠ¨æ—¶é…ç½®æ•°æ®åº“èµ„æºä¿¡æ¯
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:3306/group_buy_market?useUnicode=true&characterEncoding=utf8&autoReconnect=true&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Shanghai&useSSL=true
    driver-class-name: com.mysql.cj.jdbc.Driver
  hikari:
    pool-name: Retail_HikariCP
    minimum-idle: 15 #æœ€å°ç©ºé—²è¿æ¥æ•°é‡
    idle-timeout: 180000 #ç©ºé—²è¿æ¥å­˜æ´»æœ€å¤§æ—¶é—´ï¼Œé»˜è®¤600000ï¼ˆ10åˆ†é’Ÿï¼‰
    maximum-pool-size: 25 #è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤æ˜¯10
    auto-commit: true  #æ­¤å±æ€§æ§åˆ¶ä»æ± è¿”å›çš„è¿æ¥çš„é»˜è®¤è‡ªåŠ¨æäº¤è¡Œä¸º,é»˜è®¤å€¼ï¼štrue
    max-lifetime: 1800000 #æ­¤å±æ€§æ§åˆ¶æ± ä¸­è¿æ¥çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå€¼0è¡¨ç¤ºæ— é™ç”Ÿå‘½å‘¨æœŸï¼Œé»˜è®¤1800000å³30åˆ†é’Ÿ
    connection-timeout: 30000 #æ•°æ®åº“è¿æ¥è¶…æ—¶æ—¶é—´,é»˜è®¤30ç§’ï¼Œå³30000
    connection-test-query: SELECT 1
  type: com.zaxxer.hikari.HikariDataSource

# MyBatis é…ç½®ã€å¦‚éœ€ä½¿ç”¨è®°å¾—æ‰“å¼€ã€‘
mybatis:
  mapper-locations: classpath:/mybatis/mapper/*.xml
  config-location:  classpath:/mybatis/config/mybatis-config.xml
```

- é¦–å…ˆï¼Œåœ¨ä½ çš„å·¥ç¨‹ä¸­ï¼Œéœ€è¦æ·»åŠ æ•°æ®åº“å¯¹è±¡ã€DAOï¼Œä»¥åŠ Mapper é…ç½®æ–‡ä»¶ã€‚
- å¦å¤–ï¼Œæ³¨æ„ application-dev.yml ä¹Ÿè¦ä¿®æ”¹ä¸ºä½ çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€åº“åã€MySQLåœ°å€å’Œç«¯å£ï¼Œæ³¨æ„ä½ æ˜¯ 3306 è¿˜æ˜¯ 13306 è¿˜æ˜¯ 3307ã€‘ï¼ŒåŒæ—¶æ‰“å¼€ MyBatis é…ç½®æ–‡ä»¶ã€‚

### äº”ã€æµ‹è¯•éªŒè¯

åœ¨å…¬å¸ä¸­å¤§å®¶å†™å®Œä»£ç ï¼Œæ˜¯ä¸ä¼šç›´æ¥æäº¤çš„ï¼Œè¿˜éœ€è¦åšåŠŸèƒ½çš„éªŒè¯ã€‚ä¹Ÿå°±æ˜¯ç¼–å†™ä¸€äº›æµ‹è¯•ç±»ã€‚

#### 1. æ‹¼å›¢æ´»åŠ¨æŸ¥è¯¢

```java
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class GroupBuyActivityDaoTest {

    @Resource
    private IGroupBuyActivityDao groupBuyActivityDao;

    @Test
    public void test_queryGroupBuyActivityList() {
        List<GroupBuyActivity> groupBuyActivities = groupBuyActivityDao.queryGroupBuyActivityList();
        log.info("æµ‹è¯•ç»“æœ:{}", JSON.toJSONString(groupBuyActivities));
    }

}
24-12-07.11:49:59.518 [main            ] INFO  HikariDataSource       - HikariPool-1 - Starting...
24-12-07.11:49:59.880 [main            ] INFO  HikariDataSource       - HikariPool-1 - Start completed.
24-12-07.11:50:00.199 [main            ] INFO  GroupBuyActivityDaoTest - æµ‹è¯•ç»“æœ:[{"activityId":100123,"activityName":"æµ‹è¯•æ´»åŠ¨","channel":"c01","createTime":1733537980000,"discountId":"25120207","endTime":1733537980000,"goodsId":"9890001","groupType":0,"id":1,"source":"s01","startTime":1733537980000,"status":0,"tagId":"1","tagScope":"1","takeLimitCount":1,"target":1,"updateTime":1733543247000,"validTime":15}]
```

- å¦‚ä¸ŠæŸ¥è¯¢äº†æ•°æ®åº“ç»“æœã€‚éªŒè¯é€šè¿‡ã€‚

#### 2. æ‹¼å›¢ä¼˜æƒ æŸ¥è¯¢

```
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class GroupBuyDiscountDaoTest {

    @Resource
    private IGroupBuyDiscountDao groupBuyDiscountDao;

    @Test
    public void test_queryGroupBuyDiscountList(){
        List<GroupBuyDiscount> groupBuyDiscounts = groupBuyDiscountDao.queryGroupBuyDiscountList();
        log.info("æµ‹è¯•ç»“æœ:{}", JSON.toJSONString(groupBuyDiscounts));
    }

}
24-12-07.11:50:20.926 [main            ] INFO  HikariDataSource       - HikariPool-1 - Starting...
24-12-07.11:50:21.254 [main            ] INFO  HikariDataSource       - HikariPool-1 - Start completed.
24-12-07.11:50:21.805 [main            ] INFO  GroupBuyDiscountDaoTest - æµ‹è¯•ç»“æœ:[{"createTime":1733538015000,"discountDesc":"æµ‹è¯•ä¼˜æƒ ","discountId":9890001,"discountName":"æµ‹è¯•ä¼˜æƒ ","discountType":0,"id":1,"marketExpr":"20","marketPlan":"ZJ","updateTime":1733538015000}]
```

- 

  å¦‚ä¸ŠæŸ¥è¯¢äº†æ•°æ®åº“ç»“æœã€‚éªŒè¯é€šè¿‡ã€‚





## [ç¬¬2-2èŠ‚ï¼šè¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡](https://articles.zsxq.com/id_tzf8bd3b621x.html)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-2èŠ‚ï¼šè¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡](https://articles.zsxq.com/id_tzf8bd3b621x.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸­ï¼Œéšç€ä¸æ–­åœ°æ‰¿æ¥ä¸šåŠ¡éœ€æ±‚é€»è¾‘çš„å®ç°ï¼Œä¼šæœ‰å¾ˆå¤šå¤æ‚åœºæ™¯éœ€è¦è§£å†³ã€‚è¿™ä¸ªæ—¶å€™å°±ä¼šå¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§ã€‚

ä½†éšç€å¼€å‘çš„åœºæ™¯è¶Šæ¥è¶Šå¤šï¼Œåœ¨å„ä¸ªserviceå®ç°ä¸­ä¼šå­˜åœ¨ç›¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œå¦‚æœæ˜¯ä¸åŒçš„äººå¼€å‘ï¼Œé‚£ä¹ˆä¸€ä¸ªè´£ä»»é“¾ï¼Œä¸€ä¸ªè§„åˆ™æ ‘ï¼Œä¹Ÿä¼šæœ‰éå¸¸å¤šçš„å®ç°æ–¹å¼ã€‚é‚£ä¹ˆè¿™æ ·å°±ä¼šå¯¼è‡´åé¢åœ¨è¿›å…¥å¼€å‘çš„äººï¼Œå¯¹å·²å­˜åœ¨çš„ä»£ç ï¼Œç»´æŠ¤çš„æˆæœ¬å°±è¶Šæ¥è¶Šé«˜äº†ã€‚

æ‰€ä»¥ï¼Œæœ¬èŠ‚å°å‚…å“¥å¸¦ç€å¤§å®¶å…ˆåšè®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚

### äºŒã€æ¨¡å‹è®¾è®¡

è¿™æ˜¯ä¸€ç§é“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜ã€‚

![group-buy-market-2-2-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FrhVbvLg1HbLEOmSD6rnc0DCK9T0.png)

- é¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨çš„è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ã€‚æ¶µç›–ï¼›StrategyMapper - ç­–ç•¥æ˜ å°„å™¨ã€StrategyHandler - ç­–ç•¥å¤„ç†å™¨ã€`AbstractStrategyRouter<T, D, R>` - ç­–ç•¥è·¯ç”±æŠ½è±¡ç±»ã€‚é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚
- ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚è¿™äº›èŠ‚ç‚¹å¯ä»¥è‡ªç”±ç»„è£…è¿›è¡Œæµè½¬ï¼Œç›¸æ¯”äºè´£ä»»é“¾å®ƒçš„å®ç°æ–¹å¼æ›´å…·æœ‰çµæ´»æ€§ã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. æ¨¡æ¿å®šä¹‰

åœ¨é¡¹ç›®å·¥ç¨‹çš„ types æ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿ã€‚å¦‚æœæ˜¯å…¬å¸é‡Œçš„é¡¹ç›®å·¥ç¨‹ï¼Œè¿˜å¯ä»¥å•ç‹¬æä¾›ä¸€ä¸ªé€šç”¨çš„è®¾è®¡æ¨¡å¼æ¨¡æ¿å·¥ç¨‹ï¼Œè¿™æ ·æ¯ä¸ªé¡¹ç›®éƒ½å¯ä»¥å¼•å…¥ä½¿ç”¨äº†ã€‚

![group-buy-market-2-2-02.png](https://article-images.zsxq.com/Fps0XpoodSuWGmCfvfIuhIfrU1U6)

\- ç›®å‰ï¼Œå…ˆæ·»åŠ  tree è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ã€‚åç»­éšç€å¼€å‘éœ€è¦åœ¨æ·»åŠ å…¶ä»–é€šç”¨è®¾è®¡æ¨¡å¼ã€‚

\- è®¾è®¡æ¨¡å¼èµ„æ–™ï¼›https://bugstack.cn/md/develop/design-pattern/2024-08-25-chain-tree.html

##### 1.1 ç­–ç•¥æ˜ å°„å™¨

```java
public interface StrategyMapper<T, D, R> {

    /**
     * è·å–å¾…æ‰§è¡Œç­–ç•¥
     *
     * @param requestParameter å…¥å‚
     * @param dynamicContext   ä¸Šä¸‹æ–‡
     * @return è¿”å‚
     * @throws Exception å¼‚å¸¸
     */
    StrategyHandler<T, D, R> get(T requestParameter, D dynamicContext) throws Exception;

}
```

- StrategyMapper#get æ–¹æ³•ç”¨äºè·å–æ¯ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œç›¸å½“äºä¸€ä¸ªæµç¨‹èµ°å®Œè¿›å…¥åˆ°ä¸‹ä¸€ä¸ªæµç¨‹çš„è¿‡ç¨‹ã€‚è¿™åœ¨æˆ‘ä»¬å¤„ç†å¤æ‚çš„ä¸šåŠ¡ä»£ç æ—¶æ˜¯éå¸¸é‡è¦çš„ï¼Œé¿å…æŠŠæ‰€æœ‰é€»è¾‘éƒ½å†™åˆ°ä¸€ä¸ªç±»çš„æ–¹æ³•ä¸­ã€‚
- æ³›å‹ T - å…¥å‚ã€D - ä¸Šä¸‹æ–‡ã€R - è¿”å‚ã€‚

#####  1.2 ç­–ç•¥å—ç†å™¨

```
public interface StrategyHandler<T, D, R> {

    StrategyHandler DEFAULT = (T, D) -> null;

    R apply(T requestParameter, D dynamicContext) throws Exception;

}
```

- StrategyHandler#apply å—ç†æ‰§è¡Œçš„ä¸šåŠ¡æµç¨‹ã€‚æ¯ä¸ªä¸šåŠ¡æµç¨‹æ‰§è¡Œæ—¶ï¼Œå¦‚æœæœ‰æ•°æ®æ˜¯ä»å‰é¢èŠ‚ç‚¹åˆ°åé¢èŠ‚ç‚¹è¦ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆå¯ä»¥å¡«å……åˆ° dynamicContext ä¸Šä¸‹æ–‡ä¸­ã€‚

##### 1.3 ç­–ç•¥è·¯ç”±å™¨

```java
public abstract class AbstractStrategyRouter<T, D, R> implements StrategyMapper<T, D, R>, StrategyHandler<T, D, R> {

    @Getter
    @Setter
    protected StrategyHandler<T, D, R> defaultStrategyHandler = StrategyHandler.DEFAULT;

    public R router(T requestParameter, D dynamicContext) throws Exception {
        StrategyHandler<T, D, R> strategyHandler = get(requestParameter, dynamicContext);
        if(null != strategyHandler) return strategyHandler.apply(requestParameter, dynamicContext);
        return defaultStrategyHandler.apply(requestParameter, dynamicContext);
    }

}
```

- é€šè¿‡è°ƒç”¨ç­–ç•¥æ˜ å°„å™¨getæ–¹æ³•ï¼Œæ§åˆ¶èŠ‚ç‚¹æµç¨‹çš„èµ°å‘ã€‚

#### 2. é¦–é¡µè¯•ç®—

å½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚

ç±»ä¼¼çš„ï¼Œå½“ä½ è¿›å…¥åˆ°ä¸€ä¸ªä¿¡è´·è´·æ¬¾çš„é¡µé¢ï¼Œä¹Ÿä¼šå‘Šè¯‰ä½ åˆ†æœŸå¤šå°‘ï¼Œè¿˜æ¬¾å¤šå°‘æœŸï¼Œæ¯æœŸå¤šå°‘é’±ã€‚è¿™äº›ä¸œè¥¿ä¹Ÿéƒ½æ˜¯è¯•ç®—ã€‚

![group-buy-market-2-2-03.png](https://article-images.zsxq.com/FmyjoThcfkxC-sp-g1TzVoZKFRnE)

- åœ¨ domain é¢†åŸŸå±‚ï¼Œå®ç°æ‹¼å›¢æ´»åŠ¨æœåŠ¡åŠŸèƒ½ã€‚model æ˜¯å¯¹è±¡çš„å®šä¹‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±ç±»ä¼¼äºä½ åœ¨ mvc ä¸­å®šä¹‰çš„ voã€reqã€res è¿™æ ·çš„å¯¹è±¡ã€‚åªä¸è¿‡è¿™é‡Œä¸€èˆ¬å« xxxEntity å®ä½“ï¼Œå®ƒæ˜¯ä¸€ç§é¢å‘å¯¹è±¡çš„æ€ç»´ã€‚
- trial è¯•ç®—æ¨¡å—ï¼ŒæŠŠæ•´ä¸ªé¦–é¡µå•†å“å±•ç¤ºçš„ä¿¡æ¯éƒ½é€šè¿‡è¯•ç®—å®Œæˆã€‚åç»­ä¼šé‡ç‚¹å®ç°ï¼Œæœ¬èŠ‚å…ˆå®šä¹‰æ¡†æ¶åˆ†å±‚ç»“æ„ã€‚
- ç›®å‰è¿™é‡Œçš„ä»£ç è¿˜æ²¡æœ‰å…·ä½“çš„å®ç°ä»£ç ï¼Œåªæœ‰åˆ†å±‚ç»“æ„ã€‚å¯ä»¥ç›´æ¥å‚è€ƒå·¥ç¨‹çš„ä»£ç ã€‚

##### 2.1 è¥é”€å•†å“å®ä½“ä¿¡æ¯

```
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class MarketProductEntity {

    /** ç”¨æˆ·ID */
    private String userId;
    /** å•†å“ID */
    private String goodsId;
    /** æ¸ é“ */
    private String source;
    /** æ¥æº */
    private String channel;

}
```

##### 2.2 è¯•ç®—ç»“æœå®ä½“å¯¹è±¡

```
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class TrialBalanceEntity {

    /** å•†å“ID */
    private String goodsId;
    /** å•†å“åç§° */
    private String goodsName;
    /** åŸå§‹ä»·æ ¼ */
    private BigDecimal originalPrice;
    /** æŠ˜æ‰£ä»·æ ¼ */
    private BigDecimal deductionPrice;
    /** æ‹¼å›¢ç›®æ ‡æ•°é‡ */
    private Integer targetCount;
    /** æ‹¼å›¢å¼€å§‹æ—¶é—´ */
    private Date startTime;
    /** æ‹¼å›¢ç»“æŸæ—¶é—´ */
    private Date endTime;
    /** æ˜¯å¦å¯è§æ‹¼å›¢ */
    private Boolean isVisible;
    /** æ˜¯å¦å¯å‚ä¸è¿›å›¢ */
    private Boolean isEnable;

}
```

- æš‚å®šä¸€äº›è¯•ç®—çš„æ‰€éœ€çš„ç»“æœï¼Œåç»­éšç€åŠŸèƒ½è¿­ä»£å†è¡¥å……ã€‚

##### 2.3 ä¸¾ä¾‹èŠ‚ç‚¹å®ç°

```
@Slf4j
@Service
public class RootNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Override
    public TrialBalanceEntity apply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return null;
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return null;
    }

}
```

- æ ¹èŠ‚ç‚¹ï¼Œå®ç° AbstractGroupBuyMarketSupport æŠ½è±¡ç±»ã€‚è¿™ä¸ªæŠ½è±¡ç±»ç›®å‰æ˜¯ç©ºå®ç°ï¼Œåç»­ä¸€äº›é€šç”¨çš„æ–¹æ³•ä¼šæ”¾å…¥è¿™ä¸ªæŠ½è±¡ç±»é‡Œã€‚

## [ç¬¬2-3èŠ‚ï¼šå¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½-çŸ¥è¯†æ˜Ÿçƒ](https://wx.zsxq.com/group/48411118851818/topic/2858422848528251)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-3èŠ‚ï¼šå¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½](https://articles.zsxq.com/id_oghwwt024h39.html)

åœ¨äº’è”ç½‘å…¬å¸ä¸­çš„ä¸šåŠ¡åŠŸèƒ½å¼€å‘ï¼Œä¼šéå¸¸é‡è§†æ¥å£çš„å“åº”æ•ˆç‡ï¼Œä¸€èˆ¬æ•´ä½“çš„æ¥å£å“åº”è¦æ§åˆ¶åœ¨350æ¯«ç§’ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸ªç»†åˆ†é¢†åŸŸçš„æ¥å£å¯èƒ½ä¼šè¢«å‹ç¼©åˆ°50~100æ¯«ç§’ã€‚



è¿™æ ·çš„å“åº”æ—¶é—´å¯¹äºä¸€äº›ç®€å•çš„æ¥å£åˆ°ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œä½†å¦‚æœæ˜¯å¤æ‚è¾ƒå¤šçš„ä¸šåŠ¡æµç¨‹ä¸²è”çš„æ¥å£ï¼Œé‚£ä¹ˆæ§åˆ¶æ¥å£çš„å“åº”æ—¶é•¿å°±æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æŒ‘æˆ˜äº†ã€‚å¯¹äºè¿™æ ·çš„æƒ…å†µï¼Œå¾€å¾€ä¼šå¼•å…¥å¼‚æ­¥çº¿ç¨‹åŠ è½½æ•°æ®çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä¹‹ååœ¨åšç»Ÿä¸€çš„é€»è¾‘å¤„ç†ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„é™ä½æ¥å£å“åº”æ—¶é—´ã€‚

### ä¸€ã€æœ¬ç« è¯‰æ±‚

æ‰©å±•è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œå¢åŠ å¼‚æ­¥æ•°æ®åŠ è½½åŒºã€‚å°†ç”¨äºè¯•ç®—è¥é”€ä¼˜æƒ çš„æ¥å£ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹è¿›è¡ŒåŠ è½½ï¼Œä¹‹åå†™å…¥ä¸Šä¸‹æ–‡ï¼Œç”¨äºåç»­çš„é€»è¾‘å¤„ç†ã€‚

è¿™éƒ¨åˆ†çš„æ¨¡å‹è®¾è®¡æ˜¯éå¸¸å·§å¦™çš„ï¼Œé€šè¿‡è§£è€¦é€»è¾‘å’Œåˆ’åˆ†åŠŸèƒ½åŒºï¼Œè®©ä»£ç å…·æœ‰äº†æ–‡æ¡£å±æ€§ï¼Œçœ‹åˆ°å¯¹åº”çš„ç±»å’Œç±»ä¸‹çš„æ–¹æ³•åŒºï¼Œå°±å¯ä»¥è½»æ¾çš„ç†è§£ä»£ç å®ç°æ–¹å¼ã€‚è¿™æ ·çš„å¤„ç†éå¸¸æœ‰åˆ©äºåç»­åŠŸèƒ½çš„è¿­ä»£ã€‚

### äºŒã€æ¨¡å‹é“¾è·¯

å¦‚å›¾ï¼Œä¸ºæ•´ä¸ªæ¨¡å‹é“¾è·¯çš„æ‰§è¡Œè¿‡ç¨‹å›¾ï¼›

![group-buy-market-2-3-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Ft0YBF8mRg13nl_Myd9dfdcVdPFA.png)

- é¦–å…ˆï¼Œå¯¹é€šç”¨è®¾è®¡æ¨¡å¼æ ‘ç»“æ„æ‰©å±•å‡ºå¼‚æ­¥æ•°æ®åŠ è½½åŒºï¼Œè¿™æ ·å¯ä»¥æŠŠæ¥å£å®ç°ä¸­æ‰€éœ€çš„æ•°æ®å‰ç½®åˆ°å¼‚æ­¥æ•°æ®åŠ è½½åŒºå®ŒæˆåŠ è½½æ“ä½œã€‚ä»¥æ­¤æé«˜æ¥å£çš„å“åº”æ•ˆç‡ã€‚
- ä¹‹åï¼Œæœ¬èŠ‚ä¸²è”åŠŸèƒ½èŠ‚ç‚¹ï¼Œå¹¶åœ¨ MarketNode èŠ‚ç‚¹ï¼Œæ·»åŠ æ•°æ®åŠ è½½æ“ä½œã€‚
- å¦å¤–ï¼Œæ³¨æ„æœ¬èŠ‚éœ€è¦æ–°å¢åŠ ä¸€ä¸ªè¡¨ skuï¼Œä¹Ÿå°±æ˜¯å•†å“ä¿¡æ¯è¡¨ï¼Œé€šè¿‡å•†å“ä¿¡æ¯è¡¨è·å¾—å½“å‰å•†å“çš„ä»·æ ¼é…ç½®ï¼Œä»¥æ­¤æ¥åšå•†å“çš„æŠ˜æ‰£è®¡ç®—ã€‚è¿™å—åœ¨å®é™…ç”Ÿäº§ä¸­æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯æ¯æ¬¡éƒ½è°ƒç”¨å¤–éƒ¨æ¥å£è·å–å•†å“ï¼Œå¦å¤–ä¸€ç§æ˜¯æœ‰å•†å“ç»Ÿä¸€åŒæ­¥åº“å¯ä»¥æŸ¥è¯¢ã€‚æˆ‘ä»¬è¿™é‡Œå…ˆé€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„å•†å“åº“è¿›è¡Œå¤„ç†ã€‚é‚£ä¹ˆåç»­è°è¦å¯¹æ¥è¿™ä¸ªç³»ç»Ÿï¼Œå°±è°ƒç”¨skuå•†å“åº“ï¼ŒåŒæ­¥å¥½å•†å“å³å¯ã€‚ã€åº“è¡¨å·²æ›´æ–°åˆ°å·¥ç¨‹ä¸‹ã€‘

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-3-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FrxsEUUC4yWXJMR-2ZbC2OdglB3V.png)

- æœ¬èŠ‚å¼€å§‹ï¼Œå¢åŠ  sql-bak å­˜æ”¾å„ä¸ªç« èŠ‚çš„ sqlï¼Œæ–¹ä¾¿å¤§å®¶éšæ—¶ç”¨ä¸åŒçš„ sql åšæµ‹è¯•ã€‚æœ¬èŠ‚ä½ å¯ä»¥ç›´æ¥å¯¼å…¥æœ€æ–°çš„ SQL è¯­å¥å³å¯ã€‚
- domain æ¨¡å—ä¸‹ï¼ŒåšåŠŸèƒ½é€»è¾‘å®ç°ã€‚æ–°å¢åŠ äº† thread å¤šçº¿ç¨‹æ¨¡å—ï¼Œå¤„ç†å¼‚æ­¥æ•°æ®ä»»åŠ¡ã€‚

#### 2. æ‰©å±•æ¨¡æ¿ - å¢åŠ å¤šçº¿ç¨‹æ¨¡å—

åœ¨ types æ¨¡å—çš„ design æ¨¡å‹å®šä¹‰ä¸­ï¼Œæ–°å¢åŠ æŠ½è±¡ç±»è®¾è®¡å¤šçº¿ç¨‹æ•°æ®åŠ è½½åŒºã€‚

```java
public abstract class AbstractMultiThreadStrategyRouter<T, D, R> implements StrategyMapper<T, D, R>, StrategyHandler<T, D, R> {

    @Getter
    @Setter
    protected StrategyHandler<T, D, R> defaultStrategyHandler = StrategyHandler.DEFAULT;

    public R router(T requestParameter, D dynamicContext) throws Exception {
        StrategyHandler<T, D, R> strategyHandler = get(requestParameter, dynamicContext);
        if(null != strategyHandler) return strategyHandler.apply(requestParameter, dynamicContext);
        return defaultStrategyHandler.apply(requestParameter, dynamicContext);
    }

    @Override
    public R apply(T requestParameter, D dynamicContext) throws Exception {
        // å¼‚æ­¥åŠ è½½æ•°æ®
        multiThread(requestParameter, dynamicContext);
        // ä¸šåŠ¡æµç¨‹å—ç†
        return doApply(requestParameter, dynamicContext);
    }

    /**
     * å¼‚æ­¥åŠ è½½æ•°æ®
     */
    protected abstract void multiThread(T requestParameter, D dynamicContext) throws ExecutionException, InterruptedException, TimeoutException;

    /**
     * ä¸šåŠ¡æµç¨‹å—ç†
     */
    protected abstract R doApply(T requestParameter, D dynamicContext) throws Exception;

}
```

- ä¸»è¦æ˜¯æ·»åŠ äº†ä¸€ä¸ª multiThread æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œ apply å—ç†ä¸šåŠ¡åŠŸèƒ½é€»è¾‘å®ç°å‰å®Œæˆå¯¹æ•°æ®çš„åŠ è½½è°ƒç”¨ã€‚
- ä¹‹ååœ¨æä¾›ä¸€ä¸ª doApply å—ç†çš„æŠ½è±¡æ–¹æ³•ï¼Œè®©ä½¿ç”¨æ–¹å®Œæˆè¿™ä¸ªæ–¹æ³•çš„å®ç°å³å¯ã€‚
- è¿™å—çš„é€»è¾‘å¯¹æ–°äººå¯èƒ½æœ‰ç‚¹ç»•ï¼Œä½ å¯ä»¥åœ¨æœ¬èŠ‚æœ€åçš„ä»£ç æµ‹è¯•è°ƒè¯•æ—¶è¿›è¡ŒéªŒè¯ã€‚**debug æ–­ç‚¹è°ƒè¯•ä»£ç å¯¹ç¼–ç æ¥è¯´éå¸¸é‡è¦**

#### 3. èŠ‚ç‚¹é€»è¾‘

##### 3.1 RootNode

```java
@Slf4j
@Service
public class RootNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private SwitchNode switchNode;

    @Override
    protected TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-RootNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));
        // å‚æ•°åˆ¤æ–­
        if (StringUtils.isBlank(requestParameter.getUserId()) || StringUtils.isBlank(requestParameter.getGoodsId()) ||
                StringUtils.isBlank(requestParameter.getSource()) || StringUtils.isBlank(requestParameter.getChannel())) {
            throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo());
        }
        return router(requestParameter, dynamicContext);
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return switchNode;
    }

}
```

- æ ¹èŠ‚ç‚¹ä¸€èˆ¬ä¼šåšæ•°æ®çš„åˆå§‹æ“ä½œï¼Œä¿¡æ¯åˆ¤æ–­ï¼Œç¼“å­˜å¤„ç†ç­‰åŠŸèƒ½ã€‚

##### 3.2 SwitchNode

```java
@Slf4j
@Service
public class SwitchNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private MarketNode marketNode;

    @Override
    public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return router(requestParameter, dynamicContext);
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return marketNode;
    }

}
```

- å¼€å…³åŠŸèƒ½çš„èŠ‚ç‚¹åœ¨åç»­åœ¨åšå®ç°ã€‚

##### 3.3 MarketNode

è¿™ä¸ªèŠ‚ç‚¹æ˜¯æœ¬èŠ‚æœ€é‡è¦å®ç°çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè®©å¤§å®¶ç†è§£å¤šçº¿ç¨‹åœ¨å®é™…åœºæ™¯ä¸­çš„ä½¿ç”¨ã€‚

å½“ä½ ä¸€ä¸ªèŠ‚ç‚¹è¦æ‰§è¡Œä¸šåŠ¡é€»è¾‘æ—¶å€™ï¼Œéœ€è¦ä¸ºè¿™äº›ä¸šåŠ¡é€»è¾‘å‡†å¤‡æ¥å£ã€æ•°æ®åº“ã€Redisã€é…ç½®ä¸­å¿ƒç­‰å„æ ·çš„æ•°æ®ï¼Œä½†æœ‰äº›æ—¶å€™å¤–éƒ¨çš„æ¥å£ä¾èµ–çš„å¾ˆå¤šï¼Œé‚£ä¹ˆå°±ä¸èƒ½ä¸€ä¸ªä¸ªé¡ºåºçš„æŸ¥è¯¢ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¥å£çš„æ—¶é•¿å¾ˆå¤§ã€‚æ‰€ä»¥è¦å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„æ—¶é•¿ä¹Ÿå°±åªæ˜¯é‚£ä¸ªè€—æ—¶æœ€é•¿çš„æ¥å£æ—¶é•¿äº†ã€‚

é¦–å…ˆï¼Œæ–°å¢åŠ å¼‚æ­¥ FutureTask ä»»åŠ¡ï¼Œå®Œæˆå¯¹æ´»åŠ¨é…ç½®çš„æŸ¥è¯¢ï¼Œå•†å“çš„æŸ¥è¯¢ã€‚

```java
public class QueryGroupBuyActivityDiscountVOThreadTask implements Callable<GroupBuyActivityDiscountVO> {

    /**
     * æ¥æº
     */
    private final String source;

    /**
     * æ¸ é“
     */
    private final String channel;

    /**
     * æ´»åŠ¨ä»“å‚¨
     */
    private final IActivityRepository activityRepository;

    public QueryGroupBuyActivityDiscountVOThreadTask(String source, String channel, IActivityRepository activityRepository) {
        this.source = source;
        this.channel = channel;
        this.activityRepository = activityRepository;
    }

    @Override
    public GroupBuyActivityDiscountVO call() throws Exception {
        return activityRepository.queryGroupBuyActivityDiscountVO(source, channel);
    }

}

public class QuerySkuVOFromDBThreadTask implements Callable<SkuVO> {

    private final String goodsId;

    private final IActivityRepository activityRepository;

    public QuerySkuVOFromDBThreadTask(String goodsId, IActivityRepository activityRepository) {
        this.goodsId = goodsId;
        this.activityRepository = activityRepository;
    }

    @Override
    public SkuVO call() throws Exception {
        return activityRepository.querySkuByGoodsId(goodsId);
    }

}
```

- è¿™é‡Œæ˜¯ä¸¤ä¸ªå®ç°äº† Callable æ¥å£çš„ä»»åŠ¡ï¼Œåˆ†åˆ«æŸ¥è¯¢ä¸åŒçš„æ•°æ®ã€‚
- åœ¨å®é™…çš„å·¥ä½œä¸­ï¼ŒæŸ¥è¯¢çš„ä¸åªæ˜¯æ•°æ®ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æä¾›çš„RPCã€HTTPæ¥å£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ MarketNode èŠ‚ç‚¹ï¼Œæ¥å¤„ç†è¿™äº›æ•°æ®ä»»åŠ¡çš„è°ƒç”¨æ“ä½œã€‚

```
@Slf4j
@Service
public class MarketNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private ThreadPoolExecutor threadPoolExecutor;
    @Resource
    private EndNode endNode;

    @Override
    protected void multiThread(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws ExecutionException, InterruptedException, TimeoutException {
        // å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½®
        QueryGroupBuyActivityDiscountVOThreadTask queryGroupBuyActivityDiscountVOThreadTask = new QueryGroupBuyActivityDiscountVOThreadTask(requestParameter.getSource(), requestParameter.getChannel(), repository);
        FutureTask<GroupBuyActivityDiscountVO> groupBuyActivityDiscountVOFutureTask = new FutureTask<>(queryGroupBuyActivityDiscountVOThreadTask);
        threadPoolExecutor.execute(groupBuyActivityDiscountVOFutureTask);

        // å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ - åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œå•†å“æœ‰åŒæ­¥åº“æˆ–è€…è°ƒç”¨æ¥å£æŸ¥è¯¢ã€‚è¿™é‡Œæš‚æ—¶ä½¿ç”¨DBæ–¹å¼æŸ¥è¯¢ã€‚
        QuerySkuVOFromDBThreadTask querySkuVOFromDBThreadTask = new QuerySkuVOFromDBThreadTask(requestParameter.getGoodsId(), repository);
        FutureTask<SkuVO> skuVOFutureTask = new FutureTask<>(querySkuVOFromDBThreadTask);
        threadPoolExecutor.execute(skuVOFutureTask);

        // å†™å…¥ä¸Šä¸‹æ–‡ - å¯¹äºä¸€äº›å¤æ‚åœºæ™¯ï¼Œè·å–æ•°æ®çš„æ“ä½œï¼Œæœ‰æ—¶å€™ä¼šåœ¨ä¸‹Nä¸ªèŠ‚ç‚¹è·å–ï¼Œè¿™æ ·å‰ç½®æŸ¥è¯¢æ•°æ®ï¼Œå¯ä»¥æé«˜æ¥å£å“åº”æ•ˆç‡
        dynamicContext.setGroupBuyActivityDiscountVO(groupBuyActivityDiscountVOFutureTask.get(timeout, TimeUnit.MINUTES));
        dynamicContext.setSkuVO(skuVOFutureTask.get(timeout, TimeUnit.MINUTES));

        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-MarketNode userId:{} å¼‚æ­¥çº¿ç¨‹åŠ è½½æ•°æ®ã€ŒGroupBuyActivityDiscountVOã€SkuVOã€å®Œæˆ", requestParameter.getUserId());
    }

    @Override
    public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-MarketNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

        // todo xfg æ‹¼å›¢ä¼˜æƒ è¯•ç®—

        return router(requestParameter, dynamicContext);
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return endNode;
    }

}
```

- 

  multiThread æ–¹æ³•ä¸­ï¼Œå¯åŠ¨å¯¹å¼‚æ­¥æ•°æ®çš„æŸ¥è¯¢å¤„ç†ï¼Œä¹‹ååœ¨ä½¿ç”¨åŠ¨æ€ä¸Šä¸‹æ–‡æ‰¿æ¥æ•°æ®ã€‚

- 

  doApply å—ç†ä¸šåŠ¡æµç¨‹çš„å®ç°æ”¾åœ¨åç»­åœ¨å¤„ç†ã€‚

- 

  threadPoolExecutor çº¿ç¨‹æ± é…ç½®çš„æ˜¯ CallerRunsPolicy ç­–ç•¥ã€‚å½“çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œå¹¶ä¸”æ²¡æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥æ‰§è¡Œæ–°ä»»åŠ¡æ—¶ï¼ŒCallerRunsPolicy ä¼šå°†ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…çº¿ç¨‹ä¸­è¿è¡Œã€‚è¿™ç§ç­–ç•¥é€‚ç”¨äºä¸å¸Œæœ›ä¸¢å¤±ä»»åŠ¡ä¸”å¯ä»¥æ¥å—è°ƒç”¨è€…çº¿ç¨‹è¢«é˜»å¡çš„åœºæ™¯ã€‚ã€æœ‰æ—¶å€™é¢è¯•ä¸ä¼šç›´æ¥é—®å…«è‚¡ï¼Œè€Œæ˜¯ç»“åˆè¿™æ ·çš„åœºæ™¯æ¥é—®ã€‚ã€‘

#### 4.4 EndNode

ç”¨äºå°è£…æœ€ç»ˆè¿”å›çš„ç»“æœæ•°æ®ã€‚

```
@Slf4j
@Service
public class EndNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Override
    public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-EndNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

        GroupBuyActivityDiscountVO groupBuyActivityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO();
        SkuVO skuVO = dynamicContext.getSkuVO();

        // è¿”å›ç©ºç»“æœ
        return TrialBalanceEntity.builder()
                  .goodsId(skuVO.getGoodsId())
                  .goodsName(skuVO.getGoodsName())
                  .originalPrice(skuVO.getOriginalPrice())
                  .deductionPrice(new BigDecimal("0.00"))
                  .targetCount(groupBuyActivityDiscountVO.getTarget())
                  .startTime(groupBuyActivityDiscountVO.getStartTime())
                  .endTime(groupBuyActivityDiscountVO.getEndTime())
                  .isVisible(false)
                  .isEnable(false)
                  .build();
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return defaultStrategyHandler;
    }

}
```

- è¿”å›çš„æ•°æ®å¯ä»¥ç”±åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­çš„ç»“æœè¿›è¡Œå°è£…ã€‚
- æš‚æ—¶å’±ä»¬è¿™é‡ŒåªæŠŠå¯ä»¥è·å–åˆ°çš„æ•°æ®åšä¸€ä¸ªå¤„ç†ã€‚å…³äºä¼˜æƒ é‡‘é¢ä»¥åŠå¯è§æ€§ç­‰å‚æ•°mockå†™å…¥å³å¯ã€‚

### å››ã€æµ‹è¯•éªŒè¯

```java
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
public class IIndexGroupBuyMarketServiceTest {

    @Resource
    private IIndexGroupBuyMarketService indexGroupBuyMarketService;

    @Test
    public void test_indexMarketTrial() throws Exception {
        MarketProductEntity marketProductEntity = new MarketProductEntity();
        marketProductEntity.setUserId("xiaofuge");
        marketProductEntity.setSource("s01");
        marketProductEntity.setChannel("c01");
        marketProductEntity.setGoodsId("9890001");

        TrialBalanceEntity trialBalanceEntity = indexGroupBuyMarketService.indexMarketTrial(marketProductEntity);
        log.info("è¯·æ±‚å‚æ•°:{}", JSON.toJSONString(marketProductEntity));
        log.info("è¿”å›ç»“æœ:{}", JSON.toJSONString(trialBalanceEntity));
    }

}
```

```powershell
24-12-21.11:17:40.759 [main            ] INFO  RootNode               - æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-RootNode userId:xiaofuge requestParameter:{"channel":"c01","goodsId":"9890001","source":"s01","userId":"xiaofuge"}
24-12-21.11:17:40.823 [pool-2-thread-2 ] INFO  HikariDataSource       - HikariPool-1 - Starting...
24-12-21.11:17:41.117 [pool-2-thread-2 ] INFO  HikariDataSource       - HikariPool-1 - Start completed.
24-12-21.11:17:41.176 [main            ] INFO  MarketNode             - æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-MarketNode userId:xiaofuge requestParameter:{"channel":"c01","goodsId":"9890001","source":"s01","userId":"xiaofuge"}
24-12-21.11:17:41.176 [main            ] INFO  EndNode                - æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-EndNode userId:xiaofuge requestParameter:{"channel":"c01","goodsId":"9890001","source":"s01","userId":"xiaofuge"}
24-12-21.11:17:41.177 [main            ] INFO  IIndexGroupBuyMarketServiceTest - è¯·æ±‚å‚æ•°:{"channel":"c01","goodsId":"9890001","source":"s01","userId":"xiaofuge"}
24-12-21.11:17:41.186 [main            ] INFO  IIndexGroupBuyMarketServiceTest - è¿”å›ç»“æœ:{"deductionPrice":0.00,"endTime":1733537980000,"goodsId":"9890001","goodsName":"ã€Šæ‰‹å†™MyBatisï¼šæ¸è¿›å¼æºç å®è·µã€‹","isEnable":false,"isVisible":false,"originalPrice":100.00,"startTime":1733537980000,"targetCount":1}
```

- è°ƒç”¨ *é¦–é¡µè¥é”€æœåŠ¡æ¥å£* åšåŠŸèƒ½é€»è¾‘çš„éªŒè¯ã€‚
- ä»æµ‹è¯•ç»“æœçœ‹ç¬¦åˆé¢„æœŸã€‚

## [ç¬¬2-4èŠ‚ï¼šç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—-çŸ¥è¯†æ˜Ÿçƒ](https://wx.zsxq.com/group/48411118851818/topic/8858422254118512)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-4èŠ‚ï¼šç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—](https://articles.zsxq.com/id_76rtxi18xl6g.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

é€šè¿‡ç­–ç•¥æ¨¡å¼å¤„ç†å¤šç±»å‹æŠ˜æ‰£æ–¹å¼çš„é€»è¾‘è®¡ç®—ï¼ŒåŒæ—¶è®¾å®šæŠ½è±¡æ¨¡æ¿ï¼Œç”¨äºæ‰©å±•åç»­äººç¾¤æ ‡ç­¾çš„è¿‡æ»¤ã€‚

ä¸æ–­çš„æ‹†è§£åŠŸèƒ½é€»è¾‘è¾¹ç•Œçš„è¿‡ç¨‹ï¼Œæ¯”åªæ˜¯ç¼–å†™æµæ°´å¼ä»£ç è¦é‡è¦çš„å¤šã€‚åœ¨æ•´ä¸ªç³»ç»Ÿå®ç°çš„è¿‡ç¨‹ä¸­ï¼Œè¦å¤šä½“ä¼šè¿™äº›æ€æƒ³ã€‚

### äºŒã€æ¨¡å‹è®¾è®¡

![group-buy-market-2-4-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FtHIJHU1x9KfxtfT5Unp2o-mKVH8.png)

- é¦–å…ˆï¼ŒMarketNode èŠ‚ç‚¹çš„æ•°æ®å¼‚æ­¥åŠ è½½å·¥ä½œå·²ç»åœ¨ä¸Šä¸€èŠ‚å®Œæˆï¼Œè¿™ä¸€èŠ‚å¼€å§‹ä½¿ç”¨è¿™é‡Œçš„æ•°æ®åšæŠ˜æ‰£è®¡ç®—ã€‚
- ä¹‹åï¼ŒæŠ˜æ‰£æ˜¯åœ¨æ•°æ®åº“ä¸­é…ç½®çš„ï¼ŒæŒ‰ç…§ç±»å‹åŒ…æ‹¬ï¼›ZJ - ç›´å‡ã€MJ - æ»¡å‡ã€ZK - æŠ˜æ‰£ã€N - nå…ƒè´­ã€‚é‚£ä¹ˆè¿™äº›ä¸åŒçš„ç±»å‹å°±å¯ä»¥ç”¨ç­–ç•¥æ¨¡å‹è¿›è¡ŒåŒ…è£…ï¼Œæ¯ä¸ªå®ç°ç±»ä¸“é—¨è´Ÿè´£è‡ªå·±çš„é€»è¾‘è®¡ç®—ã€‚

### ä¸‰ã€ç¼–ç å®ç°

### 1.å·¥ç¨‹ç»“æ„

![group-buy-market-2-4-02.png](./æ‹¼å›¢é¡¹ç›®.assets/Ft0Wy8oot0lFk4zcmscJc_R2RoAy.png)

- service åŒ…ä¸‹ï¼Œå¢åŠ  discount æŠ˜æ‰£è®¡ç®—åŒ…ï¼Œæä¾›ä¸åŒç±»å‹çš„æŠ˜æ‰£è®¡ç®—æœåŠ¡ã€‚
- ä¹‹åå† MarketNode èŠ‚ç‚¹åšé€»è¾‘è°ƒç”¨ã€‚è®¡ç®—å®Œç»“æœååœ¨å†™ä¸Šä¸‹æ–‡ï¼Œä¾¿äºæœ€ååœ¨ EndNode èŠ‚ç‚¹å¡«å……ã€‚

### 2.æŠ˜æ‰£ç­–ç•¥

![group-buy-market-2-4-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FtbT8AkidRT09sJK12YhjGskINZ-.png)

æŠ˜æ‰£çš„æ–¹å¼å¯ä»¥æœ‰ï¼›ZJã€MJã€ZKã€Nï¼Œä»¥åŠå¤šç§æ–¹å¼ã€‚è¿™é‡Œçš„ market_expr æ˜¯è®¡ç®—çš„å…¬å¼ï¼Œæ¯”å¦‚ MJ - æ»¡å‡è¿™æ ·çš„ï¼Œå°±æ˜¯æ»¡100å…ƒï¼Œå‡10å…ƒã€‚

æ¦‚å¿µï¼šåƒæ˜¯è¿™ç§è¥é”€æŠ˜æ‰£æ–¹å¼ï¼Œæ˜¯ä¸€ç§å•†å®¶é…ç½®æ— åˆ¸è¥é”€æ–¹å¼ï¼Œç”¨æˆ·æ˜¯æ— æ„ŸçŸ¥åˆ¸ä½†å¯ä»¥ä½¿ç”¨ä¼˜æƒ çš„ã€‚å¦å¤–ä¸€ç§å°±æ˜¯æœ‰åˆ¸ï¼Œç”¨æˆ·ä¸»åŠ¨æ‹¿åˆ°æ‰‹é‡Œçš„åˆ¸ï¼Œè‡ªå·±é€‰æ‹©æ¶ˆè´¹æ–¹å¼

#### 2.1 å®šä¹‰æ¥å£

```java
public interface IDiscountCalculateService {

    /**
     * æŠ˜æ‰£è®¡ç®—
     *
     * @param userId           ç”¨æˆ·ID
     * @param originalPrice    å•†å“åŸå§‹ä»·æ ¼
     * @param groupBuyDiscount æŠ˜æ‰£è®¡åˆ’é…ç½®
     * @return å•†å“ä¼˜æƒ ä»·æ ¼
     */
    BigDecimal calculate(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount);

}
```

- å®šä¹‰æŠ˜æ‰£è®¡ç®—çš„æ¥å£ï¼ŒåŒ…æ‹¬ç”¨æˆ·IDã€å•†å“åŸå§‹ä»·æ ¼ã€æŠ˜æ‰£è®¡åˆ’é…ç½®ã€‚
- ç”¨æˆ·IDï¼Œä¸»è¦ç”¨äºåç»­åšäººç¾¤æ ‡ç­¾çš„è¿‡æ»¤ä½¿ç”¨ã€‚

#### 2.2 æŠ½è±¡æ¨¡æ¿

```java
public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService {

    @Override
    public BigDecimal calculate(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) {
        // 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤
        if (DiscountTypeEnum.TAG.equals(groupBuyDiscount.getDiscountType())){
            boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId());
            if (!isCrowdRange) return originalPrice;
        }
        // 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®—
        return doCalculate(originalPrice, groupBuyDiscount);
    }

    // äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ 
    private boolean filterTagId(String userId, String tagId) {
        // todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ†
        return true;
    }

    protected abstract BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount);

}
```

* å®šä¹‰æŠ½è±¡æ¨¡æ¿å°è£…è®¡ç®—æŠ˜æ‰£ä¼˜æƒ çš„æ‰§è¡Œè¿‡ç¨‹ã€‚äººç¾¤æ ‡ç­¾éƒ¨åˆ†åç»­ç»Ÿä¸€å¤„ç†

#### 2.3 æŠ˜æ‰£æ–¹æ³•

```java
@Slf4j
@Service("MJ")
public class MJCalculateService extends AbstractDiscountCalculateService {

    @Override
    public BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) {
        log.info("ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}", groupBuyDiscount.getDiscountType().getCode());

        // æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ
        String marketExpr = groupBuyDiscount.getMarketExpr();
        String[] split = marketExpr.split(Constants.SPLIT);
        BigDecimal x = new BigDecimal(split[0].trim());
        BigDecimal y = new BigDecimal(split[1].trim());

        // ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»·
        if (originalPrice.compareTo(x) < 0) {
            return originalPrice;
        }

        // æŠ˜æ‰£ä»·æ ¼
        BigDecimal deductionPrice = originalPrice.subtract(y);

        // åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’±
        if (deductionPrice.compareTo(BigDecimal.ZERO) <= 0) {
            return new BigDecimal("0.01");
        }

        return deductionPrice;
    }

}
```

- è¿™é‡Œä¸¾ä¾‹å…¶ä¸­ä¸€ä¸ªï¼ŒMJ çš„æŠ˜æ‰£è®¡ç®—ã€‚å…¶ä»–çš„å¯ä»¥å‚è€ƒä»£ç ä¸­çš„å®ç°ã€‚
- æ»¡å‡ï¼Œæ‹¿åˆ°æŠ˜æ‰£çš„é…ç½®è¡¨è¾¾å¼ï¼Œæ‹†åˆ† `100,10`ï¼Œä¹‹ååˆ¤æ–­å•†å“é‡‘é¢æ˜¯å¦æ»¡è¶³100å…ƒï¼Œæ»¡è¶³100å…ƒåˆ™å¯ä»¥å‡å»10å…ƒã€‚ä¸è¿‡è¿™é‡Œè¦çŸ¥é“ï¼Œå¦‚æœå•†å“æœ€ç»ˆæŠ˜æ‰£ä»·æ ¼ä¸è¶³1åˆ†é’±ï¼Œè¦æŒ‰ç…§1åˆ†é’±è®¡ç®—ã€‚

### 3. è¥é”€è°ƒç”¨

```java
@Slf4j
@Service
public class MarketNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private ThreadPoolExecutor threadPoolExecutor;
    @Resource
    private EndNode endNode;

    /**
     * <a href="https://bugstack.cn/md/road-map/spring-dependency-injection.html">Spring æ³¨å…¥è¯¦ç»†è¯´æ˜</a>
     */
    @Resource
    private Map<String, IDiscountCalculateService> discountCalculateServiceMap;

    @Override
    public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-MarketNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

        GroupBuyActivityDiscountVO groupBuyActivityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO();
        GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount = groupBuyActivityDiscountVO.getGroupBuyDiscount();

        SkuVO skuVO = dynamicContext.getSkuVO();

        IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());
        if (null == discountCalculateService) {
            log.info("ä¸å­˜åœ¨{}ç±»å‹çš„æŠ˜æ‰£è®¡ç®—æœåŠ¡ï¼Œæ”¯æŒç±»å‹ä¸º:{}", groupBuyDiscount.getMarketPlan(), JSON.toJSONString(discountCalculateServiceMap.keySet()));
            throw new AppException(ResponseCode.E0001.getCode(), ResponseCode.E0001.getInfo());
        }

        // æŠ˜æ‰£ä»·æ ¼
        BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);
        dynamicContext.setDeductionPrice(deductionPrice);

        return router(requestParameter, dynamicContext);
    }
    
    // ... çœç•¥éƒ¨åˆ†ä»£ç 

}
```

- `private Map<String, IDiscountCalculateService> discountCalculateServiceMap;` æ˜¯ä¸€ç§ Spring çš„Map æ³¨å…¥æ–¹å¼ï¼Œä¼šæ ¹æ®ä¸€ä¸ªæ¥å£æŠŠæ‰€æœ‰çš„å®ç°ç±»éƒ½æ³¨å…¥ä¸Šï¼Œä¹‹å Key æ˜¯ Bean çš„åå­—ã€‚æ‰©å±•å­¦ä¹ ï¼›https://bugstack.cn/md/road-map/spring-dependency-injection.html
- è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®æ•°æ®åº“é…ç½®çš„æŠ˜æ‰£çš„ç±»å‹æ¥è°ƒç”¨å¯¹åº”çš„ç­–ç•¥ï¼Œä¹Ÿå°±æŠŠ if...else è¿™æ ·çš„åˆ¤æ–­ä»£ç ç»™å»æ‰äº†ã€‚

## [ç¬¬2-5èŠ‚ï¼šäººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†](https://wx.zsxq.com/group/48411118851818/topic/5121445114128884)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-5èŠ‚ï¼šäººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†](https://articles.zsxq.com/id_zl9c3gz8av14.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

ä»¥è½»é‡åŒ–çš„æ–¹å¼æ„å»ºäººç¾¤æ ‡ç­¾æ•°æ®ï¼Œå°†äººç¾¤æ•°æ®å†™å…¥åˆ° Redis BitMap ç”¨äºåç»­ä½¿ç”¨ã€‚

åœ¨å…¬å¸ä¸­ï¼Œæ‰€æœ‰éƒ¨é—¨äº§ç”Ÿçš„ä¸šåŠ¡æ•°æ®éƒ½ä¼šå›æµåˆ°æ•°ä»“ï¼Œå®ƒæœ‰ä¸€ä¸ªéå¸¸åºå¤§çš„æ•°æ®é›†å¸‚ç³»ç»Ÿã€‚ä¹‹åè¿™äº›æ•°æ®ä¼šè¢«é‡åŒ–åˆ†æå¸ˆä½¿ç”¨ï¼Œé€šè¿‡ R è¯­è¨€å»ºæ¨¡ï¼Œæ‰§è¡Œæ¨¡å‹ä»»åŠ¡ï¼ŒæŠŠç¬¦åˆæ¨¡å‹æ‰€éœ€çš„æ ‡ç­¾æ•°æ®è·‘åˆ°ä¸€ä¸ªæ–°çš„æŒ‡å®šè¡¨æ–‡ä»¶ä¸­ï¼Œè¿™äº›æ–‡ä»¶åœ¨é€šè¿‡åŠ å·¥å­˜æ”¾åˆ° Redis BitMap è¿›è¡Œä½¿ç”¨ã€‚ä¸€èˆ¬ä¸€ä¸ªæ ‡ç­¾å¯èƒ½ä¼šæœ‰ 50ä¸‡ã€100ä¸‡ã€500ä¸‡çš„æ•°æ®è§„æ¨¡ã€‚

æœ‰äº†è¿™äº›æ ‡ç­¾æ•°æ®ï¼Œè¿è¥äººå‘˜å°±å¯ä»¥ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

è™½ç„¶ï¼Œæˆ‘ä»¬ä¸èƒ½åƒå…¬å¸é‚£æ ·æœ‰é‚£ä¹ˆå¤§è§„æ¨¡çš„æ•°æ®é‡ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»…ä½¿ç”¨æ‹¼å›¢å•†å“çš„æ•°æ®ï¼Œåšäººç¾¤æ ‡ç­¾çš„å®ç°ï¼Œè®©å¤§å®¶äº†è§£è¿™æ ·ä¸€ä¸ªåœºæ™¯ã€‚

![group-buy-market-2-5-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fr_szZtxcIXqPsbG7VVEQpLcprpX.png)

- é¦–å…ˆï¼Œäººç¾¤æ ‡ç­¾æ˜¯é€šè¿‡åˆ›å»ºçš„é‡‡é›†ä»»åŠ¡æ‰€äº§ç”Ÿçš„æ•°æ®ã€‚ä»»åŠ¡é‡ŒåŒ…å«äº†è¦é‡‡é›†ä¸šåŠ¡ä¸­ä»€ä¹ˆç±»å‹çš„æ•°æ®è§„åˆ™ã€‚æœ¬é¡¹ç›®ä¸­ä¼šé‡‡é›†æ‹¼å›¢äº¤æ˜“æ•°æ®ï¼Œä¸è¿‡æœ¬èŠ‚è¿˜æ²¡æœ‰è¿™ç±»æ•°æ®ï¼Œæ‰€ä»¥å…ˆæ¥æ¨¡æ‹Ÿè¿™éƒ¨åˆ†æ•°æ®ã€‚
- ä¹‹åï¼ŒæŠŠé‡‡é›†çš„æ•°æ®é™¤äº†æ”¾æ•°æ®åº“ï¼Œè¿˜éœ€è¦å†™å…¥åˆ° Redis çš„ BitMap ä¸­ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„æ¯”è¾ƒé€‚åˆé«˜å¹¶å‘åœºæ™¯åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ã€‚

### ä¸‰ã€ç¼–ç å®ç°

- æœ¬èŠ‚éœ€è¦æ–°åˆ›å»ºå‡º crowd_tagsã€crowd_tags_detailã€crowd_tags_job 3å¼ åº“è¡¨ã€‚ä½ å¯ä»¥è¯¾ç¨‹å·¥ç¨‹ä¸­å¯¼å…¥ã€‚
- å¼•å…¥ Redisson é…ç½®ï¼Œpomå¼•å…¥ã€app/config å¢åŠ é…ç½®ã€infrastructure å¢åŠ  Redisson æœåŠ¡æ¥å£å’Œå®ç°ç±»ã€‚

```java
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.26.0</version>
</dependency>
```

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-5-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FjGANXS9PHD9AhtspUgrrrd6OdfT.png)

- infrastructure åŸºç¡€è®¾æ–½å±‚ï¼Œå¢åŠ äººç¾¤æ ‡ç­¾ä»“å‚¨æœåŠ¡å’Œ3ä¸ªæ“ä½œäººç¾¤æ ‡ç­¾çš„DAOæ“ä½œï¼ŒåŒæ—¶åœ¨å¢åŠ ä¸€ä¸ª Redisson æ“ä½œæ¥å£å’Œå®ç°ç±»ï¼ˆä½ å¯ä»¥ç›´æ¥å¤åˆ¶è¯¾ç¨‹çš„ï¼‰ã€‚
- domain é¢†åŸŸå±‚ï¼Œå¢åŠ  tag äººç¾¤æ ‡ç­¾é¢†åŸŸï¼Œå®Œæˆäººç¾¤æ ‡ç­¾åŠŸèƒ½å®ç°ã€‚
- app åº”ç”¨å¯åŠ¨å±‚ï¼Œé…ç½® mapperã€application-dev.ymlã€ä»¥åŠ config ä¸‹çš„ Redis é“¾æ¥é…ç½®ç±»ã€‚

#### 2. äººç¾¤ä»»åŠ¡

å¢åŠ äººç¾¤æ ‡ç­¾æœåŠ¡æ¥å£ï¼Œå¹¶å®ç°åŠŸèƒ½æµç¨‹ã€‚

```java
@Slf4j
@Service
public class TagService implements ITagService {

    @Resource
    private ITagRepository repository;

    @Override
    public void execTagBatchJob(String tagId, String batchId) {
        log.info("äººç¾¤æ ‡ç­¾æ‰¹æ¬¡ä»»åŠ¡ tagId:{} batchId:{}", tagId, batchId);

        // 1. æŸ¥è¯¢æ‰¹æ¬¡ä»»åŠ¡
        CrowdTagsJobEntity crowdTagsJobEntity = repository.queryCrowdTagsJobEntity(tagId, batchId);

        // 2. é‡‡é›†ç”¨æˆ·æ•°æ® - è¿™éƒ¨åˆ†éœ€è¦é‡‡é›†ç”¨æˆ·çš„æ¶ˆè´¹ç±»æ•°æ®ï¼Œåç»­æœ‰ç”¨æˆ·å‘èµ·æ‹¼å•åå†å¤„ç†ã€‚

        // 3. æ•°æ®å†™å…¥è®°å½•
        List<String> userIdList = new ArrayList<String>() {{
            add("xiaofuge");
            add("liergou");
        }};

        // 4. ä¸€èˆ¬äººç¾¤æ ‡ç­¾çš„å¤„ç†åœ¨å…¬å¸ä¸­ï¼Œä¼šæœ‰ä¸“é—¨çš„æ•°æ®æ•°ä»“å›¢é˜Ÿé€šè¿‡è„šæœ¬æ–¹å¼å†™å…¥åˆ°æ•°æ®åº“ï¼Œå°±ä¸ç”¨è¿™æ ·ä¸€ä¸ªä¸ªæˆ–è€…æ‰¹æ¬¡æ¥å†™ã€‚
        for (String userId : userIdList) {
            repository.addCrowdTagsUserId(tagId, userId);
        }

        // 5. æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡é‡
        repository.updateCrowdTagsStatistics(tagId, userIdList.size());
    }

}

```

- é€šè¿‡é‡‡é›†äººç¾¤æ ‡ç­¾ä»»åŠ¡è·å–äººç¾¤æ•°æ®ï¼Œæš‚æ—¶æ²¡æœ‰è¿™ç±»ä¸šåŠ¡æ•°æ®ï¼Œæ‰€ä»¥å…ˆæ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·æ•°æ®ï¼Œä½ ä¹Ÿå¯ä»¥è°ƒæ•´è¿™é‡Œçš„æ•°æ®ä¸ºä½ éœ€è¦çš„ã€‚
- é‡‡é›†æ•°æ®åï¼Œ`repository.addCrowdTagsUserId(tagId, userId);` å†™å…¥åˆ°æ•°æ®åº“è¡¨ã€‚æ³¨æ„ addCrowdTagsUserId æ–¹æ³•ï¼Œå†™å…¥åè¿˜ä¼šåš BitMap å­˜å‚¨ã€‚
- è¿™äº›æ“ä½œå®Œæˆåï¼Œä¼šæ›´æ–°ç»Ÿè®¡é‡ã€‚æ³¨æ„ï¼Œç›®å‰çš„ç»Ÿè®¡é‡æ›´æ–°æ˜¯ä¸å‡†çš„ï¼Œå› ä¸ºæ‰§è¡Œ addCrowdTagsUserId æ“ä½œï¼Œä¼šæœ‰ä¸»é”®å†²çªï¼Œä¸»é”®å†²çªç›´æ¥æ‹¦æˆªä¸ä¼šæŠ›å¼‚å¸¸ã€‚é‚£ä¹ˆæ›´æ–°äººç¾¤æ ‡ç­¾çš„ç»Ÿè®¡é‡ä¼šç»§ç»­å¢åŠ ã€‚ä½ å¯ä»¥æ€è€ƒä¸‹è¿™é‡Œè¦æ€ä¹ˆå¤„ç†ï¼Œè¯¾ç¨‹åç»­ä¹Ÿä¼šç»§ç»­å¤„ç†ã€‚

#### 3. æ•°æ®å­˜å‚¨ - bitmap

```java
@Override
public void addCrowdTagsUserId(String tagId, String userId) {
    CrowdTagsDetail crowdTagsDetailReq = new CrowdTagsDetail();
    crowdTagsDetailReq.setTagId(tagId);
    crowdTagsDetailReq.setUserId(userId);
    try {
        crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq);
        // è·å–BitSet
        RBitSet bitSet = redisService.getBitSet(tagId);
        bitSet.set(redisService.getIndexFromUserId(userId), true);
    } catch (DuplicateKeyException ignore) {
        // å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª
    }
}
```

- æ‰§è¡Œå®Œå†™åº“åï¼Œå¼€å§‹æŠŠæ•°æ®å†™å…¥åˆ°äººç¾¤æ ‡ç­¾ã€‚
- ä¸è¿‡æ³¨æ„äººç¾¤æ ‡ç­¾çš„å­˜å‚¨ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¦è½¬è¡Œä¸ºé•¿æ•´å‹è¿›è¡Œå­˜æ”¾ã€‚



## [ç¬¬2-6èŠ‚ï¼šæ‹†åˆ†åº“è¡¨å…³è”å…³ç³»](https://wx.zsxq.com/group/48411118851818/topic/1525111528411542)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-6èŠ‚ï¼šæ‹†åˆ†åº“è¡¨å…³è”å…³ç³»](https://articles.zsxq.com/id_695jhwno47z5.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

åœ¨ç³»ç»Ÿå¼€å§‹ä¹‹åˆï¼Œç®€åŒ–åŠŸèƒ½è®¾è®¡ï¼Œè®©æ‹¼å›¢æ´»åŠ¨é…ç½®è¡¨ç›´æ¥è€¦åˆå•†å“IDã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ‹¼å›¢æ´»åŠ¨ï¼Œåªå…³è”ä¸€ä¸ªå•†å“IDã€‚é‚£ä¹ˆå¦‚æœç°åœ¨éœ€è¦ç»™10ä¸ªå•†å“ï¼Œå…¨é…ç½®ä¸€ä¸ªç›¸åŒçš„æ‹¼å›¢æ´»åŠ¨ï¼Œå°±æ²¡æ³•é…ç½®äº†ã€‚æ€»ä¸èƒ½ä¸€ä¸ªä¸ªå…¨é…ç½®ä¸€éã€‚æ‰€ä»¥æœ¬èŠ‚è¦å¯¹è¿™å—çš„å†…å®¹åšæ‹†åˆ†è§£è€¦ã€‚

![group-buy-market-2-6-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fv4D3w3hL0bsAg_z8QwYtB7AB55l.png)

- group_buy_activity æ‹¼å›¢æ´»åŠ¨é…ç½®è¡¨ä¸­ï¼Œèåˆäº†æ¸ é“å’Œå•†å“IDï¼Œå±äºå’Œæ´»åŠ¨é…ç½®ç»‘å®šäº†ã€‚
- sku å•†å“ä¿¡æ¯ï¼Œå·²ç»åŒ…å«äº†æ¸ é“SCå€¼å’Œå•†å“IDã€‚è€Œå•†å“è¡¨å’±ä»¬å‰é¢æåˆ°è¿‡ï¼Œå®ƒæ˜¯ç”±æ¥å…¥æ–¹åŒæ­¥çš„å•†å“ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¸èµ°è¿™é‡Œï¼Œç›´æ¥ç”¨ RPC/HTTP æ¥å£æŸ¥è¯¢æ•°æ®ï¼Œæ‰€ä»¥ sku è¡¨ä¸é€‚åˆç»‘å®šäº’åŠ¨IDã€‚
- é‚£ä¹ˆï¼Œå°±éœ€è¦ä¸€ä¸ªæ–°çš„è¡¨æ¥å…³è”æ´»åŠ¨å’Œå•†å“ä¿¡æ¯é…ç½®ï¼Œè¡¨åä¸º sc_sku_activity å¿…å¤‡å­—æ®µï¼›SCæ¸ é“ã€æ´»åŠ¨IDã€å•†å“IDã€‚ï¼ˆè‡ªå·±åˆ›å»ºåº“è¡¨åå¯ä»¥å’Œè¯¾ç¨‹çš„åº“è¡¨å¯¹æ¯”ï¼‰
- ä½ å¯ä»¥æ ¹æ®è¿™æ ·çš„ä¿¡æ¯æ¥åˆ›å»ºä½ çš„åº“è¡¨ï¼ŒåŒæ—¶ç§»é™¤ group_buy_activity è¡¨ä¸­ SCæ¸ é“å€¼å’Œå•†å“IDã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼Œæ•´ä¸ªæ”¹åŠ¨æµç¨‹çš„æ ¸å¿ƒä¸ºè®© MarketNode èŠ‚ç‚¹çš„æŸ¥è¯¢ç”±åŸæ¥æ–¹å¼æ”¹ä¸ºå…ˆæŸ¥è¯¢SCå•†å“æ´»åŠ¨é…ç½®å…³è”è¡¨ï¼Œè·å¾—åˆ°æ´»åŠ¨IDï¼Œå†æŸ¥è¯¢æ´»åŠ¨ä¿¡æ¯ã€‚è¿™æœŸé—´å¦‚æœæœ‰æ•ˆçš„æ´»åŠ¨é…ç½®ä¿¡æ¯æ— ï¼Œé‚£ä¹ˆåˆ™èµ°åˆ° ErrorNode èŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å®šçš„é”™è¯¯ç ã€‚

![group-buy-market-2-6-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FjO-l11oUe1eyD2M_9imUxJ-SGu9.png)

- é¦–å…ˆï¼Œä½ å¯ä»¥å…ˆé€šè¿‡å¦‚å›¾çš„è°ƒç”¨è¿‡ç¨‹ï¼Œç†è§£æœ¬èŠ‚è¦å®Œæˆçš„ç¼–ç¨‹åŠ¨ä½œã€‚åŒ…æ‹¬è§£è€¦åçš„æ–°çš„åº“è¡¨å…³è”å…³ç³»ã€‚
- ä¹‹åï¼Œç¼–ç çš„æ—¶å€™å¼‚æ­¥å¤šçº¿ç¨‹æŸ¥è¯¢å•†å“å…³è”é…ç½®ï¼Œå¦‚æœé…ç½®çš„ä¿¡æ¯ä¸ºç©ºï¼Œæˆ–è€…ä¸å­˜åœ¨æœ‰æ•ˆçš„æ´»åŠ¨ï¼Œé‚£ä¹ˆå¯ä»¥è¿”å›ä¸€ä¸ª nullã€‚å½“æ‹¿åˆ°null ä»¥åï¼Œå¯ä»¥åšåˆ¤æ–­è¿›è¡Œè·¯ç”±ï¼Œèµ°åˆ° ErrorNode èŠ‚ç‚¹ã€‚ã€Œè¿™éƒ¨åˆ†ä»£ç ä¸€å®šè‡ªå·±å°è¯•ä¸‹ï¼Œå¤šæ€è€ƒã€‚ã€

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-6-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FoPm_axcMLgApzVl8prXA5dFvB91.png)

- åŠŸèƒ½ä¸»è¦ä»¥è¿™3ä¸ªèŠ‚ç‚¹è¿›è¡Œå¼€å‘ï¼Œä¼šæ¶‰åŠåˆ°å…³äºæ•°æ®åº“æ˜ å°„ POã€Mapper çš„å­—æ®µè°ƒæ•´å’Œæ–°çš„æ˜ å°„å…³ç³»æ·»åŠ ã€‚
- MarketNode è¥é”€èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®æ–¹å¼è°ƒæ•´å¤„ç†ï¼Œåœ¨ QueryGroupBuyActivityDiscountVOThreadTask ä¸­éœ€è¦æœ‰ä¸€ä¸ª querySCSkuActivityBySCGoodsId æ–¹æ³•ï¼Œæ¥æŸ¥è¯¢å•†å“å¯¹åº”çš„æ´»åŠ¨é…ç½®ã€‚
- ErrorNode èŠ‚ç‚¹ï¼Œä¸»è¦å¤„ç†ä¸€äº›å¼‚å¸¸å…œåº•çš„é€»è¾‘ï¼Œæ¯”å¦‚æŸ¥è¯¢ä¸åˆ°å¯¹åº”çš„æ‹¼å›¢æ´»åŠ¨é…ç½®ï¼Œé‚£ä¹ˆå°±è¦è¿”å›å¯¹åº”çš„é”™è¯¯ç ã€‚

#### 2. SCå•†å“æ¸ é“DAO

```java
@Mapper
public interface ISCSkuActivityDao {

    SCSkuActivity querySCSkuActivityBySCGoodsId(SCSkuActivity scSkuActivity);

}

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bugstack.infrastructure.dao.ISCSkuActivityDao">

    <resultMap id="dataMap" type="cn.bugstack.infrastructure.dao.po.SCSkuActivity">
        <id column="id" property="id"/>
        <result column="source" property="source"/>
        <result column="channel" property="channel"/>
        <result column="activity_id" property="activityId"/>
        <result column="goods_id" property="goodsId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <select id="querySCSkuActivityBySCGoodsId" parameterType="cn.bugstack.infrastructure.dao.po.SCSkuActivity" resultMap="dataMap">
        select source, channel, activity_id, goods_id
        from sc_sku_activity
        where goods_id = #{goodsId}
    </select>

</mapper>
```

* éœ€è¦é…ç½®æ–°çš„ DAO æ–¹æ³•ï¼ŒæŸ¥è¯¢æ¸ é“å•†å“æ´»åŠ¨IDé…ç½®ä¿¡æ¯ã€‚

#### 3. ä¿®æ”¹æŸ¥è¯¢è¥é”€é…ç½®

```java
public class QueryGroupBuyActivityDiscountVOThreadTask implements Callable<GroupBuyActivityDiscountVO> {

    /**
     * æ¥æº
     */
    private final String source;

    /**
     * æ¸ é“
     */
    private final String channel;

    /**
     * å•†å“ID
     */
    private final String goodsId;

    /**
     * æ´»åŠ¨ä»“å‚¨
     */
    private final IActivityRepository activityRepository;

    public QueryGroupBuyActivityDiscountVOThreadTask(String source, String channel, String goodsId, IActivityRepository activityRepository) {
        this.source = source;
        this.channel = channel;
        this.goodsId = goodsId;
        this.activityRepository = activityRepository;
    }

    @Override
    public GroupBuyActivityDiscountVO call() throws Exception {
        // æŸ¥è¯¢æ¸ é“å•†å“æ´»åŠ¨é…ç½®å…³è”é…ç½®
        SCSkuActivityVO scSkuActivityVO = activityRepository.querySCSkuActivityBySCGoodsId(source, channel, goodsId);
        if (null == scSkuActivityVO) return null;
        // æŸ¥è¯¢æ´»åŠ¨é…ç½®
        return activityRepository.queryGroupBuyActivityDiscountVO(scSkuActivityVO.getActivityId());
    }

}
```

* éœ€è¦å¤šå¢åŠ ä¸€ä¸ªæŸ¥è¯¢ querySCSkuActivityBySCGoodsId çš„æ“ä½œï¼ŒæŠŠå¯¹åº”çš„è¿™ä¸ªå•†å“é…ç½®çš„æ´»åŠ¨IDæŸ¥è¯¢å‡ºæ¥ã€‚

#### 4. è¥é”€èŠ‚ç‚¹è·¯ç”±

```java
public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
    log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-MarketNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));
    // è·å–ä¸Šä¸‹æ–‡æ•°æ®
    GroupBuyActivityDiscountVO groupBuyActivityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO();
    if (null == groupBuyActivityDiscountVO) {
        return router(requestParameter, dynamicContext);
    }
    GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount = groupBuyActivityDiscountVO.getGroupBuyDiscount();
    SkuVO skuVO = dynamicContext.getSkuVO();
    if (null == groupBuyDiscount || null == skuVO) {
        return router(requestParameter, dynamicContext);
    }
  
    // ä¼˜æƒ è¯•ç®—
    IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());
    if (null == discountCalculateService) {
        log.info("ä¸å­˜åœ¨{}ç±»å‹çš„æŠ˜æ‰£è®¡ç®—æœåŠ¡ï¼Œæ”¯æŒç±»å‹ä¸º:{}", groupBuyDiscount.getMarketPlan(), JSON.toJSONString(discountCalculateServiceMap.keySet()));
        throw new AppException(ResponseCode.E0001.getCode(), ResponseCode.E0001.getInfo());
    }
    // æŠ˜æ‰£ä»·æ ¼
    BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);
    dynamicContext.setDeductionPrice(deductionPrice);
    return router(requestParameter, dynamicContext);
}

@Override
public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
    // ä¸å­˜åœ¨é…ç½®çš„æ‹¼å›¢æ´»åŠ¨ï¼Œèµ°å¼‚å¸¸èŠ‚ç‚¹
    if (null == dynamicContext.getGroupBuyActivityDiscountVO() || null == dynamicContext.getSkuVO()) {
        return errorNode;
    }
    return endNode;
}
```

- åˆ¤æ–­ groupBuyActivityDiscountVOã€groupBuyDiscountã€skuVOï¼Œæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºåˆ™ç›´æ¥è·¯ç”±èµ°åˆ°å…œåº•èŠ‚ç‚¹ã€‚
- è¿™ä¸ªå…œåº•èŠ‚ç‚¹å°±æ˜¯æœ¬èŠ‚æ–°å¢åŠ çš„ ErrorNode èŠ‚ç‚¹ã€‚

#### 5. å¼‚å¸¸å…œåº•èŠ‚ç‚¹

```java
@Slf4j
@Service
public class ErrorNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Override
    protected TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

        // æ— è¥é”€é…ç½®
        if (null == dynamicContext.getGroupBuyActivityDiscountVO() || null == dynamicContext.getSkuVO()) {
            log.info("å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}", requestParameter.getGoodsId());
            throw new AppException(ResponseCode.E0002.getCode(), ResponseCode.E0002.getInfo());
        }

        return TrialBalanceEntity.builder().build();
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return defaultStrategyHandler;
    }

}
```

* å¼‚å¸¸å…œåº•èŠ‚ç‚¹å¯ä»¥å¤„ç†å¾ˆå¤šå¼‚å¸¸æµç¨‹ï¼ŒåŒ…æ‹¬ï¼›æµç¨‹è®²è§£ã€æ¥å£è¶…æ—¶ç­‰ã€‚ä»¥åŠå…¬å¸ä¸­è¿è¥é…ç½®çš„æ´»åŠ¨ä¿¡æ¯æœ‰è¯¯ï¼Œä¹Ÿä¼šèµ°åˆ°ä¸€ä¸ªå…œåº•çš„æµç¨‹ã€‚

## [ç¬¬2-7èŠ‚ï¼šäººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤](https://wx.zsxq.com/group/48411118851818/topic/5121444521251424)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-7èŠ‚ï¼šäººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤](https://articles.zsxq.com/id_21knk4dza0gh.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

åœ¨æ•´ä¸ªé¦–é¡µè¥é”€è¯•ç®—æµç¨‹ä¸­ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ–°çš„äººç¾¤æ ‡ç­¾ğŸ·èŠ‚ç‚¹ TagNodeï¼Œæ¥å¤„ç†äººç¾¤è¿‡æ»¤çš„æ“ä½œã€‚

åœ¨æœ¬èŠ‚ä½ ä¼šçœ‹åˆ°ç›®å‰çš„æ¨¡å‹ç»“æ„è®¾è®¡æ˜¯éå¸¸å®¹æ˜“æ·»åŠ å‡ºä¸€ä¸ªæ–°çš„æµç¨‹èŠ‚ç‚¹ï¼ŒåŒæ—¶å¯¹åŸæœ‰çš„åŠŸèƒ½ä¸ä¼šæœ‰ç ´åæ€§ã€‚è¿™æ ·æ—¢å¯ä»¥è®©æˆ‘ä»¬æ›´å¥½çš„ç»´æŠ¤ä»£ç ï¼Œä¹Ÿèƒ½æ–¹ä¾¿æŒç»­çš„éœ€æ±‚è¿­ä»£ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼Œå¢åŠ  TagNode èŠ‚ç‚¹ï¼Œè°ƒæ•´èŠ‚ç‚¹è°ƒç”¨å…³ç³»ï¼›

![group-buy-market-2-7-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fjz4MX-D74apaPsBh4H8dhIWsjVW.png)

- é¦–å…ˆï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„ TagNode èŠ‚ç‚¹ï¼Œè°ƒæ•´è¥é”€ MarketNode èŠ‚ç‚¹å®Œæˆä¸šåŠ¡åŠŸèƒ½åï¼Œæµè½¬åˆ°æ–°çš„ TagNode èŠ‚ç‚¹ã€‚
- ä¹‹åï¼Œåœ¨ä»ä¸ª TagNode èŠ‚ç‚¹æµè½¬åˆ° EndNode ç»“æŸèŠ‚ç‚¹ã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-7-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FhBDFGwaOsZAaEBDfOX6AZIDz52W.png)

- domain é¢†åŸŸå±‚çš„ activity æ´»åŠ¨é¢†åŸŸä¸‹ï¼Œtrial æœåŠ¡ä¸‹ node èŠ‚ç‚¹ä¸­æ·»åŠ  TagNodeï¼Œä¹‹åå†ä» MarketNode æµè½¬åˆ° TagNode
- TagNode èŠ‚ç‚¹é‡ç‚¹å¤„ç†äººç¾¤æ ‡ç­¾çš„è¿‡æ»¤æ“ä½œã€‚è¿™éƒ¨åˆ†çš„é€»è¾‘åŠŸèƒ½ä¸å¤šã€‚åŸºæœ¬ä¸Šä½ åˆ°è¿™é‡Œå¯ä»¥æ€è€ƒğŸ¤”ï¼Œæ€ä¹ˆåˆ¤æ–­å¤„ç†ã€‚

#### 2. äººç¾¤è¿‡æ»¤

##### 2.1 åº“è¡¨é…ç½®

![group-buy-market-2-7-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FienYU2F9wYNtDftFz3nQhF27x3q.png)

- group_buy_activity è¡¨ä¸­ tag_scope ä¸­é…ç½®1,2 ä»£è¡¨éœ€è¦è¿‡æ»¤äººç¾¤ï¼Œé™åˆ¶å¯è§æ€§å’Œå‚ä¸æ€§ã€‚æ¯”å¦‚è¿™é‡Œçš„é…ç½®è¡¨ç¤ºï¼Œä¸€ä¸ªå‚åŠ æ´»åŠ¨çš„ç”¨æˆ·ï¼Œå¦‚æœä¸å†äººç¾¤èŒƒå›´å†…ï¼Œæ—¢ä¸å…è®¸çœ‹è§æ´»åŠ¨ï¼Œä¹Ÿä¸å…è®¸å‚ä¸æ´»åŠ¨ã€‚å¦‚æœåªé…ç½®2ï¼Œé‚£ä¹ˆè¡¨ç¤ºé€šè¿‡äººç¾¤çš„ç”¨æˆ·ï¼Œèƒ½çœ‹è§ï¼Œä½†ä¸èƒ½å‚ä¸ã€‚
- é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå°±è¦åšäººç¾¤è¿‡æ»¤é™åˆ¶ï¼Œå°±è¦æ‹¿åˆ°è¿™ä¸ª1,2å€¼ï¼Œä¹‹ååˆ¤æ–­å¤„ç†ã€‚

##### 2.2 èšåˆæ–¹æ³•

```java
public class GroupBuyActivityDiscountVO {

    /**
     * æ´»åŠ¨ID
     */
    private Long activityId;
    /**
     * æ´»åŠ¨åç§°
     */
    private String activityName;
    /**
     * æ¥æº
     */
    private String source;
    /**
     * æ¸ é“
     */
    private String channel;
    /**
     * å•†å“ID
     */
    private String goodsId;
    /**
     * æŠ˜æ‰£é…ç½®
     */
    private GroupBuyDiscount groupBuyDiscount;
    /**
     * æ‹¼å›¢æ–¹å¼ï¼ˆ0è‡ªåŠ¨æˆå›¢ã€1è¾¾æˆç›®æ ‡æ‹¼å›¢ï¼‰
     */
    private Integer groupType;
    /**
     * æ‹¼å›¢æ¬¡æ•°é™åˆ¶
     */
    private Integer takeLimitCount;
    /**
     * æ‹¼å›¢ç›®æ ‡
     */
    private Integer target;
    /**
     * æ‹¼å›¢æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
     */
    private Integer validTime;
    /**
     * æ´»åŠ¨çŠ¶æ€ï¼ˆ0åˆ›å»ºã€1ç”Ÿæ•ˆã€2è¿‡æœŸã€3åºŸå¼ƒï¼‰
     */
    private Integer status;
    /**
     * æ´»åŠ¨å¼€å§‹æ—¶é—´
     */
    private Date startTime;
    /**
     * æ´»åŠ¨ç»“æŸæ—¶é—´
     */
    private Date endTime;
    /**
     * äººç¾¤æ ‡ç­¾è§„åˆ™æ ‡è¯†
     */
    private String tagId;
    /**
     * äººç¾¤æ ‡ç­¾è§„åˆ™èŒƒå›´
     */
    private String tagScope;

    /**
     * å¯è§é™åˆ¶
     * åªè¦å­˜åœ¨è¿™æ ·ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆé¦–æ¬¡è·å¾—çš„é»˜è®¤å€¼å°±æ˜¯ false
     */
    public boolean isVisible() {
        String[] split = this.tagScope.split(Constants.SPLIT);
        if (split.length > 0 && Objects.equals(split[0], "1") && StringUtils.isNotBlank(split[0])) {
            return false;
        }
        return true;
    }

    /**
     * å‚ä¸é™åˆ¶
     * åªè¦å­˜åœ¨è¿™æ ·ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆé¦–æ¬¡è·å¾—çš„é»˜è®¤å€¼å°±æ˜¯ false
     */
    public boolean isEnable() {
        String[] split = this.tagScope.split(Constants.SPLIT);
        if (split.length == 2 && Objects.equals(split[1], "2") && StringUtils.isNotBlank(split[1])) {
            return false;
        }
        return true;
    }
    
    //... çœç•¥éƒ¨åˆ†ä»£ç 
}    
```

- å¯è§é™åˆ¶ï¼›æ–¹æ³•èšåˆåˆ°åˆ°ç±»ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦é…ç½®äº†1ã€‚å¦‚æœé…ç½®äº†ï¼Œé‚£ä¹ˆé»˜è®¤è¿™ä¸ªå¯¹åº”çš„å€¼çš„ç»“æœå°±æ˜¯ falseï¼Œä¹‹ååœ¨åˆ¤æ–­æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œå¦‚æœåœ¨äººç¾¤èŒƒå›´å†…åˆ™ä¸º trueã€‚
- å‚ä¸é™åˆ¶ï¼›æ–¹æ³•èšåˆåˆ°åˆ°ç±»ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦é…ç½®äº†2ã€‚å¦‚æœé…ç½®äº†ï¼Œé‚£ä¹ˆé»˜è®¤è¿™ä¸ªå¯¹åº”çš„å€¼çš„ç»“æœå°±æ˜¯ falseï¼Œä¹‹ååœ¨åˆ¤æ–­æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œå¦‚æœåœ¨äººç¾¤èŒƒå›´å†…åˆ™ä¸º trueã€‚

##### 2.3 ä»£ç å®ç°

```java
@Slf4j
@Service
public class TagNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private EndNode endNode;

    @Override
    protected TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        // è·å–æ‹¼å›¢æ´»åŠ¨é…ç½®
        GroupBuyActivityDiscountVO groupBuyActivityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO();

        String tagId = groupBuyActivityDiscountVO.getTagId();
        boolean visible = groupBuyActivityDiscountVO.isVisible();
        boolean enable = groupBuyActivityDiscountVO.isEnable();

        // äººç¾¤æ ‡ç­¾é…ç½®ä¸ºç©ºï¼Œåˆ™èµ°é»˜è®¤å€¼
        if (StringUtils.isBlank(tagId)) {
            dynamicContext.setVisible(true);
            dynamicContext.setEnable(true);
            return router(requestParameter, dynamicContext);
        }

        // æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼›visibleã€enable å¦‚æœå€¼ä¸º ture åˆ™è¡¨ç¤ºæ²¡æœ‰é…ç½®æ‹¼å›¢é™åˆ¶ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä¿è¯ä¸º true å³å¯
        boolean isWithin = repository.isTagCrowdRange(tagId, requestParameter.getUserId());
        dynamicContext.setVisible(visible || isWithin);
        dynamicContext.setEnable(enable || isWithin);

        return router(requestParameter, dynamicContext);
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return endNode;
    }

}
```

- é¦–å…ˆï¼Œåˆ¤æ–­ tagId æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è®¿é—®çš„å¯è§æ€§å’Œå‚ä¸æ€§éƒ½ä¸º true å³å¯ã€‚
- ä¹‹åï¼Œè¿‡æ»¤äººç¾¤æ ‡ç­¾ï¼Œ`isWithin` ä¸ºç”¨æˆ·æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ã€‚`visible || isWithin`ã€`enable || isWithin` åªè¦æœ‰ä¸€ä¸ª true åˆ™å¯ä»¥é€šè¿‡ã€‚



## [ç¬¬2-8èŠ‚ï¼šåŠ¨æ€é…ç½®å¼€å…³æ“ä½œ](https://wx.zsxq.com/group/48411118851818/topic/5121444811581214)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-8èŠ‚ï¼šåŠ¨æ€é…ç½®å¼€å…³æ“ä½œ](https://articles.zsxq.com/id_g11s9obc01ih.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

å¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ

è¿™æ˜¯äº’è”ç½‘åº”ç”¨ç¨‹åºä¸­ç»å¸¸å¹²çš„äº‹æƒ…ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚

é‚£ä¹ˆå¯¹äºé…ç½®ä¸­å¿ƒï¼Œæœ‰ SpringCloud Config + Event Busï¼Œä¹Ÿæœ‰ Nacosï¼Œè¿˜æœ‰å„ä¸ªå¤§å‚ä¸­ä¼šåŸºäºå„ç±»ç»„ä»¶åšçš„è‡ªç ”å®ç°ã€‚é‚£ä¹ˆæœ¬èŠ‚æˆ‘ä»¬å…ˆæ¥åšä¸€ä¸ªåŸºäº Redis å‘å¸ƒ/è®¢é˜…å¤„ç†åŠ¨æ€é…ç½®çš„è‡ªç ”çš„å®ç°ï¼Œä¹‹åå¯¹äº SpringCloud çš„åŠ¨æ€é…ç½®å˜æ›´å·²ç»æœ‰æ¡ˆä¾‹ï¼Œå°ä¼™ä¼´ä¹Ÿå¯ä»¥å­¦ä¹ ã€‚

æ¡ˆä¾‹ï¼šhttps://bugstack.cn/md/road-map/springcloud-bus.html

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼ŒåŸºäº Redis å®ç°ä¸€å¥—åŠ¨æ€é…ç½®ä¸­å¿ƒ DCC æœåŠ¡ï¼›Dynamic Config Control

![group-buy-market-2-8-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fids8HJBQIk2hB8HSzK3q_wEY0jM.png)

- æ³¨æ„ï¼Œæœ¬èŠ‚ä¼šæ¶‰åŠåˆ° Springæºç ã€Java åŠ¨æ€é…ç½®çš„ä¸€äº›ç¼–ç æ“ä½œï¼Œå±äºç»„ä»¶ç±»å¼€å‘æ˜¯æ€æƒ³ã€‚å¦‚æœ¬èŠ‚å®ç°çš„åŠŸèƒ½ä¹Ÿå¯ä»¥è¢«ç‹¬ç«‹å‡ºä¸€ä¸ªå·¥ç¨‹ç»„ä»¶å¼€å‘åè¢«ä¸šåŠ¡ç³»ç»Ÿå¼•å…¥ä½¿ç”¨ã€‚
- æ–¹æ¡ˆï¼ŒåŠ¨æ€é…ç½®çš„å¤„ç†å¯ä»¥ä½¿ç”¨ Zookeeper çš„èŠ‚ç‚¹ç›‘å¬ï¼Œä¹Ÿå¯ä»¥åŸºäº Redis çš„å‘å¸ƒ/è®¢é˜…ã€‚æœ¬èŠ‚å’±ä»¬ä½¿ç”¨ Redis è¿™å¥—æ–¹æ¡ˆï¼Œå½“ä½ å­¦ä¹ åˆ°åé¢çš„å¤§è¥é”€é¡¹ç›®ï¼Œè¿˜ä¼šçœ‹åˆ° Zookeeper çš„å®ç°æ–¹æ¡ˆã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-8-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FvSnM8QfFwNZuGBQnma9z4O6ses6.png)

- æ­¥éª¤1ï¼›æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼Œç”¨äº Spring æ‰«æ Bean å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ç®¡ç†è¿™äº›é…ç½®äº†è‡ªå®šä¹‰æ³¨è§£çš„ç±»çš„å±æ€§ã€‚
- æ­¥éª¤2ï¼›ç»™æœåŠ¡ç±»çš„å±æ€§æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ã€‚
- æ­¥éª¤3ï¼›ç”± app æ¨¡å—ä¸‹çš„ configï¼Œæ·»åŠ ä¸€ä¸ªåŠ¨æ€é…ç½®ç®¡ç†çš„å·¥å‚ğŸ­ï¼Œä¼šè‡ªåŠ¨çš„å®Œæˆå±æ€§ä¿¡æ¯çš„å¡«å……å’ŒåŠ¨æ€å˜æ›´æ“ä½œã€‚
- æ­¥éª¤4ï¼›ä¸šåŠ¡ä½¿ç”¨ï¼Œä¼šè°ƒç”¨æ­¥éª¤2ä¸­çš„å±æ€§æœåŠ¡ã€‚å½“æœ‰é…ç½®æ“ä½œå˜åŠ¨çš„æ—¶å€™ï¼Œåˆ™å¯ä»¥æŠŠé…ç½®ä¿¡æ¯ç›´æ¥åˆ·æ–°åˆ°å†…å­˜å±æ€§ä¸Šã€‚
- æ­¥éª¤5ï¼›é…ç½®çš„å˜æ›´æ¥è‡ªäºè¿™é‡Œï¼Œå½“è°ƒç”¨ DCCController æ—¶ï¼Œä¼šè§¦å‘ Redis çš„å‘å¸ƒ/è®¢é˜…ï¼ŒåŠ¨æ€å€¼çš„å˜æ›´ï¼Œä»¥æ­¤æŠŠç±»ä¸Šçš„å±æ€§çš„å€¼åšå˜æ›´ã€‚

#### 2. è‡ªå®šä¹‰æ³¨è§£å’Œä½¿ç”¨

```java
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.FIELD})
@Documented
public @interface DCCValue {

    String value() default "";

}

@Service
public class DCCService {

    /**
     * é™çº§å¼€å…³ 0å…³é—­ã€1å¼€å¯
     */
    @DCCValue("downgradeSwitch:0")
    private String downgradeSwitch;

    @DCCValue("cutRange:100")
    private String cutRange;

    public boolean isDowngradeSwitch() {
        return "1".equals(downgradeSwitch);
    }

    public boolean isCutRange(String userId) {
        // è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼
        int hashCode = Math.abs(userId.hashCode());

        // è·å–æœ€åä¸¤ä½
        int lastTwoDigits = hashCode % 100;

        // åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†…
        if (lastTwoDigits <= Integer.parseInt(cutRange)) {
            return true;
        }

        return false;
    }

}
```

- é¦–å…ˆï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ç±»ä¸­çš„å±æ€§é…ç½®çš„å€¼å›ºå®šçš„ï¼Œé…ç½®åä¸€ç›´åœ¨ç¨‹åºè¿è¡Œä¸­éƒ½æ˜¯ä¸€ä¸ªå€¼ã€‚
- é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸ºäº†å¯ä»¥è®©ç¨‹åºéšç€åŠŸèƒ½çš„éªŒè¯ï¼Œå¯ä»¥åŠ¨æ€çš„è°ƒæ•´è¿™äº›å±æ€§çš„å€¼ï¼Œå°±éœ€è¦å¼•å…¥ä¸€äº›æ‰‹æ®µï¼Œè¿™äº›æ‰‹æ®µçš„ç›®çš„å°±æ˜¯å¯ä»¥åŠ¨æ€è°ƒæ•´å±æ€§å€¼ã€‚é—®ï¼šJava ä¸­æ€ä¹ˆé€šè¿‡åå°„æ¥å¤„ç†å±æ€§å€¼çš„å˜æ›´ã€‚ç°åœ¨çš„å…«è‚¡ï¼Œæœ‰æ—¶å€™å°±æ˜¯ä»¥åœºæ™¯æé—®ï¼Œè€ƒå¯Ÿä½ æ˜¯å¦ä½¿ç”¨è¿‡ã€‚

#### 3. åŠ¨æ€å˜æ›´å±æ€§å€¼

```java
@Slf4j
@Configuration
public class DCCValueBeanFactory implements BeanPostProcessor {

    private static final String BASE_CONFIG_PATH = "group_buy_market_dcc_";

    private final RedissonClient redissonClient;

    private final Map<String, Object> dccObjGroup = new HashMap<>();

    public DCCValueBeanFactory(RedissonClient redissonClient) {
        this.redissonClient = redissonClient;
    }

    @Bean("dccTopic")
    public RTopic testRedisTopicListener(RedissonClient redissonClient) {
        RTopic topic = redissonClient.getTopic("group_buy_market_dcc");
        topic.addListener(String.class, (charSequence, s) -> {
            String[] split = s.split(Constants.SPLIT);

            // è·å–å€¼
            String attribute = split[0];
            String key = BASE_CONFIG_PATH + attribute;
            String value = split[1];

            // è®¾ç½®å€¼
            RBucket<String> bucket = redissonClient.getBucket(key);
            boolean exists = bucket.isExists();
            if (!exists) return;
            bucket.set(value);

            Object objBean = dccObjGroup.get(key);
            if (null == objBean) return;

            Class<?> objBeanClass = objBean.getClass();
            // æ£€æŸ¥ objBean æ˜¯å¦æ˜¯ä»£ç†å¯¹è±¡
            if (AopUtils.isAopProxy(objBean)) {
                // è·å–ä»£ç†å¯¹è±¡çš„ç›®æ ‡å¯¹è±¡
                objBeanClass = AopUtils.getTargetClass(objBean);
            }

            try {
                // 1. getDeclaredField æ–¹æ³•ç”¨äºè·å–æŒ‡å®šç±»ä¸­å£°æ˜çš„æ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬ç§æœ‰å­—æ®µã€å—ä¿æŠ¤å­—æ®µå’Œå…¬å…±å­—æ®µã€‚
                // 2. getField æ–¹æ³•ç”¨äºè·å–æŒ‡å®šç±»ä¸­çš„å…¬å…±å­—æ®µï¼Œå³åªèƒ½è·å–åˆ°å…¬å…±è®¿é—®ä¿®é¥°ç¬¦ï¼ˆpublicï¼‰çš„å­—æ®µã€‚
                Field field = objBeanClass.getDeclaredField(attribute);
                field.setAccessible(true);
                field.set(objBean, value);
                field.setAccessible(false);

                log.info("DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}", key, value);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        });
        return topic;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        // æ³¨æ„ï¼›å¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿå˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—åˆ°è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº†ã€‚
        Class<?> targetBeanClass = bean.getClass();
        Object targetBeanObject = bean;
        if (AopUtils.isAopProxy(bean)) {
            targetBeanClass = AopUtils.getTargetClass(bean);
            targetBeanObject = AopProxyUtils.getSingletonTarget(bean);
        }

        Field[] fields = targetBeanClass.getDeclaredFields();
        for (Field field : fields) {
            if (!field.isAnnotationPresent(DCCValue.class)) {
                continue;
            }

            DCCValue dccValue = field.getAnnotation(DCCValue.class);

            String value = dccValue.value();
            if (StringUtils.isBlank(value)) {
                throw new RuntimeException(field.getName() + " @DCCValue is not config value config case ã€ŒisSwitch/isSwitch:1ã€");
            }

            String[] splits = value.split(":");
            String key = BASE_CONFIG_PATH.concat(splits[0]);
            String defaultValue = splits.length == 2 ? splits[1] : null;

            // è®¾ç½®å€¼
            String setValue = defaultValue;

            try {
                // å¦‚æœä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸
                if (StringUtils.isBlank(defaultValue)) {
                    throw new RuntimeException("dcc config error " + key + " is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼");
                }

                // Redis æ“ä½œï¼Œåˆ¤æ–­é…ç½®Keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™è·å–æœ€æ–°å€¼
                RBucket<String> bucket = redissonClient.getBucket(key);
                boolean exists = bucket.isExists();
                if (!exists) {
                    bucket.set(defaultValue);
                } else {
                    setValue = bucket.get();
                }

                field.setAccessible(true);
                field.set(targetBeanObject, setValue);
                field.setAccessible(false);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }

            dccObjGroup.put(key, targetBeanObject);
        }

        return bean;
    }

}
```

- DCCValueBeanFactory å®ç°äº† BeanPostProcessorï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ° Spring æ‰€æœ‰å®ä¾‹åŒ–åçš„ Bean å¯¹è±¡ã€‚*Spring æ˜¯æ‰«æä½ æ‰€å·¥ç¨‹ä¸‹æ‰€æœ‰çš„ Bean å¯¹è±¡ï¼ŒåŠ è½½åˆ°å®ƒçš„å®¹å™¨é‡Œç®¡ç†ã€‚*
- `postProcessAfterInitialization` æ‰«ææ‰€æœ‰çš„ Bean å¯¹è±¡ï¼Œä¹‹åæ£€æŸ¥å“ªä¸ªç±»çš„å±æ€§åŠ æœ‰ `@DCCValue` æ³¨è§£ï¼Œæ£€æµ‹åˆ°åè¿›è¡Œç®¡ç†æ“ä½œã€‚
- `@DCCValue("downgradeSwitch:0")` è§£æè‡ªå®šä¹‰æ³¨è§£é…ç½®å€¼ï¼Œä¸€ä¸ªæ˜¯keyï¼Œä¸€ä¸ªæ˜¯é»˜è®¤çš„å€¼ã€‚ä¹‹åä¼šä» redis è·å–å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™èµ°é»˜è®¤å€¼ã€‚
- `testRedisTopicListener` æ˜¯ä¸€ä¸ªç›‘å¬ redis å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯çš„å¤„ç†ï¼Œä¹‹ååŠ¨æ€è®¾ç½® Redis å€¼ï¼Œå®Œäº‹åæ›´æ–°ç±»ä¸­ Redis çš„å±æ€§å€¼ã€‚

#### 4. å¼€å…³èŠ‚ç‚¹ä½¿ç”¨

```java
@Service
public class SwitchNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> {

    @Resource
    private MarketNode marketNode;

    @Override
    public TrialBalanceEntity doApply(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-SwitchNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

        // æ ¹æ®ç”¨æˆ·IDåˆ‡é‡
        String userId = requestParameter.getUserId();

        // åˆ¤æ–­æ˜¯å¦é™çº§
        if (repository.downgradeSwitch()) {
            log.info("æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}", userId);
            throw new AppException(ResponseCode.E0003.getCode(), ResponseCode.E0003.getInfo());
        }

        // åˆ‡é‡èŒƒå›´åˆ¤æ–­
        if (!repository.cutRange(userId)) {
            log.info("æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}", userId);
            throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo());
        }

        return router(requestParameter, dynamicContext);
    }

    @Override
    public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
        return marketNode;
    }

}
```

- è¿›å…¥å¼€å…³èŠ‚ç‚¹ï¼Œé€šè¿‡ä»“å‚¨ repository è·å–å¯¹åº”çš„å€¼ã€‚
- repository.downgradeSwitch() åˆ¤æ–­æ˜¯å¦é™çº§ã€‚
- repository.cutRange(userId) é€šè¿‡ç”¨æˆ·IDçš„å“ˆå¸Œå€¼æœ€å2ä½ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨100èŒƒå›´å†…ï¼Œä»¥æ­¤åšåˆ‡é‡å¤„ç†ã€‚



## [ç¬¬2-9èŠ‚ï¼šæ‹¼å›¢äº¤æ˜“è¥é”€é”å•](https://wx.zsxq.com/group/48411118851818/topic/5121482815558814)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-9èŠ‚ï¼šæ‹¼å›¢äº¤æ˜“è¥é”€é”å•](https://articles.zsxq.com/id_ek2pwwbf3mx5.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

å½“å•†åŸç±»ç³»ç»Ÿæ¥å…¥æ‹¼å›¢æ—¶ï¼Œåˆ™éœ€è¦åœ¨ä¸‹å•è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ç¬”è¥é”€ä¼˜æƒ ã€‚è¿™é‡Œçš„è¥é”€ä¼˜æƒ å¯ä»¥ä¸ºï¼›æ— åˆ¸å¹³å°è¥é”€ã€æœ‰åˆ¸æ¶ˆè´¹è¥é”€ã€æ‹¼å›¢æŠ˜æ‰£è¥é”€ã€ç§¯åˆ†æŠµæ‰£è¥é”€ç­‰ã€‚

é‚£ä¹ˆï¼Œå½“å•†åŸç±»ç³»ç»Ÿæ¥å…¥ä½¿ç”¨ä¸‹å•æ—¶ï¼Œåˆ™éœ€è¦åˆ°æ‹¼å›¢ç³»ç»Ÿé”å®šä¸€ç¬”ä¼˜æƒ ï¼Œä¹Ÿå°±æ˜¯å ç”¨ä¸€ä¸ªåé¢ã€‚å®Œäº‹åï¼Œå•†åŸç±»ç³»ç»Ÿç»§ç»­æ“ä½œæ”¯ä»˜äº¤æ˜“çš„è¿‡ç¨‹ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

![group-buy-market-2-9-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Frg-Nnr2SKl38_eXQhWiyjTGNSY9.png)

- é¦–å…ˆï¼Œå›¢è´­çš„å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€åˆ¸ï¼‰ã€åˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚
- é‚£ä¹ˆï¼Œè¿™é‡Œç”¨æˆ·ä»¥æ‹¼å›¢æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥åˆ›å»ºæ”¯ä»˜å•äº†ï¼ˆæ”¯ä»˜å•éœ€è¦æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ï¼‰ã€‚
- æ³¨æ„ï¼Œæ‹¼å›¢è¡¨ group_buy_order é™¤äº†æœ‰ç›®æ ‡é‡ï¼ˆtarget_countï¼‰ã€å®Œæˆé‡ï¼ˆcompleteï¼‰ï¼Œè¿˜è¦æœ‰ä¸€ä¸ªé”å•é‡ï¼ˆlock_countï¼‰ï¼Œå½“é”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œç”¨æˆ·åœ¨æ­¤ç»„ç»‡ä¸‹ï¼Œä¸èƒ½åœ¨å‚ä¸æ‹¼å›¢ã€‚ç›´è‡³è¿™äº›ç”¨æˆ·æ”¯ä»˜å®Œæˆè¾¾æˆæ‹¼å›¢æˆ–è€…é”å•è¶…æ—¶å›é€€æ”¯ä»˜è¥é”€ï¼Œç©ºå‡ºå¯å‚ä¸é”å•é‡ï¼Œè¿™æ ·å…¶ä»–ç”¨æˆ·å¯ä»¥ç»§ç»­å‚ä¸ã€‚

### ä¸‰ã€ç¼–ç¨‹å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-9-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FguySlGKZ1O50rUCSKt7j08AktoT.png)

- æ­¥éª¤1ï¼›æ·»åŠ æ•°æ®åº“DAOé…ç½®ï¼Œæ‹¼å›¢è®¢å•ã€æ‹¼å›¢æ˜ç»†æ“ä½œã€‚ä¹‹åäº¤ç»™ repository ä»“å‚¨ä½¿ç”¨ã€‚
- æ­¥éª¤2ï¼›domain é¢†åŸŸå±‚å®ç°äº¤æ˜“è®¢å•æœåŠ¡ï¼Œåˆ›å»ºæ‹¼å›¢é”å•æ“ä½œï¼Œä»¥åŠæŸ¥è¯¢ã€‚
- æ­¥éª¤3ï¼›trigger å±‚æä¾›æ‹¼å›¢äº¤æ˜“æ¥å£æœåŠ¡ï¼Œè¿™é‡Œä¼šä¸²è” activityã€trade ä¸¤ä¸ªé¢†åŸŸæœåŠ¡ã€‚ç›®å‰çš„ trigger æ›¿ä»£äº†ä¸€éƒ¨åˆ† case å±‚çš„ç¼–æ’æ“ä½œï¼Œå¦‚æœæ˜¯è¾ƒå¤§è§„æ¨¡çš„ç³»ç»Ÿï¼Œåˆ™å¯ä»¥å•ç‹¬æä¾›ä¸€ä¸ª case å±‚ã€‚

#### 2. åº“è¡¨æ›´æ–°

![group-buy-market-2-9-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FlYcRwryHxdPny1gtRuRp6W3ymvH.png)

- é¦–å…ˆï¼Œæ–°å¢åŠ ä¸¤å¼ è¡¨ï¼›group_buy_orderã€group_buy_order_list ä½ å¯ä»¥ä»å·¥ç¨‹ä¸‹ docs/dev-ops/mysq/sql æ›´æ–°å³å¯ã€‚
- æ³¨æ„ï¼Œåº“è¡¨è®¾è®¡ä¸­ï¼Œæ·»åŠ äº† team_idã€lock_countï¼Œä»¥åŠåšäº†ç»†åŒ–çš„å¤„ç†ã€‚å¦‚æœä½ å‰é¢å­¦ä¹ åº“è¡¨è®¾è®¡ï¼Œä¹‹åæœ‰äº†æ·±å…¥çš„ç†è§£ï¼Œé‚£ä¹ˆå¯¹è¿™æ ·çš„è®¾è®¡ä¼šæœ‰æ›´æ·±çš„ç†è§£ã€‚

#### 3. åŸºç¡€æ“ä½œ

```java
@Mapper
public interface IGroupBuyOrderDao {

    void insert(GroupBuyOrder groupBuyOrder);

    int updateAddLockCount(String teamId);

    int updateSubtractionLockCount(String teamId);

    GroupBuyOrder queryGroupBuyProgress(String teamId);

}

@Mapper
public interface IGroupBuyOrderListDao {

    void insert(GroupBuyOrderList groupBuyOrderListReq);

    GroupBuyOrderList queryGroupBuyOrderRecordByOutTradeNo(GroupBuyOrderList groupBuyOrderListReq);

}
```

ç»™2ä¸ªæ–°è¡¨æä¾›æ–°çš„ DAO æ“ä½œï¼›

- IGroupBuyOrderDao æ’å…¥æ•°æ®ã€æ›´æ–°é”å•é‡ã€æŸ¥è¯¢è¿›åº¦ã€‚
- IGroupBuyOrderListDao æ’å…¥æ‹¼å•æ˜ç»†ã€æŸ¥è¯¢äº¤æ˜“è®°å½•ã€‚

#### 4. äº¤æ˜“è®¢å•

```java
@Slf4j
@Service
public class TradeOrderService implements ITradeOrderService {

    @Resource
    private ITradeRepository repository;

    @Override
    public MarketPayOrderEntity queryNoPayMarketPayOrderByOutTradeNo(String userId, String outTradeNo) {
        log.info("æ‹¼å›¢äº¤æ˜“-æŸ¥è¯¢æœªæ”¯ä»˜è¥é”€è®¢å•:{} outTradeNo:{}", userId, outTradeNo);
        return repository.queryMarketPayOrderEntityByOutTradeNo(userId, outTradeNo);
    }

    @Override
    public GroupBuyProgressVO queryGroupBuyProgress(String teamId) {
        log.info("æ‹¼å›¢äº¤æ˜“-æŸ¥è¯¢æ‹¼å•è¿›åº¦:{}", teamId);
        return repository.queryGroupBuyProgress(teamId);
    }

    @Override
    public MarketPayOrderEntity lockMarketPayOrder(UserEntity userEntity, PayActivityEntity payActivityEntity, PayDiscountEntity payDiscountEntity) {
        log.info("æ‹¼å›¢äº¤æ˜“-é”å®šè¥é”€ä¼˜æƒ æ”¯ä»˜è®¢å•:{} activityId:{} goodsId:{}", userEntity.getUserId(), payActivityEntity.getActivityId(), payDiscountEntity.getGoodsId());

        // æ„å»ºèšåˆå¯¹è±¡
        GroupBuyOrderAggregate groupBuyOrderAggregate = GroupBuyOrderAggregate.builder()
                .userEntity(userEntity)
                .payActivityEntity(payActivityEntity)
                .payDiscountEntity(payDiscountEntity)
                .build();

        // é”å®šèšåˆè®¢å• - è¿™ä¼šç”¨æˆ·åªæ˜¯ä¸‹å•è¿˜æ²¡æœ‰æ”¯ä»˜ã€‚åç»­ä¼šæœ‰2ä¸ªæµç¨‹ï¼›æ”¯ä»˜æˆåŠŸã€è¶…æ—¶æœªæ”¯ä»˜ï¼ˆå›é€€ï¼‰
        return repository.lockMarketPayOrder(groupBuyOrderAggregate);
    }

}
```

- åœ¨äº¤æ˜“è®¢å•ä¸­æä¾›æŸ¥è¯¢ï¼ŒåŒ…æ‹¬ï¼›æœªæ”¯ä»˜è¥é”€è®¢å•ã€æŸ¥è¯¢æ‹¼å•è¿›åº¦å’Œé”å®šè¥é”€ä¼˜æƒ æ”¯ä»˜è®¢å•ã€‚
- åœ¨ lockMarketPayOrder æœ‰æ•°æ®åº“äº‹åŠ¡æ“ä½œã€‚

```java
@Transactional(timeout = 500)
@Override
public MarketPayOrderEntity lockMarketPayOrder(GroupBuyOrderAggregate groupBuyOrderAggregate) {
    // èšåˆå¯¹è±¡ä¿¡æ¯
    UserEntity userEntity = groupBuyOrderAggregate.getUserEntity();
    PayActivityEntity payActivityEntity = groupBuyOrderAggregate.getPayActivityEntity();
    PayDiscountEntity payDiscountEntity = groupBuyOrderAggregate.getPayDiscountEntity();
    // åˆ¤æ–­æ˜¯å¦æœ‰å›¢ - teamId ä¸ºç©º - æ–°å›¢ã€ä¸ºä¸ç©º - è€å›¢
    String teamId = payActivityEntity.getTeamId();
    if (StringUtils.isBlank(teamId)) {
        // ä½¿ç”¨ RandomStringUtils.randomNumeric æ›¿ä»£å…¬å¸é‡Œä½¿ç”¨çš„é›ªèŠ±ç®—æ³•UUID
        teamId = RandomStringUtils.randomNumeric(8);
        // æ„å»ºæ‹¼å›¢è®¢å•
        GroupBuyOrder groupBuyOrder = GroupBuyOrder.builder()
                .teamId(teamId)
                .activityId(payActivityEntity.getActivityId())
                .source(payDiscountEntity.getSource())
                .channel(payDiscountEntity.getChannel())
                .originalPrice(payDiscountEntity.getOriginalPrice())
                .deductionPrice(payDiscountEntity.getDeductionPrice())
                .payPrice(payDiscountEntity.getDeductionPrice().subtract(payDiscountEntity.getDeductionPrice()))
                .targetCount(payActivityEntity.getTargetCount())
                .completeCount(0)
                .lockCount(1)
                .build();
        // å†™å…¥è®°å½•
        groupBuyOrderDao.insert(groupBuyOrder);
    } else {
        // æ›´æ–°è®°å½• - å¦‚æœæ›´æ–°è®°å½•ä¸ç­‰äº1ï¼Œåˆ™è¡¨ç¤ºæ‹¼å›¢å·²æ»¡ï¼ŒæŠ›å‡ºå¼‚å¸¸
        int updateAddTargetCount = groupBuyOrderDao.updateAddLockCount(teamId);
        if (1 != updateAddTargetCount) {
            throw new AppException(ResponseCode.E0005);
        }
    }
    // ä½¿ç”¨ RandomStringUtils.randomNumeric æ›¿ä»£å…¬å¸é‡Œä½¿ç”¨çš„é›ªèŠ±ç®—æ³•UUID
    String orderId = RandomStringUtils.randomNumeric(12);
    GroupBuyOrderList groupBuyOrderListReq = GroupBuyOrderList.builder()
            .userId(userEntity.getUserId())
            .teamId(teamId)
            .orderId(orderId)
            .activityId(payActivityEntity.getActivityId())
            .startTime(payActivityEntity.getStartTime())
            .endTime(payActivityEntity.getEndTime())
            .goodsId(payDiscountEntity.getGoodsId())
            .source(payDiscountEntity.getSource())
            .channel(payDiscountEntity.getChannel())
            .originalPrice(payDiscountEntity.getDeductionPrice())
            .deductionPrice(payDiscountEntity.getDeductionPrice())
            .status(TradeOrderStatusEnumVO.CREATE.getCode())
            .outTradeNo(payDiscountEntity.getOutTradeNo())
            .build();
    try {
        // å†™å…¥æ‹¼å›¢è®°å½•
        groupBuyOrderListDao.insert(groupBuyOrderListReq);
    } catch (DuplicateKeyException e) {
        throw new AppException(ResponseCode.INDEX_EXCEPTION);
    }
    return MarketPayOrderEntity.builder()
            .orderId(orderId)
            .deductionPrice(payDiscountEntity.getDeductionPrice())
            .tradeOrderStatusEnumVO(TradeOrderStatusEnumVO.CREATE)
            .build();
}
```

* group_buy_orderã€group_buy_order_listï¼Œä¸¤ä¸ªåº“è¡¨ä¸€ä¸ªå†™å…¥è®°å½•ï¼Œä¸€ä¸ªæ›´æ–°è®°å½•ã€‚éœ€è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆæ“ä½œã€‚

#### 5. æœåŠ¡æ¥å£

```java
@Slf4j
@RestController()
@CrossOrigin("*")
@RequestMapping("/api/v1/gbm/trade/")
public class MarketTradeController implements IMarketTradeService {

    @Resource
    private IIndexGroupBuyMarketService indexGroupBuyMarketService;

    @Resource
    private ITradeOrderService tradeOrderService;

    @Override
    public Response<LockMarketPayOrderResponseDTO> lockMarketPayOrder(LockMarketPayOrderRequestDTO lockMarketPayOrderRequestDTO) {
        try {
            // å‚æ•°
            String userId = lockMarketPayOrderRequestDTO.getUserId();
            String source = lockMarketPayOrderRequestDTO.getSource();
            String channel = lockMarketPayOrderRequestDTO.getChannel();
            String goodsId = lockMarketPayOrderRequestDTO.getGoodsId();
            Long activityId = lockMarketPayOrderRequestDTO.getActivityId();
            String outTradeNo = lockMarketPayOrderRequestDTO.getOutTradeNo();
            String teamId = lockMarketPayOrderRequestDTO.getTeamId();

            log.info("è¥é”€äº¤æ˜“é”å•:{} LockMarketPayOrderRequestDTO:{}", userId, JSON.toJSONString(lockMarketPayOrderRequestDTO));

            if (StringUtils.isBlank(userId) || StringUtils.isBlank(source) || StringUtils.isBlank(channel) || StringUtils.isBlank(goodsId) || StringUtils.isBlank(goodsId) || null == activityId) {
                return Response.<LockMarketPayOrderResponseDTO>builder()
                        .code(ResponseCode.ILLEGAL_PARAMETER.getCode())
                        .info(ResponseCode.ILLEGAL_PARAMETER.getInfo())
                        .build();
            }

            // æŸ¥è¯¢ outTradeNo æ˜¯å¦å·²ç»å­˜åœ¨äº¤æ˜“è®°å½•
            MarketPayOrderEntity marketPayOrderEntity = tradeOrderService.queryNoPayMarketPayOrderByOutTradeNo(userId, outTradeNo);
            if (null != marketPayOrderEntity) {
                LockMarketPayOrderResponseDTO lockMarketPayOrderResponseDTO = LockMarketPayOrderResponseDTO.builder()
                        .orderId(marketPayOrderEntity.getOrderId())
                        .deductionPrice(marketPayOrderEntity.getDeductionPrice())
                        .tradeOrderStatus(marketPayOrderEntity.getTradeOrderStatusEnumVO().getCode())
                        .build();

                log.info("äº¤æ˜“é”å•è®°å½•(å­˜åœ¨):{} marketPayOrderEntity:{}", userId, JSON.toJSONString(marketPayOrderEntity));
                return Response.<LockMarketPayOrderResponseDTO>builder()
                        .code(ResponseCode.SUCCESS.getCode())
                        .info(ResponseCode.SUCCESS.getInfo())
                        .data(lockMarketPayOrderResponseDTO)
                        .build();
            }

            // åˆ¤æ–­æ‹¼å›¢æ˜¯å¦å®Œæˆäº†ç›®æ ‡
            if (null != teamId) {
                GroupBuyProgressVO groupBuyProgressVO = tradeOrderService.queryGroupBuyProgress(teamId);
                if (null != groupBuyProgressVO && Objects.equals(groupBuyProgressVO.getTargetCount(), groupBuyProgressVO.getLockCount())) {
                    log.info("äº¤æ˜“é”å•æ‹¦æˆª-æ‹¼å•ç›®æ ‡å·²è¾¾æˆ:{} {}", userId, teamId);
                    return Response.<LockMarketPayOrderResponseDTO>builder()
                            .code(ResponseCode.E0006.getCode())
                            .info(ResponseCode.E0006.getInfo())
                            .build();
                }
            }

            // è¥é”€ä¼˜æƒ è¯•ç®—
            TrialBalanceEntity trialBalanceEntity = indexGroupBuyMarketService.indexMarketTrial(MarketProductEntity.builder()
                    .userId(userId)
                    .source(source)
                    .channel(channel)
                    .goodsId(goodsId)
                    .activityId(activityId)
                    .build());

            GroupBuyActivityDiscountVO groupBuyActivityDiscountVO = trialBalanceEntity.getGroupBuyActivityDiscountVO();

            // é”å•
            marketPayOrderEntity = tradeOrderService.lockMarketPayOrder(
                    UserEntity.builder().userId(userId).build(),
                    PayActivityEntity.builder()
                            .teamId(teamId)
                            .activityId(activityId)
                            .activityName(groupBuyActivityDiscountVO.getActivityName())
                            .startTime(groupBuyActivityDiscountVO.getStartTime())
                            .endTime(groupBuyActivityDiscountVO.getEndTime())
                            .targetCount(groupBuyActivityDiscountVO.getTarget())
                            .build(),
                    PayDiscountEntity.builder()
                            .source(source)
                            .channel(channel)
                            .goodsId(goodsId)
                            .goodsName(trialBalanceEntity.getGoodsName())
                            .originalPrice(trialBalanceEntity.getOriginalPrice())
                            .deductionPrice(trialBalanceEntity.getDeductionPrice())
                            .outTradeNo(outTradeNo)
                            .build());

            log.info("äº¤æ˜“é”å•è®°å½•(æ–°):{} marketPayOrderEntity:{}", userId, JSON.toJSONString(marketPayOrderEntity));

            // è¿”å›ç»“æœ
            return Response.<LockMarketPayOrderResponseDTO>builder()
                    .code(ResponseCode.SUCCESS.getCode())
                    .info(ResponseCode.SUCCESS.getInfo())
                    .data(LockMarketPayOrderResponseDTO.builder()
                            .orderId(marketPayOrderEntity.getOrderId())
                            .deductionPrice(marketPayOrderEntity.getDeductionPrice())
                            .tradeOrderStatus(marketPayOrderEntity.getTradeOrderStatusEnumVO().getCode())
                            .build())
                    .build();
        } catch (AppException e) {
            log.error("è¥é”€äº¤æ˜“é”å•ä¸šåŠ¡å¼‚å¸¸:{} LockMarketPayOrderRequestDTO:{}", lockMarketPayOrderRequestDTO.getUserId(), JSON.toJSONString(lockMarketPayOrderRequestDTO), e);
            return Response.<LockMarketPayOrderResponseDTO>builder()
                    .code(e.getCode())
                    .info(e.getInfo())
                    .build();
        } catch (Exception e) {
            log.error("è¥é”€äº¤æ˜“é”å•æœåŠ¡å¤±è´¥:{} LockMarketPayOrderRequestDTO:{}", lockMarketPayOrderRequestDTO.getUserId(), JSON.toJSONString(lockMarketPayOrderRequestDTO), e);
            return Response.<LockMarketPayOrderResponseDTO>builder()
                    .code(ResponseCode.UN_ERROR.getCode())
                    .info(ResponseCode.UN_ERROR.getInfo())
                    .build();
        }
    }

}
```

- é¦–å…ˆï¼Œéœ€è¦æŸ¥è¯¢å¤–éƒ¨äº¤æ˜“ outTradeNo æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ã€‚å¦‚æœå­˜åœ¨æœªå®Œæˆçš„è®¢å•ï¼Œç›´æ¥è¿”å›ç»“æœå³å¯ã€‚è¿™ä¸ªæ˜¯å¹‚ç­‰çš„ä¸€ä¸ªé˜²æŠ¤ã€‚å¦‚æœä¸æŸ¥è¯¢ï¼Œæœ€ç»ˆä¹Ÿæ˜¯ä¼šæœ‰æ•°æ®åº“å”¯ä¸€ç´¢å¼•æ‹¦æˆªã€‚
- ä¹‹åï¼Œåˆ¤æ–­æ‹¼å›¢é”å•æ˜¯å¦å®Œæˆç›®æ ‡é‡ï¼Œå¦‚æœå·²ç»å®Œæˆäº†ç›®æ ‡é‡åˆ™ç›´æ¥ç›´æ¥è¿”å›ï¼Œè®©ç”¨æˆ·ä¸èƒ½å‚ä¸å½“å‰æ‹¼å›¢ã€‚ä¸€èˆ¬åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚æœå¤šäººé€‰æ‹©ä¸€ä¸ªæ‹¼å›¢ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ‹¼å›¢é‡å¯ä»¥æœ‰æ•ˆæ‹¦æˆªã€‚å¦‚æœæ²¡æœ‰æ‹¦æˆªï¼Œæœ€ç»ˆè®¿é—®æ•°æ®ï¼Œä¹Ÿä¼šæœ‰æ•°é‡åˆ¤æ–­æ‹¦æˆªã€‚æ³¨æ„è¿™é‡Œä¼šæœ‰æ•°æ®åº“è¡¨çš„è¡Œçº§é”ï¼Œå¦‚æœtpsé‡å¤§ï¼Œé‚£ä¹ˆåˆ™éœ€è¦åŠ å…¥ redis æ“ä½œåº“å­˜é‡ã€‚
- ä¹‹åï¼Œå¼€å§‹åšè¥é”€ä¼˜æƒ è¯•ç®—ã€‚åˆ¤æ–­å½“å‰å•†å“åœ¨æ‹¼å›¢ä¸‹åº”è¯¥ä¼˜æƒ å¤šå°‘ã€‚ç¡®è®¤å®Œä¼˜æƒ åï¼Œå¼€å§‹é”å•ã€‚æœ€ç»ˆè¿”å›ç»™ç”¨æˆ·åˆ°ç•Œé¢å±•ç¤ºï¼Œç”¨æˆ·ç¡®è®¤äº†æ”¯ä»˜æ‰€ç”¨åˆ°çš„è¥é”€ä¼˜æƒ ï¼Œé‚£ä¹ˆåœ¨ç‚¹å‡»ç¡®è®¤æ”¯ä»˜è·³è½¬æ”¶é“¶å°æ‰«ç æ”¯ä»˜å³å¯ã€‚



## [ç¬¬2-10èŠ‚ï¼šè´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡](https://wx.zsxq.com/group/48411118851818/topic/2858155158111451)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-10èŠ‚ï¼šè´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡](https://articles.zsxq.com/id_o7tll9alwbnx.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

åœ¨æ‹¼å›¢äº¤æ˜“çš„ä¸‹å•é”å®šä¼˜æƒ çš„è¿‡ç¨‹ä¸­ï¼Œä»¥åŠåç»­çš„æµç¨‹ï¼Œéƒ½ä¼šæœ‰ç®€å•çš„è§„åˆ™ä¸²è”ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆæ¥æå‰åšå¥½é€šç”¨çš„è´£ä»»é“¾æ¨¡å‹ç»“æ„ï¼Œä¾¿äºåç»­ä½¿ç”¨ã€‚

æœ¬èŠ‚ä¼šæ¶‰åŠåˆ°é“¾è¡¨çš„åŸºç¡€æ•°æ®ç»“æ„çŸ¥è¯†ï¼Œå¯ä»¥æå‰è¡¥å……å­¦ä¹ ï¼›https://bugstack.cn/md/algorithm/data-structures/2022-07-22-linked-list.html

### äºŒã€æ¨¡å‹è®¾è®¡

è´£ä»»é“¾æ˜¯ä¸€ç§ç®€å•çš„å•é“¾è·¯ç»“æ„ï¼Œåœ¨å·¥ç¨‹ä¸­ä¼šæœ‰å¤šä¸ªè¿™æ ·çš„å•é“¾ï¼Œä¸ºäº†å¯ä»¥è®©ä¸åŒçš„åœºæ™¯éƒ½èƒ½åˆ›å»ºå‡ºè‡ªå·±çš„é“¾ï¼Œåˆ™éœ€è¦è§£è€¦è´£ä»»é“¾çš„é“¾è·¯å’Œæ‰§è¡Œï¼Œå†æœ‰æ‰§è¡Œå™¨å¤„ç†ã€‚åœ¨æœ¬æ¬¡å®ç°ä¸­å°å‚…å“¥ä¼šç»™å¤§å®¶ä½“ç»Ÿä¸¤ç§è´£ä»»é“¾ï¼Œè®©å¤§å®¶å¯¹ç…§å­¦ä¹ ã€‚è®¾è®¡å¦‚å›¾ï¼›

![group-buy-market-2-10-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FjxlzuyqkZkL9b-7GoZqciSd76p8.png)

- å¦‚å›¾ï¼Œè¿™æ˜¯ä¸€ç§å¤šå®ä¾‹å¯¹è±¡è´£ä»»é“¾çš„è®¾è®¡ç»“æ„ï¼Œä¼šä½¿ç”¨åˆ°å¦‚ Java JDK æºç ä¸­ Link çš„æ–¹å¼å¡«å†™é“¾è·¯ï¼Œä¹‹åå†æœ‰ä¸šåŠ¡é“¾è·¯å¤„ç†é“¾è·¯æ‰§è¡Œã€‚è€Œæ¯ä¸€ä¸ªé“¾è·¯éƒ½ä¼šè¢«å¡«å……ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨çš„å®ç°ç±»ï¼ˆILogicHandlerï¼‰æ¥å¤„ç†å…·ä½“çš„ä¸šåŠ¡ã€‚
- é‚£ä¹ˆï¼Œè¿™æ ·å°±å¾ˆå¥½çš„æ‰©å±•äº†å„ç§é“¾è·¯çš„ä½¿ç”¨è¯‰æ±‚ã€‚æˆ‘ä»¬å¯ä»¥ç»“åˆä»£ç æ¥å­¦ä¹ ã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-10-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FiEVX7-XF9KiotBbrQgc8lTTgKcw.png)

- åœ¨ types -> designï¼Œæä¾› link è´£ä»»é“¾ã€‚model1ã€model2
- model1ï¼Œæ˜¯é€šç”¨çš„å•ä¾‹é“¾ï¼Œæœ¬èº«æŠ½è±¡ç±»æ—¢å¯æ·»åŠ é“¾è·¯èŠ‚ç‚¹ï¼Œåˆèƒ½åšé“¾è·¯è¿‡ç¨‹æ‰§è¡Œå¤„ç†ã€‚
- model2ï¼Œæ‹†åˆ†äº†è´£ä»»é“¾å’Œæ‰§è¡Œå¤„ç†å™¨ï¼Œå¹¶ç”± LinkArmory è¿›è¡Œè£…é…ã€‚è¿™æ ·å°±å¯ä»¥å¡«å……å¤šä¾‹é“¾ã€‚

#### 2. å•ä¾‹é“¾è·¯

è¿™æ˜¯ä¸€å¥—ç®€å•çš„å•ä¾‹é“¾å¤„ç†ï¼›

```java
public interface ILogicChainArmory<T, D, R> {

    ILogicLink<T, D, R> next();

    ILogicLink<T, D, R> appendNext(ILogicLink<T, D, R> next);

}

public interface ILogicLink<T, D, R> extends ILogicChainArmory<T, D, R> {

    R apply(T requestParameter, D dynamicContext) throws Exception;

}

public abstract class AbstractLogicLink<T, D, R> implements ILogicLink<T, D, R> {

    private ILogicLink<T, D, R> next;

    @Override
    public ILogicLink<T, D, R> next() {
        return next;
    }

    @Override
    public ILogicLink<T, D, R> appendNext(ILogicLink<T, D, R> next) {
        this.next = next;
        return next;
    }

    protected R next(T requestParameter, D dynamicContext) throws Exception {
        return next.apply(requestParameter, dynamicContext);
    }

}
```

- 
  ILogicChainArmory è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹ã€‚
- ILogicLink ç»§æ‰¿ ILogicChainArmoryï¼Œå¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•ã€‚
- AbstractLogicLink çš„è¿‡ç¨‹æ˜¯å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•ã€‚

é‚£ä¹ˆï¼Œè¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„ç±»ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ `ILogicLink<T, D, R> next `è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚

#### 3. å¤šä¾‹é“¾è·¯

å¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚

##### 3.1 é“¾è¡¨æ¥å£

```java
public interface ILink<E> {

    boolean add(E e);

    boolean addFirst(E e);

    boolean addLast(E e);

    boolean remove(Object o);

    E get(int index);

    void printLinkList();

}
```

##### 3.2 é“¾è¡¨å®ç°

```java
public class LinkedList<E> implements ILink<E> {

    /**
     * è´£ä»»é“¾åç§°
     */
    private final String name;

    transient int size = 0;

    transient Node<E> first;

    transient Node<E> last;

    public LinkedList(String name) {
        this.name = name;
    }

    void linkFirst(E e) {
        final Node<E> f = first;
        final Node<E> newNode = new Node<>(null, e, f);
        first = newNode;
        if (f == null)
            last = newNode;
        else
            f.prev = newNode;
        size++;
    }

    void linkLast(E e) {
        final Node<E> l = last;
        final Node<E> newNode = new Node<>(l, e, null);
        last = newNode;
        if (l == null) {
            first = newNode;
        } else {
            l.next = newNode;
        }
        size++;
    }

    @Override
    public boolean add(E e) {
        linkLast(e);
        return true;
    }

    @Override
    public boolean addFirst(E e) {
        linkFirst(e);
        return true;
    }

    @Override
    public boolean addLast(E e) {
        linkLast(e);
        return true;
    }

    @Override
    public boolean remove(Object o) {
        if (o == null) {
            for (Node<E> x = first; x != null; x = x.next) {
                if (x.item == null) {
                    unlink(x);
                    return true;
                }
            }
        } else {
            for (Node<E> x = first; x != null; x = x.next) {
                if (o.equals(x.item)) {
                    unlink(x);
                    return true;
                }
            }
        }
        return false;
    }

    E unlink(Node<E> x) {
        final E element = x.item;
        final Node<E> next = x.next;
        final Node<E> prev = x.prev;

        if (prev == null) {
            first = next;
        } else {
            prev.next = next;
            x.prev = null;
        }

        if (next == null) {
            last = prev;
        } else {
            next.prev = prev;
            x.next = null;
        }

        x.item = null;
        size--;
        return element;
    }

    @Override
    public E get(int index) {
        return node(index).item;
    }

    Node<E> node(int index) {
        if (index < (size >> 1)) {
            Node<E> x = first;
            for (int i = 0; i < index; i++)
                x = x.next;
            return x;
        } else {
            Node<E> x = last;
            for (int i = size - 1; i > index; i--)
                x = x.prev;
            return x;
        }
    }

    public void printLinkList() {
        if (this.size == 0) {
            System.out.println("é“¾è¡¨ä¸ºç©º");
        } else {
            Node<E> temp = first;
            System.out.print("ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š" + first.item + " å°¾èŠ‚ç‚¹ï¼š" + last.item + " æ•´ä½“ï¼š");
            while (temp != null) {
                System.out.print(temp.item + "ï¼Œ");
                temp = temp.next;
            }
            System.out.println();
        }
    }

    protected static class Node<E> {

        E item;
        Node<E> next;
        Node<E> prev;

        public Node(Node<E> prev, E element, Node<E> next) {
            this.item = element;
            this.next = next;
            this.prev = prev;
        }

    }

    public String getName() {
        return name;
    }

}
```

è¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒæ•°æ®ç»“æ„ï¼šhttps://bugstack.cn/md/algorithm/data-structures/2022-07-22-linked-list.html

##### 3.3 ä¸šåŠ¡é“¾è·¯

```java
public class BusinessLinkedList<T, D, R> extends LinkedList<ILogicHandler<T, D, R>> implements ILogicHandler<T, D, R> {

    public BusinessLinkedList(String name) {
        super(name);
    }

    @Override
    public R apply(T requestParameter, D dynamicContext) throws Exception {
        Node<ILogicHandler<T, D, R>> current = this.first;
        do {
            ILogicHandler<T, D, R> item = current.item;
            R apply = item.apply(requestParameter, dynamicContext);
            if (null != apply) return apply;

            current = current.next;
        } while (null != current);

        return null;
    }

}

public interface ILogicHandler<T, D, R> {

    default R next(T requestParameter, D dynamicContext) {
        return null;
    }

    R apply(T requestParameter, D dynamicContext) throws Exception;

}
```

- BusinessLinkedList å­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†å—ç†ä¸šåŠ¡æµç¨‹ï¼Œå¾ªç¯éå†è´£ä»»é“¾ã€‚éå†çš„è¿‡ç¨‹ä¸åªæ˜¯è¿™æ ·ï¼Œä¹Ÿå¯ä»¥å®ç° Iterable æ¥å¤„ç†ã€‚
- éå†çš„è¿‡ç¨‹ä¼šä»¥ apply æ˜¯å¦ä¸ºç©ºå’Œé“¾è·¯æ˜¯å¦èµ°åˆ°æœ€åæ¥åˆ¤æ–­ã€‚apply ä¸ºç©ºåˆ™è¡¨ç¤ºå½“å‰ ILogicHandler å®ç°çš„èŠ‚ç‚¹çš„ä¸šåŠ¡æµç¨‹ä¸ºç©ºï¼Œæ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

##### 3.4 é“¾è·¯è£…é…

```java
public class LinkArmory<T, D, R> {

    private final BusinessLinkedList<T, D, R> logicLink;

    @SafeVarargs
    public LinkArmory(String linkName, ILogicHandler<T, D, R>... logicHandlers) {
        logicLink = new BusinessLinkedList<>(linkName);
        for (ILogicHandler<T, D, R> logicHandler: logicHandlers){
            logicLink.add(logicHandler);
        }
    }

    public BusinessLinkedList<T, D, R> getLogicLink() {
        return logicLink;
    }

}
```

* æä¾›ä¸€ä¸ªé“¾è·¯è£…é…å™¨ï¼Œè®©è°ƒç”¨æ–¹è‡ªè¡Œè£…é…å¤„ç†ã€‚



## [ç¬¬2-11èŠ‚ï¼šäº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤](https://wx.zsxq.com/group/48411118851818/topic/8858152248121822)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-11èŠ‚ï¼šäº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤](https://articles.zsxq.com/id_pr3utfa4bw4f.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

å®Œå–„æ‹¼å›¢äº¤æ˜“è¥é”€é”å•çš„æµç¨‹ï¼Œå¢åŠ é”å•æµç¨‹ä¸­çš„è§„åˆ™å¤„ç†ã€‚

æœ¬èŠ‚çš„è§„åˆ™è¿‡æ»¤ï¼Œä¼šä½¿ç”¨åˆ°å‰é¢ç« èŠ‚è®¾è®¡çš„ç»Ÿä¸€çš„è®¾è®¡æ¨¡å¼æ¡†æ¶ä¸­çš„è´£ä»»é“¾æ¨¡å¼ã€‚å¯¹è¿™ç±»è½»é‡çš„åœºæ™¯ï¼Œä¸€èˆ¬åªéœ€è¦é€‰æ‹©å•é“¾çš„æ‰§è¡Œæ¨¡å‹å³å¯ï¼Œè€Œä¸ä¹‹å¯¹æ¯”çš„è§„åˆ™æ ‘ï¼Œæ˜¯é€‚åˆäºé‚£ç§èŠ‚ç‚¹é—´çš„å¤æ‚åˆ†æ”¯æµè½¬ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼Œå¢åŠ äº¤æ˜“è§„åˆ™å¤„ç†ï¼›

![group-buy-market-2-11-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fqiev8kFGWaEu6NEcSm1qN7fIcSS.png)

![group-buy-market-2-11-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FjA9hx33vRGW7K5iRzkZ9yPveZmG.png)

- åœ¨å‰é¢ç« èŠ‚ï¼Œæˆ‘ä»¬å®ç°äº†æ‹¼å›¢é”å•ä¸­ï¼Œå‚æ•°æ ¡éªŒã€å¹‚ç­‰æ ¡éªŒã€è¾¾æˆæ ¡éªŒï¼Œä¹‹ååšäº†è¥é”€è¯•ç®—å’Œè¥é”€é”å•ã€‚
- é‚£ä¹ˆåœ¨æœ¬èŠ‚ï¼Œè¿˜éœ€è¦å¯¹è¥é”€é”å•ç»§ç»­å®Œå–„ï¼Œè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚åœ¨å®é™…å…¬å¸ä¸­çš„é¡¹ç›®é‡Œï¼Œè¿˜ä¼šæœ‰æ›´å¤šçš„è§„åˆ™è¦è¢«å¤„ç†ã€‚

### ä¸‰ã€ç¼–ç¨‹å®ç°

![group-buy-market-2-11-04.png](./æ‹¼å›¢é¡¹ç›®.assets/Fu-gW6Lxx_f5EIfyY5KYDyoXpuyQ.png)

* æœ¬èŠ‚å¯¹åº“è¡¨è¿›è¡Œäº†è°ƒæ•´ï¼Œæ–°å¢åŠ äº†å­—æ®µã€‚è®°å¾—ç”¨è¯¾ç¨‹ä»£ç ä¸‹ docs/dev-ops/mysql/sql ä¸‹çš„æ–‡ä»¶ï¼Œæ›´æ–°æ•°æ®åº“è¡¨ã€‚

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-11-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FleDkdWkRGno6n9EU7pCy5018PSF.png)

- æœ¬èŠ‚ä¼šå›´ç»• trade é¢†åŸŸå†… service æœåŠ¡ä¸‹çš„è§„åˆ™è¿›è¡Œå®ç°ã€‚å®ç°çš„è¿‡ç¨‹ä¼šä½¿ç”¨åˆ°å‰é¢ç« èŠ‚å®šä¹‰çš„è´£ä»»é“¾æ¨¡æ¿ã€‚
- æ³¨æ„ï¼›åœ¨å­¦ä¹ ä»£ç ä¸­ï¼ŒæŸ¥çœ‹å·¥ç¨‹ä¸­å°å‚…å“¥æäº¤ä»£ç çš„è®°å½•ï¼Œè¿™æ ·ä½ å¯ä»¥æ³¨æ„åˆ°å…¨éƒ¨ä»£ç å˜åŠ¨ç»†èŠ‚ã€‚

#### 2.åŠŸèƒ½ä¿®å¤ï¼ˆfixï¼‰

##### 2.1 è¥é”€ä¼˜æƒ è®°å½•æ”¯ä»˜é‡‘é¢

```java
BigDecimal payPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);
dynamicContext.setDeductionPrice(skuVO.getOriginalPrice().subtract(payPrice));
dynamicContext.setPayPrice(payPrice);
```

* ä¸ºäº†æ›´å¥½çš„ä½¿ç”¨æ‹¼å›¢è¥é”€è¯•ç®—ï¼Œæ˜ç¡®è¯•ç®—è¿”å›çš„ä¼˜æƒ æŠ˜æ‰£å’Œæ”¯ä»˜é‡‘é¢ï¼Œä¸ºæ­¤åœ¨ æ‹¼å›¢è¯•ç®— MarketNode èŠ‚ç‚¹ï¼Œå¢åŠ  payPrice å±æ€§å¡«å†™æ”¯ä»˜é‡‘é¢ã€‚

##### 2.2 è¥é”€ä¼˜æƒ è®¡ç®—ä½¿ç”¨äººç¾¤ID

```java
public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService {

    @Resource
    protected IActivityRepository repository;

    @Override
    public BigDecimal calculate(String userId, BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) {
        // 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤
        if (DiscountTypeEnum.TAG.equals(groupBuyDiscount.getDiscountType())){
            boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId());
            if (!isCrowdRange) {
                log.info("æŠ˜æ‰£ä¼˜æƒ è®¡ç®—æ‹¦æˆªï¼Œç”¨æˆ·ä¸å†ä¼˜æƒ äººç¾¤æ ‡ç­¾èŒƒå›´å†… userId:{}", userId);
                return originalPrice;
            }
        }
        // 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®—
        return doCalculate(originalPrice, groupBuyDiscount);
    }

    // äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ 
    private boolean filterTagId(String userId, String tagId) {
        return repository.isTagCrowdRange(tagId, userId);
    }

    protected abstract BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount);

}
```

* å®Œå–„ AbstractDiscountCalculateService#filterTagId ä¸­å¯¹äººç¾¤æ ‡ç­¾çš„ä½¿ç”¨ã€‚

#### 3. äº¤æ˜“è§„åˆ™æ¨¡å‹

##### 3.1 æ´»åŠ¨çš„å¯ç”¨æ€§

```java
@Slf4j
@Service
public class ActivityUsabilityRuleFilter implements ILogicHandler<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}", requestParameter.getUserId(), requestParameter.getActivityId());

        // æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨
        GroupBuyActivityEntity groupBuyActivity = repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId());

        // æ ¡éªŒï¼›æ´»åŠ¨çŠ¶æ€ - å¯ä»¥æŠ›ä¸šåŠ¡å¼‚å¸¸codeï¼Œæˆ–è€…æŠŠcodeå†™å…¥åˆ°åŠ¨æ€ä¸Šä¸‹æ–‡dynamicContextä¸­ï¼Œæœ€åè·å–ã€‚
        if (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivity.getStatus())) {
            log.info("æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0101);
        }

        // æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´
        Date currentTime = new Date();
        if (currentTime.before(groupBuyActivity.getStartTime()) || currentTime.after(groupBuyActivity.getEndTime())) {
            log.info("æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0102);
        }

        // å†™å…¥åŠ¨æ€ä¸Šä¸‹æ–‡
        dynamicContext.setGroupBuyActivity(groupBuyActivity);

        // èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹
        return next(requestParameter, dynamicContext);
    }

}
```

* æ´»åŠ¨å¯ç”¨æ€§è¿‡æ»¤æ´»åŠ¨çš„çŠ¶æ€å’Œæ—¶é—´ã€‚ä¹‹åæŠŠæ´»åŠ¨æ•°æ®å†™å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚

##### 3.2 ç”¨æˆ·å‚ä¸é™åˆ¶

```java
@Slf4j
@Service
public class UserTakeLimitRuleFilter implements ILogicHandler<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId:{}", requestParameter.getUserId(), requestParameter.getActivityId());

        GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity();

        // æŸ¥è¯¢ç”¨æˆ·åœ¨ä¸€ä¸ªæ‹¼å›¢æ´»åŠ¨ä¸Šå‚ä¸çš„æ¬¡æ•°
        Integer count = repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId());

        if (null != groupBuyActivity.getTakeLimitCount() && count >= groupBuyActivity.getTakeLimitCount()) {
            log.info("ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0103);
        }

        return TradeRuleFilterBackEntity.builder()
                .userTakeOrderCount(count)
                .build();
    }

}
```

- å¦‚æœæ‹¼å›¢æ´»åŠ¨é…ç½®äº†å¯¹ç”¨æˆ·çš„å‚ä¸æ¬¡æ•°é™åˆ¶ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ç”¨æˆ·å‚ä¸æ´»åŠ¨å‰ï¼Œåšå¥½æ•°é‡çš„æ ¡éªŒæ‹¦æˆªã€‚
- æ¯”å¦‚ç”¨æˆ·å¯ä»¥å‚ä¸3æ¬¡ï¼Œé‚£ä¹ˆåº“è¡¨é‡Œä¼šè®°å½•3æ¡æ•°æ®ï¼›`æ´»åŠ¨ID_ç”¨æˆ·ID_1`ã€`æ´»åŠ¨ID_ç”¨æˆ·ID_2`ã€`æ´»åŠ¨ID_ç”¨æˆ·ID_3`ï¼Œè¿™æ ·å¯ä»¥åœ¨åº“è¡¨å±‚é¢åšæœ€å¼ºçš„é˜²æŠ¤æ‹¦æˆªï¼Œä¸ä¼šè®©ä¸€ä¸ªç”¨æˆ·æ— é™çš„å‚ä¸æ´»åŠ¨ã€‚

##### 3.3 äº¤æ˜“è§„åˆ™å·¥å‚

```java
@Slf4j
@Service
public class TradeRuleFilterFactory {

    @Bean("tradeRuleFilter")
    public BusinessLinkedList<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) {
        // ç»„è£…é“¾
        LinkArmory<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> linkArmory =
                new LinkArmory<>("äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾", activityUsabilityRuleFilter, userTakeLimitRuleFilter);

        // é“¾å¯¹è±¡
        return linkArmory.getLogicLink();
    }

    @Data
    @Builder
    @AllArgsConstructor
    @NoArgsConstructor
    public static class DynamicContext {

        private GroupBuyActivityEntity groupBuyActivity;

    }

}
```

- è´£ä»»é“¾çš„è§„åˆ™åˆ›å»ºå®Œæˆåï¼Œå°±æ˜¯åœ¨å·¥å‚ç±»ä¸­æ„å»ºè´£ä»»é“¾ã€‚
- åƒæ˜¯åœ¨å®é™…çš„å…¬å¸ä¸šåŠ¡å¼€å‘ä¸­ï¼Œä¸€ä¸ªè´£ä»»é“¾ä¼šæœ‰å¾ˆå¤šè¿™æ ·çš„è§„åˆ™ï¼Œå› ä¸ºè¦è¿‡æ»¤ç”¨æˆ·çš„å¼€æˆ·çŠ¶æ€ã€æˆä¿¡çŠ¶æ€ã€æ¸ é“çŠ¶æ€ã€é£æ§çŠ¶æ€ã€é¢åº¦çŠ¶æ€ç­‰ã€‚é‚£ä¹ˆè¿™æ ·çš„è®¾è®¡åˆ†å±‚ç»“æ„å°±éå¸¸å¥½æ‰©å±•å’Œç»´æŠ¤äº†ã€‚
- æ­¤å¤–ï¼Œä¹Ÿä¸åªæ˜¯ä¸€ä¸ªè´£ä»»é“¾ï¼Œè€Œæ˜¯å¾ˆå¤šï¼Œä»–ä»¬æ ¹æ®ä¸åŒçš„ä¸šåŠ¡æ¨¡å‹ï¼Œæ¯”å¦‚ï¼›ä¹¡æ‘äº¤æ˜“ã€æ”¿ä¼äº¤æ˜“ã€æ ¡å›­äº¤æ˜“ã€æ™®æˆ·äº¤æ˜“ç­‰ï¼Œä»–ä»¬çš„è§„åˆ™æµç¨‹ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œé‚£ä¹ˆä¸ºä¸åŒçš„æµç¨‹ï¼Œç›´æ¥é…ç½®å‡ºå¯¹åº”çš„è´£ä»»é“¾ï¼Œå°±å¯ä»¥å¿«é€Ÿçš„æ­å»ºç¬¦åˆçš„ä¸šåŠ¡æµç¨‹äº†ï¼Œå¼€å‘æ•ˆç‡ã€ç»´æŠ¤æ•ˆç‡éƒ½å˜å˜çš„ï¼Œä½ çš„æŠ€æœ¯è®¤å¯åº¦ä¹Ÿå˜å˜æé«˜ï¼



## [ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡](https://wx.zsxq.com/group/48411118851818/topic/4848142448421828)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡-çŸ¥è¯†æ˜Ÿçƒ](https://wx.zsxq.com/group/48411118851818/topic/5121824221248154)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

é¦–å…ˆï¼Œä½ å¯ä»¥å›å¿†ä¸‹å’±ä»¬æ•´ä¸ªæ‹¼å›¢ä¸šåŠ¡çš„æµç¨‹ã€‚

æ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚

é‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼Œæ‹¼å›¢ç»“ç®—æµç¨‹ã€‚

![group-buy-market-2-12-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Fkzfk6YwCbO2n1oWSE1ZbxTeEzJ9.png)

- é¦–å…ˆï¼Œäº¤æ˜“è®¢å•çš„è¥é”€ç»“ç®—ï¼Œæ ¸å¿ƒå°±æ˜¯æ›´æ–°æ‹¼å›¢é˜Ÿä¼çš„å‚ä¸äººæ•°æ•°é‡ã€‚æ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±æœ‰ä¸€ç¬”æ‹¼å›¢è¿›åº¦æ•°é‡+1ã€‚
- ä¹‹åï¼Œè¿™é‡Œè¦çŸ¥é“ï¼Œæ›´æ–°æ‹¼å›¢è®¢å•çš„æ˜ç»†çŠ¶æ€ï¼ˆäº¤æ˜“å®Œæˆï¼‰å’Œæ›´æ–°æ‹¼å›¢è¿›åº¦æ•°é‡è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸‹å®Œæˆã€‚
- å¦å¤–ï¼Œæ›´æ–°æ‹¼å›¢çš„è¿›åº¦è¦åˆ¤æ–­ï¼Œå½“å‰æ˜¯å¦ä¸ºæœ€åä¸€æ¬¡æ‹¼å›¢å®Œç»“çŠ¶æ€ã€‚æ¯”å¦‚è®¡ç®—å‰©ä½™1ä¸ªï¼Œå³å¯å®Œæˆæ‹¼å›¢ç›®æ ‡é‡ï¼Œé‚£ä¹ˆè¿™æœ€åä¸€ç¬”æ›´æ–°å®Œæˆåï¼Œæ—¢æ˜¯æ•´ä¸ªæ‹¼å›¢é˜Ÿä¼çš„è¿›åº¦å®Œæˆäº†ã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-12-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FjFIPsSWH4chCvrwtBfw2l7xsshn.png)

- é¦–å…ˆï¼Œé‡æ„äº¤æ˜“åˆ†å±‚ï¼Œç”¨ç±»çš„åç§°ï¼Œæ‹†åˆ†äº¤æ˜“ä¸­çš„ä¸šåŠ¡åœºæ™¯ã€‚ä»¥æ­¤å®Œæˆå•ä¸€èŒè´£çš„åˆ’åˆ†ã€‚
- ä¹‹åï¼Œtrade é¢†åŸŸä¸‹ç›®å‰åŒ…æ‹¬2éƒ¨åˆ†æœåŠ¡ï¼Œä¸€ä¸ªæ˜¯è¥é”€äº¤æ˜“é”å•æœåŠ¡ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯æœ¬èŠ‚æ–°å¢åŠ çš„ï¼Œè¥é”€äº¤æ˜“ç»“ç®—æœåŠ¡ã€‚
- é‡ç‚¹ï¼Œåœ¨äºæœ¬èŠ‚å®ç°çš„è¥é”€äº¤æ˜“ç»“ç®—æœåŠ¡ï¼Œå¯¹æ¯ä¸€ç¬”æ”¯ä»˜è®°å½•çš„è®°è´¦å¤„ç†ï¼Œç›´è‡³å®Œæˆæ‹¼å›¢è¿›åº¦ã€‚

#### 2. é‡æ„é”å•

å•ä¸€èŒè´£çš„ç‰¹ç‚¹åœ¨äºä¸€ä¸ªç±»ï¼Œä¸»è¦å…³å¿ƒä¸€ç±»æœåŠ¡çš„è®¾è®¡ã€‚å•ä¸€èŒè´£çš„å¥½å¤„æ˜¯ï¼š**é™ä½å¤æ‚æ€§** ã€**æé«˜å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§** ã€**æé«˜å¤ç”¨æ€§** ã€**é™ä½å˜æ›´é£é™©** ã€‚

![group-buy-market-2-12-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FgX1_214qQRjCxd4zJoAX1HsoFXS.png)

é‚£ä¹ˆï¼Œæˆ‘ä»¬ä½¿ç”¨å•ä¸€èŒè´£æ¥è®¾è®¡æ¥å£ï¼Œå®ƒçš„ç‰¹ç‚¹åœ¨äºï¼Œæ¥å£çš„å‘½åå³å¯çœ‹å‡ºåšçš„ä¸šåŠ¡å±æ€§ï¼Œå¦‚ï¼›ITradePayã€ITradeRefundã€ITradeSettlement ç­‰ã€‚å¦‚æœè¯´æ²¡æœ‰å•ä¸€èŒè´£ï¼Œé‚£ä¹ˆè¿™äº›payã€refundã€settlementï¼Œå°±ä¼šè¢«å†™åˆ°ä¸€ä¸ªæ¥å£ç±»é‡Œï¼Œè¿™ä¸ªç±»ä¼šéšç€ä¸šåŠ¡çš„è¿­ä»£ï¼Œè¢«å……æ–¥å¤§é‡çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¶Šå¾€åè¶Šéš¾ç»´æŠ¤ã€‚æ‰€ä»¥å¯¹äºè¿™ç±»åœºæ™¯ï¼Œæˆ‘ä»¬è¦åšå•ä¸€èŒè´£è®¾è®¡ã€‚

#### 3. æ‹¼å›¢ç»“ç®—

##### 3.1 å®šä¹‰æ¥å£

```java
public interface ITradeSettlementOrderService {

    /**
     * è¥é”€ç»“ç®—
     * @param tradePaySuccessEntity äº¤æ˜“æ”¯ä»˜è®¢å•å®ä½“å¯¹è±¡
     * @return äº¤æ˜“ç»“ç®—è®¢å•å®ä½“
     */
    TradePaySettlementEntity settlementMarketPayOrder(TradePaySuccessEntity tradePaySuccessEntity);

}
```

- é¦–å…ˆï¼Œä¾ç…§äºå•ä¸€èŒè´£ï¼Œè®¾è®¡å‡ºä¸€ä¸ªäº¤æ˜“ç»“ç®—çš„æœåŠ¡ã€‚
- ä¹‹åï¼Œå®šä¹‰è¥é”€ç»“ç®—çš„æ–¹æ³•ã€‚å…¥å‚ä¸ºäº¤æ˜“æ”¯ä»˜çš„æˆåŠŸå®ä½“ä¿¡æ¯ï¼Œå‡ºå‚ä¸ºäº¤æ˜“ç»“ç®—çš„å®ä½“ã€‚

##### 3.2 åŠŸèƒ½å®ç°

```java
@Slf4j
@Service
public class TradeSettlementOrderService implements ITradeSettlementOrderService {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradePaySettlementEntity settlementMarketPayOrder(TradePaySuccessEntity tradePaySuccessEntity) {
        log.info("æ‹¼å›¢äº¤æ˜“-æ”¯ä»˜è®¢å•ç»“ç®—:{} outTradeNo:{}", tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());
        // 1. æŸ¥è¯¢æ‹¼å›¢ä¿¡æ¯
        MarketPayOrderEntity marketPayOrderEntity = repository.queryMarketPayOrderEntityByOutTradeNo(tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());
        if (null == marketPayOrderEntity) {
            log.info("ä¸å­˜åœ¨çš„å¤–éƒ¨äº¤æ˜“å•å·æˆ–ç”¨æˆ·å·²é€€å•ï¼Œä¸éœ€è¦åšæ”¯ä»˜è®¢å•ç»“ç®—:{} outTradeNo:{}", tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());
            return null;
        }

        // 2. æŸ¥è¯¢ç»„å›¢ä¿¡æ¯
        GroupBuyTeamEntity groupBuyTeamEntity = repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId());

        // 3. æ„å»ºèšåˆå¯¹è±¡
        GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate = GroupBuyTeamSettlementAggregate.builder()
                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())
                .groupBuyTeamEntity(groupBuyTeamEntity)
                .tradePaySuccessEntity(tradePaySuccessEntity)
                .build();

        // 4. æ‹¼å›¢äº¤æ˜“ç»“ç®—
        repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);

        // 5. è¿”å›ç»“ç®—ä¿¡æ¯ - å…¬å¸ä¸­å¼€å‘è¿™æ ·çš„æµç¨‹æ—¶å€™ï¼Œä¼šæ ¹æ®å¤–éƒ¨éœ€è¦è¿›è¡Œå€¼çš„è®¾ç½®
        return TradePaySettlementEntity.builder()
                .source(tradePaySuccessEntity.getSource())
                .channel(tradePaySuccessEntity.getChannel())
                .userId(tradePaySuccessEntity.getUserId())
                .teamId(marketPayOrderEntity.getTeamId())
                .activityId(groupBuyTeamEntity.getActivityId())
                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())
                .build();
    }

}
```

- é¦–å…ˆï¼Œç»“ç®—çš„è¿‡ç¨‹åˆ†ä¸ºæŸ¥è¯¢å¤–éƒ¨çš„äº¤æ˜“å•å·æ˜¯å¦ä¸ºæ‹¼å›¢é”å•è®¢å•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¹‹å‰è¿™ç¬”äº¤æ˜“å•å·ï¼Œå‚ä¸è¿‡æœ‰æ•ˆçš„é”å•ã€‚
- å¦å¤–ï¼Œå•†åŸç±»ç³»ç»Ÿè°ƒç”¨è¥é”€çš„è¦è¿‡æ»¤æ˜¯å¦æœ‰è¥é”€ç±»ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸è°ƒç”¨ï¼Œè¿™æ ·ä¼šå‡è½»å¯¹æ‹¼å›¢ç±»ç³»ç»Ÿæ¥å£çš„å‹åŠ›ã€‚
- æœ€åï¼Œæ„å»ºèšåˆå¯¹è±¡ï¼Œè°ƒç”¨ä»“å‚¨å±‚çš„ settlementMarketPayOrder å®Œæˆæ‹¼å›¢ç±»æ•°æ®è½åº“ã€‚

##### 3.3 äº‹åŠ¡æ“ä½œ

```java
@Slf4j
@Repository
public class TradeRepository implements ITradeRepository {

    @Resource
    private IGroupBuyActivityDao groupBuyActivityDao;
    @Resource
    private IGroupBuyOrderDao groupBuyOrderDao;
    @Resource
    private IGroupBuyOrderListDao groupBuyOrderListDao;
    @Resource
    private INotifyTaskDao notifyTaskDao;

    // ... çœç•¥éƒ¨åˆ†ä»£ç 

    @Transactional(timeout = 500)
    @Override
    public void settlementMarketPayOrder(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate) {

        UserEntity userEntity = groupBuyTeamSettlementAggregate.getUserEntity();
        GroupBuyTeamEntity groupBuyTeamEntity = groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity();
        TradePaySuccessEntity tradePaySuccessEntity = groupBuyTeamSettlementAggregate.getTradePaySuccessEntity();

        // 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€
        GroupBuyOrderList groupBuyOrderListReq = new GroupBuyOrderList();
        groupBuyOrderListReq.setUserId(userEntity.getUserId());
        groupBuyOrderListReq.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo());
        int updateOrderListStatusCount = groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderListReq);
        if (1 != updateOrderListStatusCount) {
            throw new AppException(ResponseCode.E0005);
        }

        // 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡
        int updateAddCount = groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId());
        if (1 != updateAddCount) {
            throw new AppException(ResponseCode.E0005);
        }

        // 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€
        if (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == 1) {
            int updateOrderStatusCount = groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId());
            if (1 != updateOrderStatusCount) {
                throw new AppException(ResponseCode.E0005);
            }

            // æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å®Œæˆå¤–éƒ¨å•å·åˆ—è¡¨
            List<String> outTradeNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId());

            // æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½•
            NotifyTask notifyTask = new NotifyTask();
            notifyTask.setActivityId(groupBuyTeamEntity.getActivityId());
            notifyTask.setTeamId(groupBuyTeamEntity.getTeamId());
            notifyTask.setNotifyUrl("æš‚æ— ");
            notifyTask.setNotifyCount(0);
            notifyTask.setNotifyStatus(0);
            notifyTask.setParameterJson(JSON.toJSONString(new HashMap<String, Object>() {{
                put("teamId", groupBuyTeamEntity.getTeamId());
                put("outTradeNoList", outTradeNoList);
            }}));

            notifyTaskDao.insert(notifyTask);
        }

    }

}
```

- äº¤æ˜“ç»“ç®—çš„è¿‡ç¨‹åˆ†ä¸ºï¼›æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€ã€æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ï¼Œä¹‹åè¦åˆ¤æ–­å½“å‰è¿™ç¬”ç»“ç®—æ˜¯å¦ä¸ºæœ€åçš„ç»“ç®—ï¼Œå¦‚æœæ˜¯ï¼Œè¿˜éœ€è¦å†™å…¥å›è°ƒä»»åŠ¡ã€‚
- è¿™é‡Œçš„å›è°ƒä»»åŠ¡ï¼Œæ˜¯åœ¨æ‹¼å›¢ç»“æŸåï¼Œå›è°ƒå•†åŸç³»ç»Ÿï¼Œé€šçŸ¥æ‹¼å›¢å®Œæˆã€‚ä¹‹åå•†åŸç³»ç»Ÿè¦å¯¹å·²ç»æ”¯ä»˜å®Œæˆçš„è®¢å•è¿›è¡Œå‘è´§ã€‚ã€å¦‚æœä½ åšè¿‡æ”¯ä»˜ç±»ç³»ç»Ÿï¼ˆæ˜Ÿçƒé‡Œçš„å°å‹æ”¯ä»˜å•†åŸã€openaiåº”ç”¨ã€è“å…”æ”¯ä»˜sdkï¼‰ï¼Œéƒ½æœ‰æ”¯ä»˜å®Œæˆçš„å›è°ƒï¼Œé€šçŸ¥ä½ æ”¯ä»˜ç»“æœã€‘
- å…³äºå›è°ƒçš„æµç¨‹ï¼Œåç»­åœ¨åšå¤„ç†ã€‚ä½ ä¹Ÿå¯ä»¥å…ˆå°è¯•è€ƒè™‘ä¸‹è¿™ä¸ªæµç¨‹ã€‚



## [ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤](https://wx.zsxq.com/group/48411118851818/topic/4848142814814818)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤](https://articles.zsxq.com/id_8lei3wc3g685.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

æ‹¼å›¢äº¤æ˜“ç»“ç®—çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸€äº›åˆ—çš„è§„åˆ™è¿‡æ»¤ã€‚åŒ…æ‹¬ï¼›æˆ‘ä»¬ä¸Šä¸€èŠ‚æåˆ°çš„æ ¡éªŒå¤–éƒ¨äº¤æ˜“å•çš„æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…ï¼ŒåŒæ—¶è¿˜æœ‰å…³äºè¿™ç¬”å¤–éƒ¨äº¤æ˜“å•æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ‹¼å›¢é”å•è®¢å•ã€‚å¦å¤–åƒæ˜¯ SC æ¸ é“çš„æœ‰æ•ˆæ€§ä¹Ÿéœ€è¦åœ¨ç»“ç®—æ—¶è¿›è¡Œæ ¡éªŒã€‚

æ‰€ä»¥ï¼Œæœ¬èŠ‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€å¥—è§„åˆ™é“¾ï¼Œæ¥å¤„ç†è¿™äº›ä¸šåŠ¡è§„åˆ™ã€‚å› ä¸ºè§„åˆ™é“¾å·²ç»è¢«æŠ½å–ä¸ºé€šç”¨çš„æ¨¡æ¿äº†ï¼Œé‚£ä¹ˆæœ¬èŠ‚ä½¿ç”¨èµ·æ¥ä¼šéå¸¸å®¹æ˜“ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼Œæ‹¼å›¢äº¤æ˜“ç»“ç®—æµç¨‹è®¾è®¡ï¼›

![group-buy-market-2-13-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FmdFCP1mxnQlT9UHlx6LY0N9FqDH.png)

- é¦–å…ˆï¼Œæœ¬èŠ‚çš„é‡ç‚¹åœ¨äºæ–°å¢åŠ ç»“ç®—è§„åˆ™è¿‡æ»¤çš„è´£ä»»é“¾ï¼Œå¤„ç†ï¼›SCæ¸ é“ç®¡æ§ã€æœ‰æ•ˆçš„å¤–éƒ¨äº¤æ˜“å•å·ã€ç»“ç®—å®ç°æ˜¯å¦ä¸ºæ‹¼å›¢æ—¶æ•ˆå†…ã€‚
- é‚£ä¹ˆè¿™é‡Œä¼šæœ‰ä¸€äº›åŠŸèƒ½æ”¹é€ ç‚¹ï¼›
  - æ‹¼å›¢è¡¨ï¼Œgroup_buy_order å¢åŠ  valid_start_timeï¼ˆæœ‰æ•ˆå¼€å§‹æ—¶é—´ï¼‰ã€valid_end_timeï¼ˆæœ‰æ•ˆç»“æŸæ—¶é—´ï¼‰ å­—æ®µã€‚ç”¨äºæ¯ç¬”äº¤æ˜“ç»“ç®—æ—¶å€™ï¼Œç”¨ç»“ç®—æ—¶é—´åˆ¤æ–­æ˜¯å¦åŒ¹é…åˆ°æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…ã€‚
  - æ‹¼å›¢æ˜ç»†ï¼Œgroup_buy_order_list å¢åŠ  out_trade_timeï¼ˆäº¤æ˜“æ—¶é—´ï¼‰ å­—æ®µï¼Œè®°å½•æ¯ç¬”ç»“ç®—çš„è®¢å•ç»“ç®—çš„æ—¶é—´ã€‚éšç€çŠ¶æ€æ›´æ–°çš„æ—¶å€™æ›´æ–°ã€‚
  - trade é¢†åŸŸä¸‹ï¼Œlock é”å•ã€‚å®ä½“å¯¹è±¡ï¼Œä¿®æ”¹åç§°ã€‚TradeRuleCommandEntity -> TradeLockRuleCommandEntity,TradeRuleFilterBackEntity -> TradeLockRuleFilterBackEntity å¢åŠ äº† Lock æ ‡è¯†ã€‚ä¾¿äºåœ¨æ·»åŠ  TradeSettlementRuleCommandEntityã€TradeSettlementRuleFilterBackEntity æ—¶æ›´å¥½ç†è§£ã€‚
  - PayActivityEntity æ·»åŠ  validTimeï¼ŒGroupBuyTeamEntity æ·»åŠ  validStartTimeã€validEndTime
  - trade é¢†åŸŸä¸‹ï¼Œsettlement ç»“ç®—æœåŠ¡ä¸­ï¼Œä½¿ç”¨è´£ä»»é“¾æ¨¡æ¿ï¼Œå®ç°è¥é”€äº¤æ˜“è§„åˆ™çš„è¿‡æ»¤ã€‚SCRuleFilterï¼ˆSCé»‘åå•ç®¡æ§è¿‡æ»¤ DCCService é…ç½®æ–°çš„å±æ€§ scBlacklistï¼‰ã€OutTradeNoRuleFilterï¼ˆå¤–éƒ¨äº¤æ˜“å•å·æœ‰æ•ˆæ€§è¿‡æ»¤ï¼‰ã€SettableRuleFilterï¼ˆäº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…è¿‡æ»¤ï¼‰ã€EndRuleFilterï¼ˆç»“æŸèŠ‚ç‚¹å°è£…è¿”å›æ•°æ®ï¼‰
  - äº¤æ˜“æœåŠ¡ï¼ŒTradePaySettlementEntity è°ƒç”¨ tradeSettlementRuleFilter è´£ä»»é“¾æ–¹æ³•ï¼Œå¹¶è¿”å›ç›¸å…³çš„æ•°æ®ä¿¡æ¯ã€‚
  - settlementMarketPayOrder ç»“ç®—ä¸€ä¸ªäº‹åŠ¡ä¸‹æ“ä½œï¼Œå¢åŠ  updateOrderStatus2COMPLETE æ›´æ–°æ—¶å€™æ·»åŠ  outTradeTime æ—¶é—´ã€‚

### ä¸‰ã€ç¼–ç å®ç°

#### 1. å·¥ç¨‹ç»“æ„

![group-buy-market-2-13-02.png](./æ‹¼å›¢é¡¹ç›®.assets/Fm4tSydeC2GSk94wvIDz-L4gno6Z.png)

- é¦–å…ˆï¼Œä½ åœ¨å®ç°åŠŸèƒ½ç¼–ç çš„æ—¶å€™ï¼Œè¦å…ˆè€ƒè™‘æ¸…æ¥šä½ çš„æ¨¡å‹ç»“æ„å¦‚ä½•å¤„ç†ã€‚å¦‚ï¼Œæœ¬èŠ‚è¦åšä¸€ä¸ªç»“ç®—è§„åˆ™çš„å¤„ç†ï¼Œé‚£ä¹ˆè¿™äº›è§„åˆ™ä½ æ˜¯æƒ³åœ¨ä¸€ä¸ªç±»é‡Œå†™å¤§é‡çš„æ–¹æ³•ç”¨ `if...else` è¿˜æ˜¯æ€ä¹ˆå®ç°ã€‚
- ä¹‹åï¼Œä½ è¦å¼€å§‹æ€è€ƒã€‚å¦‚æœä¸ä½¿ç”¨ `if...else` ä¸€å±‚å±‚åˆ¤æ–­ï¼Œé‚£ä¹ˆå°±è¦å…ˆæ€è€ƒè¿™å—çš„ä¸šåŠ¡æµç¨‹ï¼Œå¯ä»¥è¢«åˆ†ä¸ºå‡ å—å¤„ç†ã€‚æŠŠä»–ä»¬çš„è¾¹ç•Œæ€è€ƒå¥½ã€‚
- ç„¶åï¼Œä»ä¸€ä¸ªä¸ªç±»ä¸‹æ‰‹ï¼Œç”¨ç±»å®ç°è¾¹ç•Œã€‚ä¹Ÿå°±æ˜¯ç”¨ç±»æ¥åŒºåˆ†ä½ åŸæ¥åœ¨ä¸€ä¸ªå¤§æ–¹æ³•ä¸­å†™çš„ä¸€ç‰‡æµç¨‹ä»£ç ï¼Œè€Œæ¯ä¸ªç±»çš„è¡”æ¥ï¼Œå¯ä»¥ä½¿ç”¨è§„åˆ™æ ‘æ¨¡å‹ã€è´£ä»»é“¾æ¨¡å‹ç­‰ï¼Œè¡”æ¥ä¸­é—´æµè½¬çš„è°ƒç”¨è¿‡ç¨‹ã€‚

#### 2. è°ƒæ•´åº“è¡¨

##### 2.1 group_buy_order

![group-buy-market-2-13-03.png](./æ‹¼å›¢é¡¹ç›®.assets/FlmW-Uqtb_r_rPtOP9uftlf4btTx.png)

- æ¯ä¸€ä¸ªæ‹¼å›¢ï¼Œéƒ½æ˜¯ä»æ‹¼å›¢æ´»åŠ¨è¡¨ group_buy_activity è·å¾—çš„å‚ä¸æ•°æ®ã€‚ä¹Ÿå°±æ˜¯ä½ åœ¨ group_buy_activity æ´»åŠ¨æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…ï¼Œåœ¨åŠ ä¸Šæ‹¼å›¢æ—¶é—´ã€‚å°±æ˜¯ group_buy_order æ‹¼å›¢çš„æœ‰æ•ˆå¼€å§‹å’Œç»“æŸæ—¶é—´ã€‚
- æŠŠè¿™æ ·çš„æ•°æ®å†™åˆ° group_buy_order è¡¨é‡Œï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä»æ´»åŠ¨è¡¨è®¡ç®—ã€‚æ˜¯ä¸ºäº†æŠŠå³æ—¶æ€§æ•°æ®å­˜åº“ï¼Œé¿å…ä»¥åè°ƒæ•´æ´»åŠ¨æ—¶é—´ï¼Œé€ æˆå®¢è¯‰ä¸å¥½æ’æŸ¥ã€‚

##### 2.2 group_buy_order_list

![group-buy-market-2-13-04.png](./æ‹¼å›¢é¡¹ç›®.assets/FleRFwHCtSvG1R-Fx1jCRwbu__S5.png)

* group_buy_order_list æ·»åŠ ä¸€ä¸ªæ‹¼å›¢äº¤æ˜“å®Œæˆçš„æ—¶é—´ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„çŸ¥é“ç”¨æˆ·æ˜¯å¤šä¹…é”å•ï¼Œå¤šä¹…æ”¯ä»˜çš„ã€‚æ”¯ä»˜æ—¶å€™æœ‰ç­‰å¾…çš„ã€‚ä¾¿äºä»¥ååšæ•°æ®`é‡åŒ–`è®¡ç®—ã€‚

#### 3. ç»“ç®—è§„åˆ™

##### 3.1 SCRuleFilter

```java
@Slf4j
@Service
public class SCRuleFilter implements ILogicHandler<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-æ¸ é“é»‘åå•æ ¡éªŒ{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // sc æ¸ é“é»‘åå•æ‹¦æˆª
        boolean intercept = repository.isSCBlackIntercept(requestParameter.getSource(), requestParameter.getChannel());
        if (intercept) {
            log.error("{}{} æ¸ é“é»‘åå•æ‹¦æˆª", requestParameter.getSource(), requestParameter.getChannel());
            throw new AppException(ResponseCode.E0105);
        }

        return next(requestParameter, dynamicContext);
    }

}
```

##### 3.2 OutTradeNoRuleFilter

```java
@Slf4j
@Service
public class OutTradeNoRuleFilter implements ILogicHandler<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-å¤–éƒ¨å•å·æ ¡éªŒ{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // æŸ¥è¯¢æ‹¼å›¢ä¿¡æ¯
        MarketPayOrderEntity marketPayOrderEntity = repository.queryMarketPayOrderEntityByOutTradeNo(requestParameter.getUserId(), requestParameter.getOutTradeNo());

        if (null == marketPayOrderEntity) {
            log.error("ä¸å­˜åœ¨çš„å¤–éƒ¨äº¤æ˜“å•å·æˆ–ç”¨æˆ·å·²é€€å•ï¼Œä¸éœ€è¦åšæ”¯ä»˜è®¢å•ç»“ç®—:{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());
            throw new AppException(ResponseCode.E0104);
        }

        dynamicContext.setMarketPayOrderEntity(marketPayOrderEntity);

        return next(requestParameter, dynamicContext);
    }

}
```

##### 3.3 SettableRuleFilter

```java
@Slf4j
@Service
public class SettableRuleFilter implements ILogicHandler<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-æœ‰æ•ˆæ—¶é—´æ ¡éªŒ{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // ä¸Šä¸‹æ–‡ï¼›è·å–æ•°æ®
        MarketPayOrderEntity marketPayOrderEntity = dynamicContext.getMarketPayOrderEntity();

        // æŸ¥è¯¢æ‹¼å›¢å¯¹è±¡
        GroupBuyTeamEntity groupBuyTeamEntity = repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId());

        // å¤–éƒ¨äº¤æ˜“æ—¶é—´ - ä¹Ÿå°±æ˜¯ç”¨æˆ·æ”¯ä»˜å®Œæˆçš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´è¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…
        Date outTradeTime = requestParameter.getOutTradeTime();

        // åˆ¤æ–­ï¼Œå¤–éƒ¨äº¤æ˜“æ—¶é—´ï¼Œè¦å°äºæ‹¼å›¢ç»“æŸæ—¶é—´ã€‚å¦åˆ™æŠ›å¼‚å¸¸ã€‚
        if (!outTradeTime.before(groupBuyTeamEntity.getValidEndTime())) {
            log.error("è®¢å•äº¤æ˜“æ—¶é—´ä¸åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…");
            throw new AppException(ResponseCode.E0106);
        }

        // è®¾ç½®ä¸Šä¸‹æ–‡
        dynamicContext.setGroupBuyTeamEntity(groupBuyTeamEntity);

        return next(requestParameter, dynamicContext);
    }

}
```

##### 3.4 EndRuleFilter

```java
@Slf4j
@Service
public class EndRuleFilter implements ILogicHandler<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-ç»“æŸèŠ‚ç‚¹{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
        GroupBuyTeamEntity groupBuyTeamEntity = dynamicContext.getGroupBuyTeamEntity();

        // è¿”å›å°è£…æ•°æ®
        return TradeSettlementRuleFilterBackEntity.builder()
                .teamId(groupBuyTeamEntity.getTeamId())
                .activityId(groupBuyTeamEntity.getActivityId())
                .targetCount(groupBuyTeamEntity.getTargetCount())
                .completeCount(groupBuyTeamEntity.getCompleteCount())
                .lockCount(groupBuyTeamEntity.getLockCount())
                .status(groupBuyTeamEntity.getStatus())
                .validStartTime(groupBuyTeamEntity.getValidStartTime())
                .validEndTime(groupBuyTeamEntity.getValidEndTime())
                .build();
    }

}
```

#### 4. è§„åˆ™å·¥å‚

```java
@Slf4j
@Service
public class TradeSettlementRuleFilterFactory {

    @Bean("tradeSettlementRuleFilter")
    public BusinessLinkedList<TradeSettlementRuleCommandEntity,
            TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> tradeSettlementRuleFilter(
            SCRuleFilter scRuleFilter,
            OutTradeNoRuleFilter outTradeNoRuleFilter,
            SettableRuleFilter settableRuleFilter,
            EndRuleFilter endRuleFilter) {

        // ç»„è£…é“¾
        LinkArmory<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> linkArmory =
                new LinkArmory<>("äº¤æ˜“ç»“ç®—è§„åˆ™è¿‡æ»¤é“¾", scRuleFilter, outTradeNoRuleFilter, settableRuleFilter, endRuleFilter);

        // é“¾å¯¹è±¡
        return linkArmory.getLogicLink();
    }
    
    // ... çœç•¥éƒ¨åˆ†ä»£ç 
}
```

* è§„åˆ™å·¥å‚ï¼Œè´Ÿè´£æŠŠè´£ä»»é“¾è¿›è¡Œä¸²è”ã€‚ä¹‹åæä¾›ä¸€ä¸ªæŒ‡å®šåç§°çš„è§„åˆ™ Bean å¯¹è±¡ã€‚

#### 5. ä½¿ç”¨è§„åˆ™

```java
@Slf4j
@Service
public class TradeSettlementOrderService implements ITradeSettlementOrderService {

    @Resource
    private ITradeRepository repository;
    @Resource
    private BusinessLinkedList<TradeSettlementRuleCommandEntity, TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> tradeSettlementRuleFilter;

    @Override
    public TradePaySettlementEntity settlementMarketPayOrder(TradePaySuccessEntity tradePaySuccessEntity) throws Exception {
        log.info("æ‹¼å›¢äº¤æ˜“-æ”¯ä»˜è®¢å•ç»“ç®—:{} outTradeNo:{}", tradePaySuccessEntity.getUserId(), tradePaySuccessEntity.getOutTradeNo());
        // 1. ç»“ç®—è§„åˆ™è¿‡æ»¤
        TradeSettlementRuleFilterBackEntity tradeSettlementRuleFilterBackEntity = tradeSettlementRuleFilter.apply(
                TradeSettlementRuleCommandEntity.builder()
                        .source(tradePaySuccessEntity.getSource())
                        .channel(tradePaySuccessEntity.getChannel())
                        .userId(tradePaySuccessEntity.getUserId())
                        .outTradeNo(tradePaySuccessEntity.getOutTradeNo())
                        .outTradeTime(tradePaySuccessEntity.getOutTradeTime())
                        .build(),
                new TradeSettlementRuleFilterFactory.DynamicContext());

        String teamId = tradeSettlementRuleFilterBackEntity.getTeamId();

        // 2. æŸ¥è¯¢ç»„å›¢ä¿¡æ¯
        GroupBuyTeamEntity groupBuyTeamEntity = GroupBuyTeamEntity.builder()
                .teamId(tradeSettlementRuleFilterBackEntity.getTeamId())
                .activityId(tradeSettlementRuleFilterBackEntity.getActivityId())
                .targetCount(tradeSettlementRuleFilterBackEntity.getTargetCount())
                .completeCount(tradeSettlementRuleFilterBackEntity.getCompleteCount())
                .lockCount(tradeSettlementRuleFilterBackEntity.getLockCount())
                .status(tradeSettlementRuleFilterBackEntity.getStatus())
                .validStartTime(tradeSettlementRuleFilterBackEntity.getValidStartTime())
                .validEndTime(tradeSettlementRuleFilterBackEntity.getValidEndTime())
                .build();

        // 3. æ„å»ºèšåˆå¯¹è±¡
        GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate = GroupBuyTeamSettlementAggregate.builder()
                .userEntity(UserEntity.builder().userId(tradePaySuccessEntity.getUserId()).build())
                .groupBuyTeamEntity(groupBuyTeamEntity)
                .tradePaySuccessEntity(tradePaySuccessEntity)
                .build();

        // 4. æ‹¼å›¢äº¤æ˜“ç»“ç®—
        repository.settlementMarketPayOrder(groupBuyTeamSettlementAggregate);

        // 5. è¿”å›ç»“ç®—ä¿¡æ¯ - å…¬å¸ä¸­å¼€å‘è¿™æ ·çš„æµç¨‹æ—¶å€™ï¼Œä¼šæ ¹æ®å¤–éƒ¨éœ€è¦è¿›è¡Œå€¼çš„è®¾ç½®
        return TradePaySettlementEntity.builder()
                .source(tradePaySuccessEntity.getSource())
                .channel(tradePaySuccessEntity.getChannel())
                .userId(tradePaySuccessEntity.getUserId())
                .teamId(teamId)
                .activityId(groupBuyTeamEntity.getActivityId())
                .outTradeNo(tradePaySuccessEntity.getOutTradeNo())
                .build();
    }

}
```

- è¥é”€ç»“ç®—æœåŠ¡ TradeSettlementOrderServiceï¼Œè°ƒæ•´åœ¨äºï¼Œä¸åœ¨è¿™é‡Œåˆ¤æ–­å¤–éƒ¨äº¤æ˜“å•å·æ˜¯å¦æœ‰æ•ˆäº†ï¼Œè€Œæ˜¯ç»Ÿä¸€æ”¶åˆ°è´£ä»»é“¾ä¸­å®ç°ã€‚
- å¦å¤–è§„åˆ™é“¾ä¼šè¿”å›æ‰€éœ€çš„æ•°æ®ï¼Œä»¥åŠè¿”å›äº† `tradePaySuccessEntity.getOutTradeTime()` äº¤æ˜“æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´ä¼šåœ¨æ“ä½œæ•°æ®æ—¶å€™åšæ›´æ–°ã€‚

### å››ã€æµ‹è¯•éªŒè¯

#### 1. é”å•

```java
@Test
public void test_lockMarketPayOrder() {
    LockMarketPayOrderRequestDTO lockMarketPayOrderRequestDTO = new LockMarketPayOrderRequestDTO();
    lockMarketPayOrderRequestDTO.setUserId("xfg01");
    lockMarketPayOrderRequestDTO.setTeamId(null);
    lockMarketPayOrderRequestDTO.setActivityId(100123L);
    lockMarketPayOrderRequestDTO.setGoodsId("9890001");
    lockMarketPayOrderRequestDTO.setSource("s01");
    lockMarketPayOrderRequestDTO.setChannel("c01");
    lockMarketPayOrderRequestDTO.setOutTradeNo(RandomStringUtils.randomNumeric(12));
    Response<LockMarketPayOrderResponseDTO> lockMarketPayOrderResponseDTOResponse = marketTradeService.lockMarketPayOrder(lockMarketPayOrderRequestDTO);
    log.info("æµ‹è¯•ç»“æœ req:{} res:{}", JSON.toJSONString(lockMarketPayOrderRequestDTO), JSON.toJSONString(lockMarketPayOrderResponseDTOResponse));
}
```

![group-buy-market-2-13-05.png](./æ‹¼å›¢é¡¹ç›®.assets/FnM3MDgXvE3wyDG4gqkSREhS7s4v.png)

- æ‰§è¡Œå®Œæ¯•åï¼Œä½ å¯ä»¥çœ‹ä¸‹æ´»åŠ¨é‡Œçš„ valid_time åŠ ä¸Šæ‹¼å›¢çš„å¼€å§‹æ—¶é—´ï¼Œä¹‹åå†™å…¥åˆ°ç”¨æˆ·æ‹¼å›¢æ—¶é—´é‡Œã€‚
- è¿™ä¸ª valid_time å¯ä»¥åŠ é•¿ä¸€äº›ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚

#### 2. ç»“ç®—

```java
@Test
public void test_settlementMarketPayOrder() throws Exception {
    TradePaySuccessEntity tradePaySuccessEntity = new TradePaySuccessEntity();
    tradePaySuccessEntity.setSource("s01");
    tradePaySuccessEntity.setChannel("c01");
    tradePaySuccessEntity.setUserId("xfg04");
    tradePaySuccessEntity.setOutTradeNo("075605651839");
    tradePaySuccessEntity.setOutTradeTime(new Date());
    TradePaySettlementEntity tradePaySettlementEntity = tradeSettlementOrderService.settlementMarketPayOrder(tradePaySuccessEntity);
    log.info("è¯·æ±‚å‚æ•°:{}", JSON.toJSONString(tradePaySuccessEntity));
    log.info("æµ‹è¯•ç»“æœ:{}", JSON.toJSONString(tradePaySettlementEntity));
}

```

![group-buy-market-2-13-06.png](./æ‹¼å›¢é¡¹ç›®.assets/FsVkCH4ebtJTXAVdLGXybckpM9-i.png)

- ç»“ç®—å®Œæˆä¸€ç¬”åï¼Œä¼šçœ‹åˆ° out_trade_time çš„æ›´æ–°ã€‚
- æ³¨æ„ï¼›`tradePaySuccessEntity.setOutTradeTime(new Date());`éœ€è¦æ–°å¢åŠ å…¥å‚ï¼Œè¿™ä¸ªå‚æ•°ä¼šä»äº¤æ˜“å®Œæˆçš„å•†åŸç³»ç»Ÿæä¾›ã€‚



## [ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡](https://wx.zsxq.com/group/48411118851818/topic/8858154281221422)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡](https://articles.zsxq.com/id_mw5rpnlwf93l.html)

![group-buy-market-2-14-01.png](./æ‹¼å›¢é¡¹ç›®.assets/Flw7zYiFjYd3vr6Ym3N0YM2uwonY.png)

- é¦–å…ˆï¼Œæœ¬èŠ‚çš„é‡ç‚¹åœ¨æ‹¼å›¢æˆå›¢åï¼Œå®ç°å›è°ƒé€šçŸ¥æµç¨‹ã€‚å›è°ƒçš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨ç”¨æˆ·é”å•æ—¶éœ€è¦å¢åŠ ä¸€ä¸ªå›è°ƒçš„åœ°å€ï¼Œå¹¶åœ¨æ‹¼å›¢å®Œç»“åå‘èµ·å›è°ƒã€‚

- é‚£ä¹ˆï¼Œè¿™é‡Œçš„ä¸€äº›åŠŸèƒ½æ”¹é€ ç‚¹ï¼›

  - `group_buy_order` åœ¨è®¾è®¡çš„æ—¶å€™æœ‰ä¸€ä¸ª `notify_url` å›è°ƒåœ°å€ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä¿®æ”¹åº“è¡¨æ·»åŠ ä¸Šè¿™ä¸ªå­—æ®µã€‚å¹¶å¯¹å·¥ç¨‹ä¸­çš„ `dao&po&mapper` æ“ä½œï¼Œå¢åŠ  `notify_url` å­—æ®µã€‚
  - MarketTradeController è¥é”€äº¤æ˜“æœåŠ¡ï¼ŒlockMarketPayOrder é”å•æ¥å£å…¥å‚å¯¹è±¡ï¼Œå¢åŠ  notifyUrl å›è°ƒåœ°å€ã€‚å¹¶æœ‰ PayDiscountEntity å¯¹è±¡é€ä¼ åˆ° `TradeRepository#lockMarketPayOrder` ä»“å‚¨æ“ä½œã€‚è¿™æ ·å†™åˆ° `group_buy_order` è¡¨å°±æœ‰å›è°ƒåœ°å€äº†ï¼Œç­‰åšå›è°ƒæ“ä½œçš„æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠè¿™ä¸ªåœ°å€å†™å…¥åˆ°å›è°ƒä»»åŠ¡è¡¨ä¸­ã€‚
  - `TradeSettlementOrderService#settlementMarketPayOrder` ç»“ç®—æœåŠ¡ï¼Œéœ€è¦æŠŠé”å•è®°å½•ä¸­çš„ notify_url æ‹¿åˆ°ï¼Œæ”¾åˆ° GroupBuyTeamEntity ä¸­ï¼Œè¿™æ ·åœ¨å†™å…¥ notify_task è¡¨è®°å½•çš„æ—¶å€™å°±å¯ä»¥æŠŠ notify_url ä¸€èµ·å†™å…¥è¿›å»äº†ã€‚
  - åŸºäº okhttp æ¡†æ¶ï¼Œå°è£…å¯¹ http æ¥å£çš„è°ƒç”¨ã€‚ç”¨äºå¤„ç†è°ƒç”¨å¤–éƒ¨å…¶ä»–å¾®æœåŠ¡ï¼Œå®ç°å›è°ƒé€šçŸ¥çš„å¤„ç†ã€‚å› ä¸ºå¤–éƒ¨çš„æ¥å£æ˜¯éšç€æ¯ä¸ªæœåŠ¡è°ƒç”¨æ‹¼å›¢å†™å…¥è¿›æ¥çš„ http è¯·æ±‚åœ°å€ï¼Œæ‰€ä»¥åœ¨å°è£…è¿™éƒ¨åˆ†è°ƒç”¨çš„æ—¶å€™ï¼Œè¦å…è®¸åŠ¨æ€é€ä¼ è¯·æ±‚åœ°å€ã€‚å®ç°ç±»å†™åˆ° infrastructure åŸºç¡€è®¾ç½®å±‚çš„ gateway è°ƒç”¨å¤–éƒ¨ç½‘å…³å±‚ã€‚å®ç°ç±»ï¼›`GroupBuyNotifyService` æä¾›æ–¹æ³•ï¼›`groupBuyNotify`
  - åœ¨äº¤æ˜“ç»“ç®—æœåŠ¡ç±» ITradeSettlementOrderServiceï¼Œå®šä¹‰æ‰§è¡Œç»“ç®—å›è°ƒé€šçŸ¥æ¥å£ï¼ŒåŒ…æ‹¬ï¼›`execSettlementNotifyJob()ã€execSettlementNotifyJob(String teamId)` ä¸€ä¸ªæ˜¯æœ‰å…¥å‚çš„ï¼Œä¸€ä¸ªæ— å…¥å‚ã€‚è¿™æ ·å¯ä»¥æŒ‡å®šç»™æŸä¸ªæ‹¼å›¢é˜Ÿä¼åšç»“ç®—ã€‚ç»“ç®—çš„è¿‡ç¨‹å°±æ˜¯è°ƒç”¨ `GroupBuyNotifyService#groupBuyNotify` å®Œæˆå›è°ƒé€šçŸ¥ï¼Œå¹¶æ ¹æ®è¿”å›çš„ç»“æœæ›´æ–° notify_task è¡¨çŠ¶æ€è®°å½•ï¼ˆæˆåŠŸã€å¤±è´¥ã€é‡è¯•ï¼‰ï¼Œå¹¶è®°å½•å›è°ƒæ¬¡æ•°ï¼Œå°äº5æ¬¡çš„æ—¶å€™éƒ½å¯ä»¥ç»§ç»­å›è°ƒã€‚
  - å›è°ƒé€šçŸ¥ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µå¤„ç†ã€‚ä¸€ä¸ªæ˜¯æ‹¼å›¢å®Œæˆåç«‹å³æ‰§è¡Œï¼Œå¦å¤–ä¸€ä¸ªä»»åŠ¡è¡¥å¿ã€‚ç«‹å³æ‰§è¡Œæ˜¯ä¸ºäº†æä¾›æ—¶æ•ˆæ€§ï¼Œä½†å› ä¸ºè¿œç¨‹çš„ http è°ƒç”¨å—ç½‘ç»œå’ŒæœåŠ¡çš„å½±å“å¯èƒ½ä¼šå¤±è´¥ï¼Œæ‰€ä»¥è¦å¢åŠ ä¸€ä¸ªä»»åŠ¡è¡¥å¿æ¥åšå®šæ—¶æ£€æŸ¥ã€‚å…¶ä¸­ç«‹å³æ‰§è¡Œåœ¨ `TradeSettlementOrderService#settlementMarketPayOrder -> settlementMarketPayOrder` å¤„ç†ã€‚å¦å¤–å®šæ—¶ä»»åŠ¡åœ¨ `GroupBuyNotifyJob` å¤„ç†ã€‚
  - æµ‹è¯•æ¥å£ï¼Œ`trigger/http` ä¸‹ï¼Œå¢åŠ  `TestApiClientController` æ¥å£å®ç°ç±»ï¼Œæä¾›å›è°ƒæ¥å£æœåŠ¡ã€‚è¿™ä¸ªæ˜¯æ¨¡æ‹Ÿçš„å…¶ä»–çš„å¾®æœåŠ¡ï¼Œå°†æ¥è¦æä¾›çš„æ¥å£ã€‚

  

## [ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£](https://wx.zsxq.com/group/48411118851818/topic/1525821124245452)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£](https://articles.zsxq.com/id_testl3kz27ac.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

æ ¹æ®åœ¨ä¸Šä¸€èŠ‚ä½¿ç”¨ DeepSeek å®ç°çš„æ‹¼å›¢ UIï¼Œè®¾è®¡å¹¶å®ç°æ‰€éœ€çš„æœåŠ¡ç«¯æ¥å£ã€‚

åœ¨äº’è”ç½‘å…¬å¸é‡Œçš„å¼€å‘è¿‡ç¨‹ä¹Ÿæ˜¯è¿™æ ·ï¼Œäº§å“åœ¨è¯„å®¡æœŸé—´ï¼Œä¼šæä¾› UI å·¥ç¨‹å¸ˆåšå¥½çš„è®¾è®¡å›¾ï¼Œç ”å‘æ‹¿åˆ°è®¾è®¡å›¾åï¼Œæä¾›æ‰€éœ€çš„æ¥å£æä¾›ç›¸åº”çš„å­—æ®µã€‚

## [ç¬¬2-16èŠ‚ï¼šå¼•å…¥RabbitMQåˆ†å¸ƒå¼å¤šç«¯æ¶ˆè´¹](https://wx.zsxq.com/group/48411118851818/topic/1525884555822242)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-16èŠ‚ï¼šå¼•å…¥RabbitMQåˆ†å¸ƒå¼å¤šç«¯æ¶ˆè´¹](https://articles.zsxq.com/id_ba5e31cmb2uu.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

å¼•å…¥ RabbitMQ åˆ†å¸ƒå¼æŠ€æœ¯æ¡†æ¶ï¼Œå®ç°åˆ†å¸ƒå¼æ¶ˆæ¯æ¶ˆè´¹å’Œå¤šæœåŠ¡æ¶ˆè´¹çš„èƒ½åŠ›ã€‚

æ¶ˆæ¯ï¼Œæ˜¯ä¸€ç§è§£è€¦æœåŠ¡é—´ç›´æ¥ï¼ˆhttp/rpcï¼‰è°ƒç”¨çš„æ‰‹æ®µï¼Œä»¥å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯çš„æ¨¡å¼ï¼Œå®Œæˆä¸šåŠ¡æµç¨‹çš„å¼‚æ­¥åŒ–å¤„ç†ã€‚

**RabbitMQåŸºç¡€æ•™ç¨‹** ï¼šhttps://bugstack.cn/md/road-map/rabbitmq.html

### äºŒã€ä¸šåŠ¡æµç¨‹

åœ¨äº’è”ç½‘å…¬å¸ä¸­ï¼Œå¾€å¾€ä¸€ä¸ªå¾®æœåŠ¡å‘é€å‡ºæ¥çš„ MQï¼Œé™¤äº†è‡ªå·±æ¥æ”¶æ¶ˆè´¹å¤„ç†è‡ªå·±çš„ä¸šåŠ¡æµç¨‹ï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šå…¶ä»–å¾®æœåŠ¡è¿›è¡Œæ¶ˆè´¹ã€‚é‚£ä¹ˆè¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ª Topicï¼Œè¢«å¤šä¸ªåº”ç”¨æ¶ˆè´¹çš„é…ç½®ã€‚å¦‚å›¾ï¼›

![group-buy-market-2-16-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FpBAGmOk-ihCpa_yu2KLfjzAfwt_.png)

- ä»¥æ‹¼å›¢å‘é€ç»“ç®—å®Œæˆæ¶ˆæ¯ä¸¾ä¾‹ï¼Œæ‹¼å›¢æ˜¯è´Ÿè½½å‡è¡¡éƒ¨ç½²äº†2å¥—æœåŠ¡ï¼Œå‘é€çš„MQæ¶ˆæ¯ï¼Œç”±å°å‹æ”¯ä»˜å¯¹æ¥ã€‚
- é‚£ä¹ˆï¼Œè´Ÿè½½å‡è¡¡çš„æ‹¼å›¢æœåŠ¡ï¼Œå‘é€MQåï¼Œè‡ªå·±çš„2å¥—å¾®æœåŠ¡ï¼Œä¼šåˆ†åˆ«æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚å¦å¤–ä¸€å¥—å°å‹æ”¯ä»˜ï¼Œå‡è®¾åªéƒ¨ç½²äº†ä¸€å¥—ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šæ¶ˆè´¹5ä¸ªMQæ¶ˆæ¯ã€‚
- æ³¨æ„ï¼Œä»¥ RabbitMQä¸¾ä¾‹ï¼Œè¿™é‡Œä¼šéœ€è¦ä½¿ç”¨åˆ°åŒä¸€å¥—äº¤æ¢æœºï¼ŒåŒä¸€ä¸ªè·¯ç”±Keyï¼Œä½†é˜Ÿåˆ—è¦åˆ†åˆ«æ¯ä¸ªæœåŠ¡é…ç½®ä¸åŒçš„ã€‚åŒæ—¶æ¶ˆæ¯æ”¯æŒæŒä¹…åŒ–ï¼Œä¹Ÿå°±æ˜¯æ‹¼å›¢å‘é€çš„MQæ¶ˆæ¯ï¼Œå³ä½¿å°å‹æ”¯ä»˜æœåŠ¡æš‚æ—¶æ²¡æœ‰å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥åœ¨å¯åŠ¨åæ¶ˆè´¹é˜Ÿåˆ—é‡Œçš„MQæ¶ˆæ¯ã€‚

## [ç¬¬2-17èŠ‚ï¼šå‘é€MQç»“ç®—æ¶ˆæ¯](https://wx.zsxq.com/group/48411118851818/topic/5125225455814284)

å…·ä½“æ–‡ç« ï¼š[ã€Šæ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿã€‹ç¬¬2-17èŠ‚ï¼šå‘é€MQç»“ç®—æ¶ˆæ¯](https://articles.zsxq.com/id_f9d3ohg0qnhz.html)

### ä¸€ã€æœ¬ç« è¯‰æ±‚

å¢åŠ æ‹¼å›¢ç»“ç®—å®Œæˆ MQ è§¦è¾¾æ–¹å¼ï¼ŒHTTPã€MQ è§¦è¾¾ï¼Œç”±è°ƒç”¨æ–¹é€šè¿‡å…¥å‚ç±»å‹å†³å®šã€‚

MQ ä¸€èˆ¬ç”¨åœ¨ä¼ä¸šå†…çš„å¾®æœåŠ¡ç³»ç»Ÿé—´é€šä¿¡ï¼Œå› ä¸ºä¼ä¸šå†…çš„å¾®æœåŠ¡ï¼Œå…±ç”¨äº†ä¸€å¥—çš„ MQ æ³¨å†Œä¸­å¿ƒï¼ŒMQ å¯ä»¥æ›´åŠ é«˜æ•ˆçš„è§¦è¾¾å’Œåˆ†å¸ƒå¼éƒ¨ç½²ã€‚è€Œå¯¹äºä¼ä¸šå¤–çš„è°ƒç”¨ï¼Œä¸æˆ‘ä»¬å®Œå…¨ä¸æ˜¯ä¸€ä¸ªå…¬å¸çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆä¸å†åŒä¸€ä¸ªå¾®æœåŠ¡ç¯å¢ƒå†…ï¼Œåˆ™éœ€è¦é€šè¿‡ HTTP æ–¹å¼è¿™æ ·æ ‡å‡†çš„åè®®è°ƒç”¨ã€‚å¦‚ï¼›æ”¯ä»˜å®æ”¯ä»˜å®Œæˆå›è°ƒã€å¾®ä¿¡å…¬ä¼—å·å‘é€æ¶ˆæ¯åçš„å›è°ƒï¼Œéƒ½æ˜¯åŸºäº HTTP çš„æ–¹å¼å®ç°ã€‚

### äºŒã€ä¸šåŠ¡æµç¨‹

å¦‚å›¾ï¼ŒHTTPã€MQï¼Œç”±è°ƒç”¨æ–¹é…ç½®ä½¿ç”¨é‚£ç§æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

![group-buy-market-2-17-01.png](./æ‹¼å›¢é¡¹ç›®.assets/FhR8MtlD4TQ7jkQMykKZgrdoHVrP.png)

- ç”¨æˆ·åˆ›å»ºè¥é”€é”å•æ—¶ï¼Œé€‰æ‹©MQã€HTTPå›è°ƒæ–¹å¼ã€‚è¿™ä¸ªç±»å‹ä¼šè¢«å†™å…¥åˆ°å¯¹åº”çš„æ‹¼å›¢è®¢å•è®°å½•é‡Œã€‚

![group-buy-market-2-17-02.png](./æ‹¼å›¢é¡¹ç›®.assets/FkMOE08FPZlDcTX4QV0Dm0QUtOr0.png)

- æ‹¼å›¢å®Œæˆç»“ç®—åï¼Œåœ¨æ ¹æ®å†™å…¥åˆ°æ‹¼å›¢è®¢å•çš„è®°å½•ï¼Œå›è°ƒçš„æ–¹å¼ï¼Œæ¥å›è°ƒé€šçŸ¥ç»“ç®—ã€‚



# è¡¥å……

åœ¨è¯¥æ‹¼å›¢ç³»ç»Ÿä¸­ï¼ŒèŠ‚ç‚¹çš„è·¯ç”±å’Œæ‰§è¡Œæ˜¯é€šè¿‡ç­–ç•¥æ¨¡å¼å’Œè´£ä»»é“¾æ¨¡å¼ç›¸ç»“åˆæ¥å®ç°çš„ã€‚ä¸‹é¢æ˜¯å…·ä½“çš„å·¥ä½œåŸç†ï¼š

## 1.èŠ‚ç‚¹è·¯ç”±æœºåˆ¶

1. **æŠ½è±¡åŸºç±»å®šä¹‰**ï¼š
   æ¯ä¸ªèŠ‚ç‚¹éƒ½ç»§æ‰¿è‡ª[AbstractGroupBuyMarketSupport](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\AbstractGroupBuyMarketSupport.java#L15-L26)ç±»ï¼Œè¿™ä¸ªç±»åˆç»§æ‰¿è‡ª[AbstractMultiThreadStrategyRouter](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L13-L43)ï¼Œå®ƒå®ç°äº†[StrategyHandler](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\StrategyHandler.java#L10-L16)æ¥å£ã€‚

2. **è·¯ç”±æ ¸å¿ƒæ–¹æ³•**ï¼š
   åœ¨[AbstractMultiThreadStrategyRouter](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L13-L43)ç±»ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒçš„[router](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L19-L23)æ–¹æ³•ï¼š
   ```java
   public R router(T requestParameter, D dynamicContext) throws Exception {
       StrategyHandler<T, D, R> strategyHandler = get(requestParameter, dynamicContext);
       if(null != strategyHandler) return strategyHandler.apply(requestParameter, dynamicContext);
       return defaultStrategyHandler.apply(requestParameter, dynamicContext);
   }
   ```


3. **èŠ‚ç‚¹å†³ç­–**ï¼š
   æ¯ä¸ªå…·ä½“çš„èŠ‚ç‚¹ç±»ï¼ˆå¦‚[RootNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\RootNode.java#L21-L58)ã€[SwitchNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\SwitchNode.java#L20-L54)ã€[MarketNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\MarketNode.java#L30-L122)ã€[TagNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\TagNode.java#L19-L55)ã€[EndNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\EndNode.java#L20-L60)ç­‰ï¼‰éƒ½å¿…é¡»å®ç°[get](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\TagNode.java#L50-L53)æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†³å®šäº†ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚

### 1.1å…·ä½“å®ç°ç¤ºä¾‹

ä»¥å‡ ä¸ªå…³é”®èŠ‚ç‚¹ä¸ºä¾‹ï¼š

1. **RootNode**ï¼š
   ```java
   @Override
   public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
       return switchNode;
   }
   ```

   æ ¹èŠ‚ç‚¹æ€»æ˜¯å°†è¯·æ±‚è·¯ç”±åˆ°[SwitchNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\SwitchNode.java#L20-L54)ã€‚

2. **SwitchNode**ï¼š
   ```java
   @Override
   public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
       return marketNode;
   }
   ```

   SwitchNodeå¤„ç†å®Œå¼€å…³é€»è¾‘åï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°[MarketNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\MarketNode.java#L30-L122)ã€‚

3. **MarketNode**ï¼š
   ```java
   @Override
   public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
       return errorNode;
   }
   ```

   MarketNodeé»˜è®¤è·¯ç”±åˆ°[ErrorNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\ErrorNode.java#L18-L40)ï¼Œä½†åœ¨å¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæ ¹æ®æ¡ä»¶æ”¹å˜è·¯ç”±ã€‚

4. **TagNode**ï¼š
   ```java
   @Override
   public StrategyHandler<MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity> get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) throws Exception {
       return endNode;
   }
   ```

   TagNodeå¤„ç†å®Œäººç¾¤æ ‡ç­¾åˆ¤æ–­åï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°[EndNode](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\EndNode.java#L20-L60)ã€‚

### 1.2æ‰§è¡Œæµç¨‹

æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. è°ƒç”¨[router](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L19-L23)æ–¹æ³•ç¡®å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹
2. æ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„[multiThread](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L36-L36)æ–¹æ³•ï¼ˆå¼‚æ­¥åŠ è½½æ•°æ®ï¼‰
3. æ‰§è¡Œå½“å‰èŠ‚ç‚¹çš„[doApply](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L41-L41)æ–¹æ³•ï¼ˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼‰
4. åœ¨[doApply](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L41-L41)æ–¹æ³•æœ«å°¾å†æ¬¡è°ƒç”¨[router](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-types\src\main\java\cn\bugstack\types\design\framework\tree\AbstractMultiThreadStrategyRouter.java#L19-L23)æ–¹æ³•ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

è¿™ç§è®¾è®¡ä½¿å¾—æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦å…³å¿ƒè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å’Œå†³å®šä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä»€ä¹ˆï¼Œå½¢æˆäº†ä¸€ä¸ªçµæ´»çš„å¤„ç†é“¾ã€‚é€šè¿‡å®ç°[get](file://D:\1ç¡•å£«\è®¡ç®—æœºã€è®¾è®¡å­¦ä¹ \æ‹¼å›¢é¡¹ç›®\group-buy-market-master\group-buy-market-domain\src\main\java\cn\bugstack\domain\activity\service\trial\node\TagNode.java#L50-L53)æ–¹æ³•ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥åŠ¨æ€å†³å®šä¸‹ä¸€æ­¥çš„æ‰§è¡Œè·¯å¾„ï¼Œå®ç°æ¡ä»¶åˆ†æ”¯å’Œæµç¨‹æ§åˆ¶ã€‚













